<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Historial interno completo</title>

<style>
:root{
  --brand:#900000;--ink:#e9ecef;--muted:#b9c0c7;
  --bg:#0b0b0c;--panel:#0f0f11;--card:#16181b;--card-border:#272a2f;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui;background:var(--bg);color:var(--ink)}
.topbar{background:#000;color:#fff;text-align:center;padding:14px;border-bottom:4px solid var(--brand);font-weight:700}
.wrapper{max-width:1300px;margin:24px auto;padding:0 12px}
.frame{border:3px solid var(--brand);border-radius:16px;padding:20px;background:var(--panel)}
.header{background:var(--brand);padding:18px;border-radius:14px;text-align:center}
.card{background:var(--card);border:1px solid var(--card-border);border-radius:14px;padding:16px;margin-top:16px}

input{
  width:100%;padding:14px;border-radius:10px;
  background:#0c0c0e;color:#fff;border:1px solid #333;
  font-size:16px;text-transform:uppercase
}
.btn{
  margin-top:12px;width:100%;min-height:48px;
  border-radius:12px;border:2px solid var(--brand);
  background:#0c0c0e;color:#fff;font-weight:800;cursor:pointer
}
.btn:hover{background:var(--brand)}
.btn-sec{
  background:#111;border:1px solid #444
}

.servicio{
  border:1px solid #333;border-radius:12px;
  padding:14px;margin-bottom:14px;background:#111
}
.servicio.destacado{
  border:2px solid var(--brand);
  background:#1a0000
}

.fila{font-size:14px;margin-top:4px}
.badge{
  background:var(--brand);color:#fff;font-size:12px;
  padding:2px 8px;border-radius:20px;margin-top:6px;display:inline-block
}
.link{color:#9fd0ff;cursor:pointer;font-weight:700;text-decoration:underline;margin-top:10px}
.detalle{
  margin-top:14px;
  padding:14px;
  border-radius:12px;
  background:#0c0c0e;
  border:1px dashed #444;
}
.detalle h4{
  margin:12px 0 6px;
  color:#fff;
  border-bottom:1px solid #333;
  padding-bottom:4px;
}
.ok{color:#7CFF7C}
.no{color:#FF7C7C}
.muted{color:var(--muted)}
a{color:#7db7ff;text-decoration:none}
.foto-link{display:inline-block;margin:5px 10px 5px 0;padding:8px 12px;background:#1a1a2e;border-radius:6px;}
.foto-link:hover{background:#2a2a3e;transform:scale(1.02);}
.loader{text-align:center;padding:20px;color:var(--muted)}
.loader.hidden{display:none}
</style>
</head>

<body>

<div class="topbar">WWW.ELSEÃ‘ORDELOSESCANER.CL</div>

<div class="wrapper">
<div class="frame">

<div class="header">
  <h1>ðŸ§  HISTORIAL INTERNO COMPLETO</h1>
</div>

<div class="card">
  <input id="patente" placeholder="ABCD12">
  <button class="btn" onclick="buscar()">Buscar</button>
  <button class="btn btn-sec" onclick="volver()">â¬… Volver al menÃº</button>
</div>

<div id="loader" class="loader hidden">Buscando servicios...</div>

<div id="resultados" class="card" style="display:none"></div>

</div>
</div>

<script>
// URL de la API
const API_URL="https://script.google.com/macros/s/AKfycbwixg2mzNGSSwebf3I-YknTYVBj3iBaQx0O6F7vU2jtjKI2oDsWSa7rCOMzt3V0y-oYaA/exec";

// Al cargar la pÃ¡gina, restaurar la patente si existe
document.addEventListener('DOMContentLoaded', function() {
  const patenteGuardada = localStorage.getItem('ultima_patente_buscada');
  if (patenteGuardada) {
    document.getElementById('patente').value = patenteGuardada;
    
    // Si hay patente guardada y tambiÃ©n resultados guardados, cargarlos
    const resultadosGuardados = localStorage.getItem('resultados_busqueda');
    if (resultadosGuardados) {
      document.getElementById('resultados').innerHTML = resultadosGuardados;
      document.getElementById('resultados').style.display = 'block';
    }
  }
  
  // Prevenir que los enlaces recarguen la pÃ¡gina
  document.addEventListener('click', function(e) {
    if (e.target.tagName === 'A' && e.target.href) {
      // Si es un enlace a foto, abrir en nueva pestaÃ±a en mÃ³vil para evitar recarga
      if (window.innerWidth <= 768 && e.target.href.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
        e.preventDefault();
        window.open(e.target.href, '_blank');
        return false;
      }
    }
  });
});

async function apiGet(p){
  try {
    const r = await fetch(API_URL + "?" + new URLSearchParams(p));
    return r.json();
  } catch (error) {
    console.error('Error en API:', error);
    return {error: 'Error de conexiÃ³n'};
  }
}

function fecha(v){
  if(!v) return "â€”";
  const d=new Date(v);
  if(isNaN(d)) return "â€”";
  return d.toLocaleDateString("es-CL");
}

function proximoKm(km,prox){
  km=Number(km); prox=Number(prox);
  if(isNaN(km)||isNaN(prox)) return "â€”";
  return prox<=km ? km+prox : prox;
}

function estado(v){
  return v==="SI"||v===true ? `<span class="ok">âœ”</span>` : `<span class="no">âœ–</span>`;
}

async function buscar(){
  const input=document.getElementById("patente");
  const patente=input.value.trim().toUpperCase();
  input.value=patente;
  if(!patente){alert("Ingresa una patente");return;}

  // Guardar patente en localStorage
  localStorage.setItem('ultima_patente_buscada', patente);
  
  // Mostrar loader
  const loader = document.getElementById('loader');
  const box = document.getElementById('resultados');
  loader.classList.remove('hidden');
  box.style.display='none';

  try {
    const r=await apiGet({action:"buscar_por_patente",patente});
    
    // Ocultar loader
    loader.classList.add('hidden');
    box.style.display="block";

    if(!r||!r.length){
      box.innerHTML="<div class='muted'>Sin servicios</div>";
      localStorage.removeItem('resultados_busqueda');
      return;
    }

    const html = r.map((s,i)=>`
      <div class="servicio ${i===0?"destacado":""}">
        <div class="fila"><b>ID:</b> ${s.id_servicio}</div>
        <div class="fila"><b>Fecha cierre:</b> ${fecha(s.fecha)}</div>
        <div class="fila"><b>Kilometraje:</b> ${s.km} km</div>
        <div class="fila"><b>PrÃ³ximo servicio:</b> ${proximoKm(s.km,s.proximo_servicio_km)} km</div>
        ${i===0?`<div class="badge">Ãšltimo servicio</div>`:""}
        <div class="link" onclick="verDetalle(this,'${s.id_servicio}')">Ver detalle completo</div>
        <div class="detalle" style="display:none"></div>
      </div>
    `).join("");
    
    box.innerHTML = html;
    
    // Guardar resultados en localStorage para persistencia
    localStorage.setItem('resultados_busqueda', html);
    
  } catch (error) {
    loader.classList.add('hidden');
    box.innerHTML="<div class='muted'>Error al buscar servicios</div>";
  }
}

async function verDetalle(el,id){
  const box=el.nextElementSibling;
  const servicioDiv = el.parentElement;
  
  // Si ya estÃ¡ abierto, cerrarlo
  if(box.style.display==="block"){
    box.style.display="none";
    return;
  }
  
  // Cerrar otros detalles abiertos
  document.querySelectorAll('.detalle').forEach(d => {
    if (d !== box) d.style.display = 'none';
  });
  
  // Mostrar este
  box.style.display="block";
  box.innerHTML = "<div class='muted'>Cargando detalles...</div>";
  
  // Si ya tenemos los detalles guardados localmente, usarlos
  const detallesGuardados = localStorage.getItem(`detalle_${id}`);
  if (detallesGuardados) {
    box.innerHTML = detallesGuardados;
    return;
  }

  try {
    const s=await apiGet({action:"obtener_servicio",id_servicio:id});
    if(!s||s.error){
      box.innerHTML="<div class='muted'>Error al cargar detalles</div>";
      return;
    }

    const html = `
      <h4>Datos generales</h4>
      <div class="fila"><b>Patente:</b> ${s.patente}</div>
      <div class="fila"><b>TÃ©cnico:</b> ${s.tecnico}</div>
      <div class="fila"><b>TelÃ©fono:</b> ${s.telefono}</div>
      <div class="fila"><b>Estado:</b> ${s.estado}</div>

      <h4>Paso 1 Â· InspecciÃ³n inicial</h4>
      <div>Testigo aceite: ${estado(s.p1_testigo_aceite)}</div>
      <div>Fugas previas: ${estado(s.p1_fugas_previas)}</div>
      <div>Nivel bajo: ${estado(s.p1_nivel_bajo)}</div>
      <div>Obs: ${s.p1_observaciones||"â€”"}</div>

      <h4>Paso 2 Â· Evidencia</h4>
      ${s.p2_foto_aceite_url?`<div><a href="${s.p2_foto_aceite_url}" target="_blank" class="foto-link">ðŸ“¸ Aceite antes</a></div>`:""}
      ${s.p2_foto_filtro_url?`<div><a href="${s.p2_foto_filtro_url}" target="_blank" class="foto-link">ðŸ“¸ Filtro antes</a></div>`:""}

      <h4>Paso 3 Â· Drenado</h4>
      <div>Motor temp OK: ${estado(s.p3_motor_temperatura_ok)}</div>
      <div>TapÃ³n retirado: ${estado(s.p3_tapon_retirado)}</div>
      <div>Drenado completo: ${estado(s.p3_drenado_completo)}</div>
      <div>Estado tapÃ³n: ${s.p3_estado_tapon||"â€”"}</div>
      <div>Obs: ${s.p3_observaciones||"â€”"}</div>

      <h4>Paso 4 Â· Filtro</h4>
      <div>Filtro viejo retirado: ${estado(s.p4_filtro_viejo_retirado)}</div>
      <div>Sello viejo retirado: ${estado(s.p4_sello_viejo_retirado)}</div>
      <div>Filtro nuevo instalado: ${estado(s.p4_filtro_nuevo_instalado)}</div>
      ${s.p4_foto_filtro_url?`<div><a href="${s.p4_foto_filtro_url}" target="_blank" class="foto-link">ðŸ“¸ Foto filtro nuevo</a></div>`:""}

      <h4>Paso 5 Â· Aceite</h4>
      <div>${s.aceite_tipo} ${s.aceite_norma} (${s.aceite_cantidad_litros} L)</div>

      <h4>Paso 6 Â· VerificaciÃ³n final</h4>
      <div>Motor OK: ${estado(s.p6_motor_ok)}</div>
      <div>Testigo OK: ${estado(s.p6_testigo_aceite_ok)}</div>
      <div>Sin fugas: ${estado(s.p6_sin_fugas)}</div>
      <div>Nivel final OK: ${estado(s.p6_nivel_final_ok)}</div>
      ${s.p6_foto_final_url?`<div><a href="${s.p6_foto_final_url}" target="_blank" class="foto-link">ðŸ“¸ Foto final</a></div>`:""}

      <h4>Observaciones finales</h4>
      <div>${s.observaciones_finales||"â€”"}</div>
    `;
    
    box.innerHTML = html;
    
    // Guardar detalles en localStorage
    localStorage.setItem(`detalle_${id}`, html);
    
  } catch (error) {
    box.innerHTML="<div class='muted'>Error al cargar detalles</div>";
  }
}

function volver(){
  // Limpiar localStorage si se desea
  // localStorage.removeItem('ultima_patente_buscada');
  // localStorage.removeItem('resultados_busqueda');
  window.location.href="checklist.html";
}

// Prevenir recarga accidental en mÃ³viles
window.addEventListener('beforeunload', function(e) {
  // No hacer nada, permitir que la pÃ¡gina se recargue normalmente
});

// Si el usuario hace swipe para refrescar, mantener los datos
window.addEventListener('pageshow', function(event) {
  if (event.persisted) {
    // La pÃ¡gina viene de cache, restaurar datos
    const patenteGuardada = localStorage.getItem('ultima_patente_buscada');
    if (patenteGuardada) {
      document.getElementById('patente').value = patenteGuardada;
    }
  }
});
</script>

</body>
</html>
