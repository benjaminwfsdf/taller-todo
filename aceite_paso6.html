<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Paso 6 ¬∑ Verificaci√≥n final</title>

<style>
:root{
  --brand:#900000;--ink:#e9ecef;
  --bg:#0b0b0c;--panel:#0f0f11;
  --card:#16181b;--card-border:#272a2f;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui;background:var(--bg);color:var(--ink)}
.topbar{background:#000;color:#fff;text-align:center;padding:14px;border-bottom:4px solid var(--brand);font-weight:700}
.wrapper{max-width:900px;margin:24px auto;padding:0 12px}
.frame{border:3px solid var(--brand);border-radius:16px;padding:20px;background:var(--panel)}
.header{background:var(--brand);padding:18px;border-radius:14px;text-align:center}
.card{background:var(--card);border:1px solid var(--card-border);border-radius:14px;padding:16px;margin-top:20px}
.check{display:flex;align-items:center;gap:12px;background:#0c0c0e;padding:12px;border-radius:10px;margin-bottom:12px}
.check input{transform:scale(1.3)}
.photo{background:#0c0c0e;padding:14px;border-radius:12px;border:1px dashed #444;margin-top:14px}
.error{display:none;margin-top:12px;color:#ffb3b3;font-weight:700}
.btn{margin-top:20px;width:100%;min-height:48px;border-radius:12px;border:2px solid var(--brand);background:#0c0c0e;color:#fff;font-weight:800;cursor:pointer}
.btn:hover{background:var(--brand)}
.btn:disabled{opacity:.6}
</style>
</head>

<body>

<div class="topbar">WWW.ELSE√ëORDELOSESCANER.CL</div>

<div class="wrapper">
<div class="frame">

<div class="header">
  <h1>üîç Paso 6 ¬∑ Verificaci√≥n final</h1>
</div>

<div class="card">

<div class="check"><input type="checkbox" id="motor"><label>Motor encendido correctamente</label></div>
<div class="check"><input type="checkbox" id="luz"><label>Testigo de aceite apagado</label></div>
<div class="check"><input type="checkbox" id="fugas"><label>Sin fugas en tap√≥n ni filtro</label></div>
<div class="check"><input type="checkbox" id="nivel"><label>Nivel final de aceite correcto</label></div>

<div class="photo">
  <strong>üì∏ Foto nivel final / motor (opcional)</strong><br>
  <input type="file" id="fotoFinal" accept="image/*">
</div>

<div id="error" class="error">‚ùå Debes confirmar todas las verificaciones</div>

<button class="btn" onclick="guardar()">Finalizar servicio</button>

</div>
</div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxP5-MkY-L3B1Wm5hB9fQCmRfeJTEi84p-FlAWcVuNZSi109cH8bf349-R4wed7EX5b0w/exec";
const id = sessionStorage.getItem("aceite_id");

if(!id){
  alert("Sesi√≥n perdida");
  location.href="aceite_nuevo.html";
}

function toBase64(file){
  return new Promise(resolve=>{
    const r = new FileReader();
    r.onload = ()=>resolve(r.result.split(",")[1]);
    r.readAsDataURL(file);
  });
}

function post(payload){
  return fetch(API_URL,{
    method:"POST",
    body: JSON.stringify(payload)
  });
}

async function guardar(){

  if(!(motor.checked && luz.checked && fugas.checked && nivel.checked)){
    error.style.display="block";
    return;
  }

  const btn = document.querySelector(".btn");
  btn.disabled = true;
  btn.innerText = "Finalizando‚Ä¶";

  // 1Ô∏è‚É£ Guardar checklist
  await post({
    action: "actualizar_servicio",
    id_servicio: id,
    p6_motor_ok: "SI",
    p6_testigo_aceite_ok: "SI",
    p6_sin_fugas: "SI",
    p6_nivel_final_ok: "SI"
  });

  // 2Ô∏è‚É£ Guardar foto final (si existe)
  if(fotoFinal.files.length){
    const base64 = await toBase64(fotoFinal.files[0]);
    await post({
      action: "subir_foto_paso6",
      id_servicio: id,
      foto_final: base64
    });
  }

  // 3Ô∏è‚É£ Cierre
  location.href="aceite_cierre.html";
}
</script>

</body>
</html>
