<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Registro de Servicio</title>

<style>
:root{
  --brand:#900000;--ink:#e9ecef;--muted:#b9c0c7;
  --bg:#0b0b0c;--panel:#0f0f11;--card:#16181b;--card-border:#272a2f;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui;background:var(--bg);color:var(--ink)}
.topbar{background:#000;color:#fff;text-align:center;padding:14px;border-bottom:4px solid var(--brand);font-weight:700}
.wrapper{max-width:900px;margin:24px auto;padding:0 12px}
.frame{border:3px solid var(--brand);border-radius:16px;padding:20px;background:var(--panel)}
.header{background:var(--brand);padding:18px;border-radius:14px;text-align:center}
.card{background:var(--card);border:1px solid var(--card-border);border-radius:14px;padding:16px;margin-top:16px}
.row{display:flex;justify-content:space-between;gap:10px;border-bottom:1px solid #333;padding:8px 0}
.row:last-child{border-bottom:none}
.label{color:var(--muted)}
.value{font-weight:700;text-align:right}

.destacado{
  background:#1a0000;
  border:1px solid var(--brand);
  border-radius:8px;
  padding:10px;
  margin-top:10px;
}

.section{margin-top:24px}
.section h3{margin-bottom:12px}

.foto-link{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px 12px;
  background:#0c0c0e;
  border:1px dashed #444;
  border-radius:10px;
  margin-bottom:10px;
}

.foto-link a{
  color:#7db7ff;
  font-weight:700;
  text-decoration:none;
}
.foto-link a:hover{text-decoration:underline}

.note{margin-top:14px;background:#0c0c0e;padding:12px;border-radius:10px;border:1px dashed #444}
.footer{text-align:center;color:var(--muted);font-size:12px;margin-top:18px}

/* Estilos para modo debug */
.debug-info{
  background:#1a1a2e;
  border:1px solid #444;
  border-radius:8px;
  padding:10px;
  margin:10px 0;
  font-size:12px;
  color:#8a8aff;
  display:none;
}
.debug-toggle{
  background:#333;
  color:#ccc;
  border:none;
  padding:5px 10px;
  border-radius:4px;
  cursor:pointer;
  font-size:11px;
  margin:5px 0;
}
.debug-toggle:hover{background:#444}
</style>
</head>

<body>

<div class="topbar">WWW.ELSE√ëORDELOSESCANER.CL</div>

<div class="wrapper">
<div class="frame">

<div class="header">
  <h1>üõ¢Ô∏è Registro de Cambio de Aceite</h1>
</div>

<button class="debug-toggle" onclick="toggleDebug()">üîç Mostrar info debug</button>
<div id="debugInfo" class="debug-info"></div>

<div id="contenido" class="card">Cargando registro‚Ä¶</div>

<div class="footer">
Este registro respalda el servicio realizado.
</div>

</div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxAgXWy1VKHJU5rMFJViA_bWthtZ45ukt-_06iHv0LQ1D1YoQ1WRilTzMCYqKOZkEXZSw/exec";
const urlParams = new URLSearchParams(location.search);
const id = urlParams.get("id");

/* =========================
   UTILIDADES
========================= */
function formatearFecha(v){
  if(!v) return "‚Äî";
  
  // Intentar parsear la fecha
  try {
    const date = new Date(v);
    // Si la fecha es inv√°lida, devolver el valor original
    if(isNaN(date.getTime())) return v;
    return date.toLocaleDateString("es-CL");
  } catch(e) {
    return v;
  }
}

function formatearCantidadAceite(valor){
  if(!valor && valor !== 0) return "‚Äî";
  
  const str = String(valor).trim();
  
  // Si es una fecha ISO (contiene T y Z)
  if(str.includes('T') && str.includes('Z')){
    try {
      const date = new Date(str);
      if(!isNaN(date.getTime())){
        console.warn("‚ö†Ô∏è El campo aceite_cantidad_litros contiene una fecha:", str);
        return "‚Äî (error en datos)";
      }
    } catch(e){
      // No es una fecha v√°lida
    }
  }
  
  // Remover cualquier car√°cter no num√©rico excepto punto y coma
  const numeros = str.replace(/[^\d.,]/g, '');
  
  if(!numeros) return "‚Äî";
  
  // Reemplazar coma por punto para decimales
  const cantidad = parseFloat(numeros.replace(',', '.'));
  
  if(isNaN(cantidad)) return "‚Äî";
  
  return cantidad + " L";
}

function calcularProximoServicio(kmActual, proximo){
  if(!kmActual && kmActual !== 0) return "‚Äî";
  if(!proximo && proximo !== 0) return "‚Äî";

  kmActual = Number(kmActual);
  proximo  = Number(proximo);

  if(isNaN(kmActual) || isNaN(proximo)) return "‚Äî";

  // Si el valor es menor o igual al km actual, se interpreta como intervalo
  if(proximo <= kmActual){
    return (kmActual + proximo) + " km";
  }

  // Si es mayor, es km absoluto
  return proximo + " km";
}

async function apiGet(p){
  try {
    const r = await fetch(API_URL + "?" + new URLSearchParams(p));
    return r.json();
  } catch(error) {
    console.error("Error en API:", error);
    return { error: "Error de conexi√≥n" };
  }
}

function mostrarDebug(info){
  const debugDiv = document.getElementById('debugInfo');
  debugDiv.innerHTML = `<pre>${JSON.stringify(info, null, 2)}</pre>`;
}

function toggleDebug(){
  const debugDiv = document.getElementById('debugInfo');
  debugDiv.style.display = debugDiv.style.display === 'block' ? 'none' : 'block';
}

function linkFoto(texto, url){
  if(!url || url === "Sin foto") return "";
  return `
    <div class="foto-link">
      <span>${texto}</span>
      <a href="${url}" target="_blank">üì∑ Ver foto</a>
    </div>
  `;
}

/* =========================
   CARGA PRINCIPAL
========================= */
async function cargar(){
  if(!id){
    contenido.innerText="‚ùå Error: No se proporcion√≥ ID de registro.";
    return;
  }

  console.log("üîÑ Cargando registro ID:", id);
  
  // Mostrar info de debug inicial
  mostrarDebug({
    urlParams: Object.fromEntries(urlParams),
    id_buscado: id,
    url_completa: window.location.href
  });

  const r = await apiGet({ action:"obtener_servicio", id_servicio:id });
  
  // Actualizar info debug con respuesta
  mostrarDebug({
    ...JSON.parse(document.getElementById('debugInfo').textContent || '{}'),
    respuesta_api: r
  });
  
  console.log("üìä Respuesta API completa:", r);
  
  if(!r || r.error){
    contenido.innerText=`‚ùå Error: ${r?.error || "Registro no encontrado"}`;
    return;
  }

  // Debug espec√≠fico del campo cantidad
  console.log("üîç Campo 'aceite_cantidad_litros':", r.aceite_cantidad_litros);
  console.log("üìù Tipo de dato:", typeof r.aceite_cantidad_litros);
  console.log("üî¢ Valor formateado:", formatearCantidadAceite(r.aceite_cantidad_litros));

  // Generar HTML del registro
  contenido.innerHTML = `
    <div class="row"><span class="label">ID Servicio</span><span class="value">${r.id_servicio || "‚Äî"}</span></div>
    <div class="row"><span class="label">Patente</span><span class="value">${r.patente || "‚Äî"}</span></div>
    <div class="row"><span class="label">Fecha del servicio</span><span class="value">${formatearFecha(r.fecha_cierre)}</span></div>
    <div class="row"><span class="label">Kilometraje</span><span class="value">${r.km_inicial || "‚Äî"} km</span></div>
    <div class="row"><span class="label">T√©cnico</span><span class="value">${r.tecnico || "‚Äî"}</span></div>
    <div class="row"><span class="label">Tel√©fono</span><span class="value">${r.telefono || "‚Äî"}</span></div>
    <div class="row"><span class="label">Aceite</span><span class="value">${(r.aceite_tipo||"")} ${(r.aceite_norma||"")}</span></div>
    <div class="row"><span class="label">Cantidad de aceite</span><span class="value">${formatearCantidadAceite(r.aceite_cantidad_litros)}</span></div>

    <div class="destacado">
      <div class="row">
        <span class="label">üîî Pr√≥ximo servicio recomendado</span>
        <span class="value">
          ${calcularProximoServicio(r.km_inicial, r.proximo_servicio_km)}
        </span>
      </div>
    </div>

    <div class="section">
      <h3>üì∏ Evidencia del Servicio</h3>
      ${linkFoto("Paso 2 ¬∑ Estado del aceite antes del servicio", r.p2_foto_aceite_url)}
      ${linkFoto("Paso 2 ¬∑ Estado del filtro antes del cambio", r.p2_foto_filtro_url)}
      ${linkFoto("Paso 4 ¬∑ Filtro nuevo instalado", r.p4_foto_filtro_url)}
      ${linkFoto("Paso 6 ¬∑ Verificaci√≥n final / nivel de aceite", r.p6_foto_final_url)}
    </div>

    ${r.observaciones_finales ? `
      <div class="note">
        <strong>Observaciones finales:</strong><br>
        ${r.observaciones_finales}
      </div>
    ` : ''}
  `;
}

// Iniciar carga cuando el DOM est√© listo
if(document.readyState === 'loading'){
  document.addEventListener('DOMContentLoaded', cargar);
} else {
  cargar();
}
</script>

</body>
</html>
