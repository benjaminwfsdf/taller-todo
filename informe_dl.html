<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Informe de Diagn√≥stico</title>
  <style>
    @media print { @page { size: A4; margin: 10mm 12mm; } }
    body { font-family: Arial, sans-serif; margin: 20px; color:#000; background:#fff; }
    .titulo{ background:#b30000; color:#fff; padding:10px; font-weight:bold; text-align:center; margin-bottom:12px; }
    .contacto-wrap{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;gap:12px}
    .contacto{ text-align:center; font-size:14px; line-height:1.4; flex:1; font-weight:bold; }
    .contacto-wrap img{ max-height:120px; object-fit:contain }
    table{ width:100%; border-collapse: collapse; margin-bottom: 10px; }
    td,th{ border:1px solid #000; padding:6px; vertical-align:top; }
    .seccion{ margin-top:10px; font-weight:bold; background:#f0f0f0; padding:6px; border:1px solid #000; }
    .topbar { position:sticky; top:0; background:#fff; padding-bottom:10px; display:flex; gap:8px; align-items:center; margin-bottom:10px; }
    .topbar button{ padding:10px 12px; border:1px solid #000; background:#fff; cursor:pointer; border-radius:8px; box-shadow:0 2px 0 #000; }
    .msg { font-size:13px; opacity:.8 }
    pre { white-space:pre-wrap; margin:0 }
    @media (max-width:640px){
      body{ margin: 8px; }
      .contacto-wrap img{ max-height:90px; }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <button onclick="descargarPdf()">üìÑ Descargar PDF</button>
    <span class="msg" id="status">Listo para descargar.</span>
  </div>

  <div id="informe">
    <div class="titulo">INFORME DE DIAGN√ìSTICO</div>

    <div class="contacto-wrap">
      <img src="img/logo-scanners.png" alt="logo scanners" loading="eager" crossorigin="anonymous">
      <div class="contacto">
        WWW.ELSE√ëORDELOSESCANER.CL<br>
        DORSAL (ALTURA 6200) METRO NEPTUNO<br>
        CELULAR: +56976209564<br>
        (WALDO)<br><br>
        SCANNER ORIGINAL TODAS LAS MARCAS<br>
        LIMPIEZA INYECTORES ‚Äì SISTEMAS DPF - GASES LLAVES CON CHIP ‚Äì PROGRAMACION
      </div>
      <img src="img/qr-whatsapp.png" alt="QR whatsapp" loading="eager" crossorigin="anonymous">
    </div>

    <table>
      <tr>
        <td><b>MARCA:</b> <span id="marca"></span></td>
        <td><b>MODELO:</b> <span id="modelo"></span></td>
      </tr>
      <tr>
        <td><b>PATENTE:</b> <span id="patente"></span></td>
        <td><b>A√ëO:</b> <span id="ano"></span></td>
      </tr>
      <tr>
        <td><b>KM:</b> <span id="km"></span></td>
        <td><b>MOTOR:</b> <span id="motor"></span></td>
      </tr>
    </table>

    <div class="seccion">C√ìDIGOS / DETALLE / VALOR</div>
    <table>
      <tr>
        <th style="width:15%">C√ìDIGOS</th>
        <th style="width:70%">DETALLE</th>
        <th style="width:15%">VALOR</th>
      </tr>
      <tr>
        <td><pre id="codigo"></pre></td>
        <td><pre id="detalle"></pre></td>
        <td><pre id="valor_area"></pre></td>
      </tr>
    </table>

    <div class="seccion">POSIBLES CAUSAS</div>
    <div id="causas" style="white-space:pre-wrap"></div>

    <div class="seccion">RECOMENDACIONES</div>
    <div id="recomendaciones" style="white-space:pre-wrap"></div>

    <div style="margin-top:10px; display:flex; justify-content:space-between;">
      <div><b>FECHA:</b> <span id="fecha"></span></div>
      <div><b>TOTAL:</b> $ <span id="valor_final"></span></div>
    </div>

    <div class="msg" style="margin-top:8px;">Toca ‚ÄúDescargar PDF‚Äù para guardar el informe.</div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" referrerpolicy="no-referrer"></script>

  <script>
    // --- Utilidades datos (desde el hash comprimido) ---
    function parseDatos(){
      const hash = location.hash.replace(/^#/, '');
      if (!hash) return null;
      try { return JSON.parse(LZString.decompressFromEncodedURIComponent(hash)); }
      catch(e){ console.error(e); return null; }
    }
    function set(id, val){ const el = document.getElementById(id); if (el) el.textContent = val || ''; }
    function render(d){
      set('marca', d.marca); set('modelo', d.modelo); set('patente', d.patente);
      set('ano', d.ano); set('km', d.km); set('motor', d.motor);
      set('codigo', d.codigo); set('detalle', d.detalle); set('valor_area', d.valor_area);
      set('causas', d.causas); set('recomendaciones', d.recomendaciones);
      set('fecha', d.fecha); set('valor_final', d.valor_final);
    }

    // --- Asegurar im√°genes en PDF (inline data:) ---
    function waitImagesLoaded(container){
      const imgs = Array.from(container.querySelectorAll('img'));
      if (!imgs.length) return Promise.resolve();
      return Promise.all(imgs.map(img => img.complete ? Promise.resolve() :
        new Promise(res => { img.onload = res; img.onerror = res; })));
    }
    async function toDataURLFromUrl(url){
      const res = await fetch(url, {mode:'cors'}).catch(()=>null) || await fetch(url).catch(()=>null);
      if(!res || !res.ok) throw new Error('fetch img fail: '+url);
      const blob = await res.blob();
      return await new Promise((resolve)=>{
        const r = new FileReader();
        r.onload = () => resolve(r.result);
        r.readAsDataURL(blob);
      });
    }
    async function inlineAllImages(container){
      const imgs = Array.from(container.querySelectorAll('img')).filter(i => i && i.src && !i.src.startsWith('data:'));
      for (const img of imgs){
        try{
          const data = await toDataURLFromUrl(img.src);
          await new Promise((resolve)=>{ img.onload = resolve; img.onerror = resolve; img.src = data; });
        }catch(e){ /* contin√∫a */ }
      }
      await waitImagesLoaded(container);
    }

    async function descargarPdf(){
      const cont = document.getElementById('informe');
      await inlineAllImages(cont);
      const patente = (document.getElementById('patente').textContent || 'SIN_PATENTE').replace(/\s+/g,'');
      const nombre = `Informe_${patente}_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.pdf`;
      const opt = {
        filename: nombre,
        margin: [10, 10],
        image: { type: 'jpeg', quality: 0.95 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      };
      try{
        await html2pdf().set(opt).from(cont).save();
        document.getElementById('status').textContent = 'PDF descargado.';
      }catch(e){
        document.getElementById('status').textContent = 'No se pudo descargar autom√°ticamente.';
      }
    }
    window.descargarPdf = descargarPdf;

    // Renderizar datos (SIN auto-descargar)
    const datos = parseDatos();
    if (!datos) {
      document.body.insertAdjacentHTML('beforeend','<p style="padding:20px">No se encontraron datos en el link.</p>');
    } else {
      render(datos);
    }
  </script>
</body>
</html>
