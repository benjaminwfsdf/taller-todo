<!DOCTYPE html>
<html lang="es">
<head>
  <link rel="manifest" href="manifest.json">

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Taller">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <meta name="theme-color" content="#000000">
  <link rel="icon" type="image/png" href="icons/icon-192.png">

  <title>Buscar Informes por Patente</title>
  <style>
    :root{
      --brand:#900000;
      --brand-900:#700000;
      --ink:#e9ecef;
      --muted:#b9c0c7;
      --bg:#0b0b0c;
      --panel:#0f0f11;
      --card:#16181b;
      --card-border:#272a2f;
      --shadow:0 10px 28px rgba(0,0,0,.45);
      --shadow-hover:0 14px 40px rgba(0,0,0,.6);
      --radius:16px;
    }

    * {
      box-sizing: border-box;
    }

    html,body{
      height:100%;
      margin:0;
      padding:0;
    }
    
    body{
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial,sans-serif;
      background: var(--bg);
      color: var(--ink);
      line-height: 1.55;
    }

    .topbar{
      background:#000;
      color:#fff;
      text-align:center;
      padding:14px 10px;
      font-weight:700;
      letter-spacing:.6px;
      border-bottom:4px solid var(--brand);
      box-shadow: 0 6px 16px rgba(0,0,0,.55);
    }

    .wrapper{
      max-width:1100px;
      margin:28px auto 44px;
      padding:0 16px;
      width: 100%;
    }
    
    .frame{
      border:3px solid var(--brand);
      border-radius:var(--radius);
      padding:20px;
      background:var(--panel);
      box-shadow:var(--shadow);
      width: 100%;
    }
    
    .search-card{
      position:relative;
      background:var(--card);
      border:1px solid var(--card-border);
      border-radius:14px;
      box-shadow:0 6px 18px rgba(0,0,0,.35);
      padding:20px;
      margin-bottom:22px;
      width: 100%;
      overflow: hidden; /* Esto evita que los elementos sobresalgan */
    }
    
    .search-card::before{
      content:"";
      position:absolute;
      inset:0 auto 0 0;
      width:8px;
      border-radius:14px 0 0 14px;
      background:var(--brand);
    }
    
    label{
      display:block;
      margin:8px 0 6px;
      font-weight:700;
      color:var(--ink);
      font-size:16px;
      width: 100%;
    }
    
    input{
      width:100%;
      padding:14px 16px;
      border:2px solid var(--card-border);
      border-radius:12px;
      background:rgba(0,0,0,0.3);
      color:var(--ink);
      font-size:16px;
      text-transform:uppercase;
      margin-bottom:16px;
      box-sizing: border-box; /* ¬°ESTO ES IMPORTANTE! */
      display: block;
    }
    
    .btn{
      border:2px solid var(--brand);
      border-radius:12px;
      padding:12px 24px;
      font-weight:800;
      cursor:pointer;
      text-decoration:none;
      color:#fff;
      background:#0c0c0e;
      box-shadow:0 2px 0 rgba(0,0,0,.6),inset 0 0 12px rgba(179,0,0,.25);
      display:block;
      width:100%;
      text-align:center;
      font-size:16px;
      margin-top:10px;
      box-sizing: border-box;
    }
    
    .btn:hover{
      background:var(--brand);
    }
    
    .btn-back{
      border:2px solid var(--muted);
      border-radius:12px;
      padding:10px 16px;
      font-weight:800;
      cursor:pointer;
      text-decoration:none;
      color:var(--muted);
      background:#0c0c0e;
      box-shadow:0 2px 0 rgba(0,0,0,.6),inset 0 0 12px rgba(185,192,199,.25);
      display:inline-block;
      margin-bottom:20px;
      margin-top:10px;
      box-sizing: border-box;
    }
    
    .btn-back:hover{
      background:var(--muted);
      color:#000;
    }
    
    /* Estilos para resultados */
    .result-block{
      margin-top:20px;
      background:var(--card);
      border:2px solid var(--card-border);
      border-radius:12px;
      padding:20px;
      color:var(--ink);
      margin-bottom:16px;
      position:relative;
      width: 100%;
      overflow: hidden; /* Evita que los elementos hijos sobresalgan */
    }
    
    .ultimo{
      border:3px solid #00ff8c !important;
      box-shadow:0 0 14px rgba(0,255,140,0.3) !important;
    }
    
    .result-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:16px;
      padding-bottom:12px;
      border-bottom:1px solid var(--card-border);
      width: 100%;
    }
    
    .result-title{
      font-size:18px;
      font-weight:800;
      color:#fff;
      margin:0;
    }
    
    .result-date{
      color:var(--muted);
      font-size:14px;
      background:rgba(0,0,0,0.3);
      padding:4px 10px;
      border-radius:8px;
      white-space: nowrap;
    }
    
    .badge{
      background:var(--brand);
      color:#fff;
      padding:4px 10px;
      border-radius:8px;
      font-size:12px;
      font-weight:700;
      margin-left:10px;
    }
    
    .ot-badge{
      background:#ff9900;
      color:#000;
      padding:4px 10px;
      border-radius:8px;
      font-size:13px;
      font-weight:700;
      margin-left:10px;
      font-family: monospace;
      letter-spacing: 1px;
    }
    
    .data-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(200px, 1fr));
      gap:12px;
      margin-bottom:16px;
      width: 100%;
    }
    
    .data-item{
      margin-bottom:8px;
      width: 100%;
    }
    
    .data-label{
      display:block;
      color:var(--muted);
      font-size:13px;
      font-weight:600;
      margin-bottom:4px;
      width: 100%;
    }
    
    .data-value{
      color:var(--ink);
      font-size:15px;
      font-weight:500;
      word-break:break-word;
      width: 100%;
    }
    
    .text-content{
      background:rgba(0,0,0,0.2);
      border-radius:8px;
      padding:12px;
      margin-top:12px;
      white-space:pre-line;
      font-size:14px;
      line-height:1.5;
      width: 100%;
    }
    
    .no-results{
      text-align:center;
      padding:40px 20px;
      color:var(--muted);
      font-style:italic;
      background:rgba(0,0,0,0.2);
      border-radius:12px;
      border:2px dashed var(--card-border);
      width: 100%;
    }
    
    .loading{
      text-align:center;
      padding:30px;
      color:var(--muted);
      width: 100%;
    }
    
    .footer{
      text-align:center;
      color:var(--muted);
      font-size:13px;
      margin-top:30px;
      width: 100%;
    }
    
    /* Estilos responsivos */
    @media (max-width: 768px) {
      .wrapper{
        padding:0 12px;
        margin: 20px auto;
      }
      
      .frame{
        padding: 16px;
      }
      
      .search-card{
        padding: 16px;
      }
      
      .data-grid{
        grid-template-columns:1fr;
      }
      
      .result-header{
        flex-direction:column;
        align-items:flex-start;
        gap:8px;
      }
      
      .result-date{
        align-self: flex-start;
        margin-top: 8px;
      }
    }
    
    .section-header{
      display:flex;
      align-items:center;
      gap:15px;
      margin-bottom:20px;
      padding:20px;
      background:var(--brand);
      color:#fff;
      border-radius:18px;
      box-shadow:0 10px 22px rgba(179,0,0,.35);
      width: 100%;
    }
    
    .section-header .icon-large{
      flex:0 0 60px;
      height:60px;
      border-radius:14px;
      display:grid;
      place-items:center;
      background:#0c0c0e;
      border:3px solid #fff;
      color:#fff;
      font-size:28px;
      box-shadow:inset 0 0 16px rgba(179,0,0,.35);
    }
    
    .section-header .header-content{
      flex:1;
      min-width: 0; /* Esto evita que el contenido se desborde */
    }
    
    .section-header h2{
      margin:0 0 5px;
      font-size:24px;
      color:#fff;
      letter-spacing:.5px;
      word-wrap: break-word;
    }
    
    .section-header p{
      margin:0;
      color:rgba(255,255,255,0.8);
      font-size:14.5px;
      word-wrap: break-word;
    }
    
    /* Para pantallas muy peque√±as */
    @media (max-width: 480px) {
      .wrapper{
        padding:0 8px;
        margin: 16px auto;
      }
      
      .frame{
        padding: 12px;
      }
      
      .search-card{
        padding: 14px;
      }
      
      .section-header{
        flex-direction: column;
        text-align: center;
        gap: 12px;
        padding: 16px;
      }
      
      .section-header .icon-large{
        flex: 0 0 50px;
        height: 50px;
        font-size: 24px;
      }
      
      .section-header h2{
        font-size: 20px;
      }
      
      .section-header p{
        font-size: 13px;
      }
      
      input{
        padding: 12px 14px;
        font-size: 15px;
      }
      
      .btn{
        padding: 12px 20px;
        font-size: 15px;
      }
    }
  </style>
</head>
<body>
  <div class="topbar">WWW.ELSE√ëORDELOSESCANER.CL</div>

  <div class="wrapper">
    <div class="frame">
      <div class="section-header">
        <div class="icon-large">üîç</div>
        <div class="header-content">
          <h2>Buscar Informes por Patente</h2>
          <p>Consulta el historial completo de diagn√≥sticos del veh√≠culo</p>
        </div>
      </div>

      <a href="index.html" class="btn-back">‚Üê Volver al Panel Principal</a>

      <div class="search-card">
        <label for="patenteInput">Ingresa la patente del veh√≠culo:</label>
        <input type="text" id="patenteInput" placeholder="EJ: ABCD12" style="text-transform: uppercase;">
        
        <button class="btn" onclick="buscarInformes()">üîç Buscar Informes</button>
        
        <div id="resultados" style="margin-top: 20px;">
          <!-- Los resultados aparecer√°n aqu√≠ -->
        </div>
      </div>
      
      <div class="footer">
        ¬© 2025 <strong>Benjamin Gonz√°lez</strong>. Todos los derechos reservados.
      </div>
    </div>
  </div>

  <script>
    // URL de tu nueva Google Apps Script
    const API_URL = "https://script.google.com/macros/s/AKfycbylWprbcHvUITXljajbJYO1pxGJ_nGtubA8NOjI-dKuoB6GRklwksrqUcS64fX-_N3a/exec";
    
    // Normalizar texto (quitar acentos, may√∫sculas)
    function normalizarTexto(texto) {
      return String(texto || "")
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .toUpperCase()
        .trim();
    }
    
    // Formatear fecha
    function formatearFecha(fechaStr) {
      if (!fechaStr) return "Sin fecha";
      
      try {
        // Intentar parsear como fecha
        const fecha = new Date(fechaStr);
        if (isNaN(fecha.getTime())) {
          return fechaStr;
        }
        
        return `${String(fecha.getDate()).padStart(2, "0")}/${String(fecha.getMonth() + 1).padStart(2, "0")}/${fecha.getFullYear()}`;
      } catch (e) {
        return fechaStr;
      }
    }
    
    // Formatear valor (agregar separadores de miles si es n√∫mero)
    function formatearValor(valor) {
      if (valor === null || valor === undefined || valor === "") {
        return "-";
      }
      
      const valorStr = String(valor);
      const num = parseFloat(valorStr.replace(/[^0-9.,-]/g, '').replace(',', '.'));
      if (!isNaN(num) && isFinite(num)) {
        return "$" + num.toLocaleString("es-CL");
      }
      
      return valorStr;
    }
    
    // Formatear OT (Orden de Trabajo) - asegura que tenga 6 d√≠gitos
    function formatearOT(ot) {
      if (!ot || ot === "" || ot === "-") {
        return "N/A";
      }
      
      const otStr = String(ot).trim();
      
      // Si ya tiene 6 d√≠gitos o m√°s, mostrar los √∫ltimos 6
      if (otStr.length >= 6) {
        return otStr.padStart(6, "0").slice(-6);
      }
      
      // Si tiene menos de 6 d√≠gitos, rellenar con ceros a la izquierda
      return otStr.padStart(6, "0");
    }
    
    // Funci√≥n principal para buscar informes
    async function buscarInformes() {
      const patente = document.getElementById('patenteInput').value.trim().toUpperCase();
      const resultadosDiv = document.getElementById('resultados');
      
      if (!patente) {
        resultadosDiv.innerHTML = '<div class="no-results">Por favor, ingresa una patente</div>';
        return;
      }
      
      resultadosDiv.innerHTML = '<div class="loading">üîç Buscando informes...</div>';
      
      try {
        // Construir la URL con par√°metros para la nueva API
        const url = `${API_URL}?action=buscarPorPatente&patente=${encodeURIComponent(patente)}`;
        console.log("Buscando en URL:", url);
        
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`Error HTTP: ${response.status}`);
        }
        
        const data = await response.json();
        console.log("Respuesta de la API:", data);
        
        let informes = [];
        if (data.success && Array.isArray(data.registros)) {
          informes = data.registros;
        } else if (Array.isArray(data)) {
          informes = data;
        } else {
          throw new Error("Formato de respuesta inesperado");
        }
        
        // Filtrar solo los informes de diagn√≥stico (Fuente: DatosInforme)
        const informesDiagnostico = informes.filter(informe => 
          informe.Fuente === "DatosInforme"
        );
        
        // Ordenar por fecha descendente (m√°s reciente primero)
        informesDiagnostico.sort((a, b) => {
          const fechaA = new Date(a.Fecha || a.fecha || 0);
          const fechaB = new Date(b.Fecha || b.fecha || 0);
          return fechaB - fechaA;
        });
        
        mostrarResultados(informesDiagnostico, patente);
        
      } catch (error) {
        console.error("Error al buscar informes:", error);
        resultadosDiv.innerHTML = `
          <div class="no-results">
            ‚ùå Error al buscar informes: ${error.message}<br>
            <button class="btn" onclick="buscarInformes()" style="margin-top: 10px;">Reintentar</button>
          </div>
        `;
      }
    }
    
    // Funci√≥n para mostrar los resultados
    function mostrarResultados(informes, patenteBuscada) {
      const resultadosDiv = document.getElementById('resultados');
      
      if (informes.length === 0) {
        resultadosDiv.innerHTML = `
          <div class="no-results">
            No se encontraron informes de diagn√≥stico para la patente: <strong>${patenteBuscada}</strong>
          </div>
        `;
        return;
      }
      
      let html = `
        <div style="color: #fff; font-size: 18px; font-weight: 700; margin-bottom: 16px; width: 100%;">
          üìä ${informes.length} informe(s) de diagn√≥stico encontrado(s) para: <span style="color: #00ff8c;">${patenteBuscada}</span>
        </div>
      `;
      
      informes.forEach((informe, index) => {
        const esMasReciente = index === 0;
        
        // Extraer datos del informe
        const fecha = informe.Fecha || informe.fecha || "";
        const ot = informe.OT || informe.ot || "";
        const patente = informe.Patente || informe.patente || patenteBuscada;
        const marca = informe.Marca || informe.marca || "No especificado";
        const modelo = informe.Modelo || informe.modelo || "No especificado";
        const ano = informe.Ano || informe.ano || "No especificado";
        const km = informe.Kilometraje || informe.km || informe.KM || "No especificado";
        const codigos = informe.Codigo || informe.codigo || "Sin c√≥digos";
        const detalle = informe.Detalle || informe.detalle || "Sin detalle";
        const valorArea = informe.Valor_Area || informe.valor_area || "Sin valor";
        const causas = informe.Posibles_Causas || informe.causas || "Sin causas especificadas";
        const recomendaciones = informe.Recomendaciones || informe.recomendaciones || "Sin recomendaciones";
        const valorFinal = informe.Valor_Final || informe.valor_final || "";
        
        // Formatear OT
        const otFormateada = formatearOT(ot);
        
        html += `
          <div class="result-block ${esMasReciente ? 'ultimo' : ''}">
            <div class="result-header">
              <div style="flex: 1; min-width: 0; display: flex; align-items: center; flex-wrap: wrap; gap: 8px;">
                <span class="result-title">Informe de Diagn√≥stico</span>
                ${otFormateada !== "N/A" ? `<span class="ot-badge" title="Orden de Trabajo">OT: ${otFormateada}</span>` : ''}
                ${esMasReciente ? '<span class="badge">M√ÅS RECIENTE</span>' : ''}
              </div>
              <div class="result-date">üìÖ ${formatearFecha(fecha)}</div>
            </div>
            
            <div class="data-grid">
              <div class="data-item">
                <span class="data-label">Patente</span>
                <span class="data-value" style="font-weight: 700; color: #00ff8c;">${patente}</span>
              </div>
              
              <div class="data-item">
                <span class="data-label">Marca</span>
                <span class="data-value">${marca}</span>
              </div>
              
              <div class="data-item">
                <span class="data-label">Modelo</span>
                <span class="data-value">${modelo}</span>
              </div>
              
              <div class="data-item">
                <span class="data-label">A√±o</span>
                <span class="data-value">${ano}</span>
              </div>
              
              <div class="data-item">
                <span class="data-label">KM</span>
                <span class="data-value">${km}</span>
              </div>
            </div>
            
            ${codigos && codigos !== "Sin c√≥digos" && codigos !== "-" && codigos.trim() !== "" ? `
              <div class="data-item">
                <span class="data-label">C√≥digos de error</span>
                <div class="text-content" style="font-family: monospace; font-size: 13px;">${String(codigos).replace(/\n/g, '<br>')}</div>
              </div>
            ` : ''}
            
            ${detalle && detalle !== "Sin detalle" && detalle !== "-" && detalle.trim() !== "" ? `
              <div class="data-item">
                <span class="data-label">Detalle del diagn√≥stico</span>
                <div class="text-content">${String(detalle).replace(/\n/g, '<br>')}</div>
              </div>
            ` : ''}
            
            ${valorArea && valorArea !== "Sin valor" && valorArea !== "-" && valorArea.trim() !== "" ? `
              <div class="data-item">
                <span class="data-label">Valor/Productos</span>
                <div class="text-content">${String(valorArea).replace(/\n/g, '<br>')}</div>
              </div>
            ` : ''}
            
            ${(causas && causas !== "Sin causas especificadas" && causas !== "-" && causas.trim() !== "") || 
              (recomendaciones && recomendaciones !== "Sin recomendaciones" && recomendaciones !== "-" && recomendaciones.trim() !== "") ? `
              <div class="data-grid">
                ${causas && causas !== "Sin causas especificadas" && causas !== "-" && causas.trim() !== "" ? `
                  <div class="data-item">
                    <span class="data-label">Posibles causas</span>
                    <div class="text-content" style="font-size: 13px;">${String(causas).replace(/\n/g, '<br>')}</div>
                  </div>
                ` : ''}
                
                ${recomendaciones && recomendaciones !== "Sin recomendaciones" && recomendaciones !== "-" && recomendaciones.trim() !== "" ? `
                  <div class="data-item">
                    <span class="data-label">Recomendaciones</span>
                    <div class="text-content" style="font-size: 13px;">${String(recomendaciones).replace(/\n/g, '<br>')}</div>
                  </div>
                ` : ''}
              </div>
            ` : ''}
            
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--card-border); width: 100%;">
              <div class="data-item">
                <span class="data-label">Valor final del diagn√≥stico</span>
                <span class="data-value" style="color: #00ff8c; font-size: 18px; font-weight: 700;">${formatearValor(valorFinal)}</span>
              </div>
            </div>
          </div>
        `;
      });
      
      resultadosDiv.innerHTML = html;
    }
    
    // Permitir buscar con la tecla Enter
    document.getElementById('patenteInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        buscarInformes();
      }
    });
    
    // Enfocar el campo de entrada al cargar la p√°gina
    window.addEventListener('load', function() {
      setTimeout(() => {
        document.getElementById('patenteInput').focus();
      }, 100);
    });
  </script>
</body>
</html>
