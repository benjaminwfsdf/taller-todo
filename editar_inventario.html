<!DOCTYPE html>
<html lang="es-CL">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‚úèÔ∏è Editar Inventario ¬∑ Aceites</title>
<style>
/* === estilos iguales a los que ya ten√≠as === */
:root{
  --brand:#900000;
  --ink:#e9ecef;
  --bg:#0b0b0c;
  --panel:#0f0f11;
}
body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink);}
.topbar{background:#000;color:#fff;text-align:center;padding:14px;border-bottom:4px solid var(--brand);}
.wrap{max-width:900px;margin:24px auto;padding:0 16px;}
.card{background:var(--panel);border:3px solid var(--brand);border-radius:16px;padding:16px;margin-bottom:16px;}
.btn{background:#0c0c0e;color:#fff;border:2px solid var(--brand);border-radius:12px;padding:12px 14px;font-weight:800;text-align:center;display:block;cursor:pointer;}
.btn:hover{background:var(--brand);}
input{width:100%;padding:10px;border-radius:10px;border:1px solid #333;background:#101114;color:#fff;margin-bottom:10px;}
table{width:100%;border-collapse:collapse;}
th,td{border-bottom:1px solid #2a2d33;padding:8px;text-align:center;}
tr.clickable:hover{background:#15171b;cursor:pointer;}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;}
</style>
</head>
<body>

<div class="topbar">‚úèÔ∏è Editar Inventario</div>

<div class="wrap">

<a href="inventario.html" class="btn">‚¨Ö Volver</a>

<div class="card">
  <h2>Buscar producto</h2>

  <input id="buscar" placeholder="Buscar por nombre, SKU o categor√≠a">

  <button class="btn" onclick="filtrar()">Buscar</button>

  <table id="tbl">
    <thead>
      <tr><th>ID</th><th>SKU</th><th>Nombre</th><th>Categor√≠a</th><th>Stock</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div class="card" id="formCard" style="display:none;">
  <h2>Datos del producto</h2>

  <div class="grid">
    <input id="id" readonly>
    <input id="sku" readonly>
    <input id="nombre" placeholder="Nombre">
    <input id="categoria" placeholder="Categor√≠a">
    <input id="costo_unit" type="number" placeholder="Costo">
    <input id="precio_unit" type="number" placeholder="Precio">
    <input id="stock" type="number" placeholder="Stock">
  </div>

  <button class="btn" onclick="guardar()">üíæ Guardar cambios</button>
</div>

</div>

<script>
const BASE_URL = "https://script.google.com/macros/s/AKfycbxf4w2lGpcSPHRiXmhQNHi_ezaJ225PPlr4wmNYRkzUwWxKGI9Bx6rAkuTu9RV0lXOrdw/exec";

async function api(action,payload={}){
  const r = await fetch(BASE_URL,{
    method:"POST",
    headers:{'Content-Type':'text/plain;charset=utf-8'},
    body:JSON.stringify({action,payload})
  });
  return r.json();
}

let productos = [];
const $ = id => document.getElementById(id);

// cargar inventario
async function cargar(){
  const r = await api("listInventory");
  productos = r.data || [];
  renderTabla(productos);
}

// Dibujar tabla
function renderTabla(list){
  const tb = document.querySelector("#tbl tbody");
  tb.innerHTML = "";
  list.forEach(p=>{
    const tr = document.createElement("tr");
    tr.className = "clickable";
    tr.innerHTML = `
      <td>${p.id}</td>
      <td>${p.sku}</td>
      <td>${p.nombre}</td>
      <td>${p.categoria}</td>
      <td>${p.stock}</td>
    `;
    tr.onclick = ()=> cargarEnFormulario(p);
    tb.appendChild(tr);
  });
}

// FILTRAR (corregido)
function filtrar(){
  const q = $("buscar").value.toLowerCase();
  const filtrados = productos.filter(p =>
    String(p.nombre||"").toLowerCase().includes(q) ||
    String(p.sku||"").toLowerCase().includes(q) ||
    String(p.categoria||"").toLowerCase().includes(q)
  );
  renderTabla(filtrados);
}

// cargar al formulario
function cargarEnFormulario(p){
  $("formCard").style.display = "block";
  $("id").value = p.id;
  $("sku").value = p.sku;
  $("nombre").value = p.nombre;
  $("categoria").value = p.categoria;
  $("costo_unit").value = p.costo_unit;
  $("precio_unit").value = p.precio_unit;
  $("stock").value = p.stock;
}

// guardar (CORREGIDO)
async function guardar(){
  const payload = {
    id: $("id").value,
    nombre: $("nombre").value,
    categoria: $("categoria").value,
    costo_unit: Number($("costo_unit").value),
    precio_unit: Number($("precio_unit").value),
    stock: Number($("stock").value)
  };

  const r = await api("editInventory", payload);
  if(!r.ok){ alert("Error al guardar: "+r.error); return; }

  alert("Producto actualizado");
  cargar();
}

cargar();
</script>
</body>
</html>
