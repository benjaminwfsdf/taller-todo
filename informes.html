<!DOCTYPE html>
<html lang="es">
<head>
  <link rel="manifest" href="manifest.json">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Taller">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <meta name="theme-color" content="#000000">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Informe de Diagn√≥stico</title>

  <style>
    #auth-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:99999;backdrop-filter:blur(2px)}
    #auth-card{background:#fff;width:min(92vw,380px);border:1px solid #000;border-radius:10px;padding:18px;box-shadow:0 4px 0 #000;font-family:Arial,sans-serif}
    #auth-card h3{margin:0 0 10px;font-size:18px}
    #auth-card .row{margin:8px 0}
    #auth-card input[type=text],#auth-card input[type=password]{width:100%;padding:10px;font-size:16px;border:1px solid #000;border-radius:6px}
    #auth-card button{margin-top:10px;width:100%;padding:10px;font-size:14px;cursor:pointer;border:1px solid #000;border-radius:6px;background:#fff;box-shadow:0 2px 0 #000}
    #auth-error{color:#b30000;font-size:12px;height:16px;margin-top:6px;font-weight:bold}
    .shake{animation:shake .2s linear 2}
    @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-6px)}75%{transform:translateX(6px)}}

    /* Modal de coincidencias OT - SIMPLIFICADO */
    #modal-coincidencias{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.85);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:99998;
    }
    #modal-coincidencias .modal-card{
      background:#fff;
      padding:15px;
      border-radius:6px;
      width:450px;
      max-width:92vw;
      border:1px solid #000;
      max-height:75vh;
      overflow-y:auto;
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    }
    #modal-coincidencias h3{
      margin-top:0;
      color:#1d3053;
      font-size:18px;
      margin-bottom: 8px;
      text-align: center;
      padding-bottom: 6px;
      border-bottom: 1px solid #eee;
    }
    #modal-coincidencias p {
      font-size:13px;
      margin-bottom:12px;
      color: #444;
      text-align: center;
      line-height: 1.3;
    }
    .coincidencia-item{
      border:1px solid #ddd;
      padding:10px;
      margin-bottom:8px;
      border-radius:5px;
      cursor:pointer;
      transition:all 0.2s;
      background: #f9f9f9;
    }
    .coincidencia-item:hover{
      background-color:#e8f4ff;
      border-color:#1d3053;
      transform: translateY(-1px);
      box-shadow: 0 3px 6px rgba(29, 48, 83, 0.1);
    }
    .coincidencia-item .fuente{
      display:inline-block;
      padding:2px 6px;
      border-radius:3px;
      font-size:11px;
      margin-left:6px;
      background:#e4e4e4;
      font-weight: bold;
    }
    .coincidencia-item .fuente-hoja1{ background:#d4edda; color:#155724; }
    .coincidencia-item .fuente-informe{ background:#d1ecf1; color:#0c5460; }
    .botones-modal{
      display:flex;
      gap:8px;
      margin-top:12px;
      padding-top: 12px;
      border-top: 1px solid #eee;
    }
    .botones-modal button{
      flex:1;
      padding:8px;
      border:1px solid #000;
      border-radius:4px;
      cursor:pointer;
      font-size:13px;
      font-weight: bold;
      transition: all 0.2s;
    }
    .botones-modal button:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
    }
    .boton-crear-nuevo{
      background:#28a745;
      color:white;
      border-color:#28a745 !important;
    }
    .boton-crear-nuevo:hover {
      background:#218838;
      border-color:#1e7e34 !important;
    }
    
    #lista-coincidencias {
      list-style:none; 
      padding:0;
      max-height: 220px;
      overflow-y: auto;
      margin: 0;
    }
    
    .cargando {
      display: none;
      text-align: center;
      padding: 15px;
      color: #1d3053;
      font-weight: bold;
    }
    
    .cargando-spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #1d3053;
      border-radius: 50%;
      width: 25px;
      height: 25px;
      animation: spin 1s linear infinite;
      margin: 0 auto 8px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .mensaje-exito {
      position: fixed;
      top: 15px;
      right: 15px;
      background: #28a745;
      color: white;
      padding: 8px 12px;
      border-radius: 5px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.15);
      z-index: 1000;
      display: none;
      font-weight: bold;
      font-size: 12px;
    }
    
    .nota-motor {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 4px;
      padding: 6px;
      margin: 8px 0;
      font-size: 11px;
      color: #856404;
      text-align: center;
    }
    
    /* NOTA IMPORTANTE EN MODAL - M√ÅS PEQUE√ëA */
    .nota-importante-modal {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 6px;
      margin: 8px 0;
      font-size: 11px;
      color: #495057;
      text-align: center;
    }
    
    /* Animaci√≥n para nuevo OT */
    @keyframes nuevaOTAnimacion {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    .nueva-ot-creada {
      animation: nuevaOTAnimacion 0.5s ease-in-out;
      border: 2px solid #28a745 !important;
    }
    
    /* Indicador de reinicio OT */
    .reinicio-indicator {
      position: fixed;
      top: 50px;
      right: 15px;
      background: #ffc107;
      color: #212529;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: bold;
      z-index: 999;
      display: none;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
  </style>

  <style>
    @media print {
      @page { size: letter; margin: 6mm 20mm; }
      body { margin: 0; padding: 0; box-shadow: none; border: none; }
      .fab { display: none !important; }
      #modal-coincidencias { display: none !important; }
      #auth-overlay { display: none !important; }
      .no-print { display: none !important; }
      .reinicio-indicator { display: none !important; }
    }

    body { 
      font-family: Arial, sans-serif; 
      margin: 0; 
      background: #f2f2f2; 
      padding-bottom: 70px;
    }

    /* Contenedor exportable (la "hoja") */
    #paper {
      width: 21cm; 
      min-height: 29.7cm;
      margin: 15px auto; 
      padding: 25px 30px;
      background: #fff;
      border: 1px solid #000; 
      box-sizing: border-box; 
      font-size: 13px;
      position: relative;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }

    .titulo {
      width: 100%; 
      background: #b30000; 
      color: #fff; 
      font-weight: bold;
      font-size: 22px; 
      padding: 10px 0; 
      text-align: center; 
      box-sizing: border-box; 
      margin: 0 0 15px 0;
      border-radius: 4px;
    }

    .contacto-wrap { 
      display:flex; 
      justify-content:space-between; 
      align-items:center; 
      margin-bottom:15px;
      gap:8px;
    }
    .contacto { 
      text-align:center; 
      font-size:13px; 
      line-height:1.3; 
      flex:1; 
      font-weight:bold; 
    }
    .contacto-wrap img { 
      max-height:150px;
      object-fit:contain; 
      max-width: 130px;
    }

    .form-grid { 
      width:100%; 
      border-collapse:collapse; 
      margin-bottom:15px;
    }
    .form-grid td { 
      padding:4px;
      border:1px solid #000; 
      vertical-align:middle; 
    }
    .form-grid label { 
      font-weight:bold; 
      margin-right:4px;
      min-width:50px;
      font-size:13px; 
    }
    .inline { 
      display:flex; 
      align-items:center; 
      gap:4px;
    }
    .form-grid input[type="text"] { 
      width:100%; 
      padding:4px 6px;
      box-sizing:border-box; 
      border:1px solid #ccc; 
      font-size:13px;
      border-radius: 3px;
      transition: border 0.2s;
    }
    
    .form-grid input[type="text"]:focus { 
      border:1px solid #b30000; 
      outline: none;
    }

    .seccion-titulo { 
      font-weight:bold; 
      margin-top:15px;
      margin-bottom:3px;
      text-transform:uppercase; 
      background:#f0f0f0; 
      padding:5px;
      border:1px solid #000; 
      border-radius: 3px;
    }

    .tabla-codigos { 
      width:100%; 
      border-collapse:collapse; 
      margin-bottom:15px;
      table-layout:fixed; 
    }
    .tabla-codigos th, .tabla-codigos td { 
      border:1px solid #000; 
      padding:6px;
      vertical-align:top; 
    }
    .tabla-codigos th { 
      background:#d9d9d9; 
      font-weight:bold; 
      text-align:left; 
    }
    .tabla-codigos textarea { 
      width:100%; 
      height:180px;
      border:none; 
      resize:vertical; 
      font-size:13px;
      box-sizing:border-box; 
      padding:6px;
      font-family: Arial, sans-serif;
      line-height: 1.4;
    }

    textarea { 
      width:100%; 
      min-height:80px;
      margin-top:3px;
      padding:6px;
      border:1px solid #000; 
      box-sizing:border-box; 
      font-size:13px;
      font-family: Arial, sans-serif;
      line-height: 1.4;
      resize: vertical;
    }

    /* VALOR FINAL CORREGIDO - OT EN EL MEDIO - SIN L√çNEA SUPERIOR */
    .valor-final { 
      margin-top:15px;
      font-weight:bold; 
      font-size:15px; 
      display:flex; 
      justify-content:space-between; 
      align-items:center; 
      gap:6px;
      flex-wrap:wrap; 
      padding-top: 10px;
    }
    
    .fecha-final { 
      border:1px solid #000; 
      padding:6px 10px;
      font-size:12px;
      color:#000; 
      background: #f9f9f9;
      border-radius: 4px;
      min-width: 100px;
      text-align: center;
    }
    
    .ot-final {
      font-weight: bold;
      font-size: 15px;
      padding: 6px 10px;
      background: #f0f0f0;
      border: 1px solid #000;
      border-radius: 4px;
      min-width: 100px;
      text-align: center;
    }
    
    .ot-final span {
      color: #b30000;
      font-weight: bold;
    }
    
    .precio-final {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .precio-final label {
      font-weight: bold;
      font-size: 15px;
    }
    
    .valor-final input { 
      padding:7px 12px;
      border:2px solid #000; 
      font-size:16px;
      font-weight:bold; 
      width:150px;
      text-align:right; 
      border-radius: 4px;
    }

    .nota-footer { 
      font-size:9px; 
      text-align:center; 
      margin-top:10px;
      font-weight:bold; 
      padding: 4px;
      background: #f0f0f0;
      border-radius: 3px;
    }

    /* BOTONERA FLOTANTE M√ÅS COMPACTA */
    .fab {
      position: fixed; 
      bottom: 8px; 
      right: 8px;
      display:flex; 
      flex-direction:column; 
      gap:4px;
      z-index: 2147483647;
      background: rgba(255,255,255,0.98);
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      max-width: 140px;
    }
    .fab button {
      padding: 6px 8px;
      font-size: 11px;
      border:1px solid #000; 
      background:#fff; 
      cursor:pointer;
      box-shadow: 0 1px 2px rgba(0,0,0,.1); 
      border-radius:4px;
      -webkit-tap-highlight-color: transparent;
      font-weight: bold;
      transition: all 0.1s;
      text-align: left;
      min-width: 120px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .fab button:active { transform: translateY(1px); }
    @supports (-webkit-touch-callout: none) { .fab { bottom: 6px; right: 6px; } }

    /* Auto-grow SOLO c√≥digos/detalle - CORREGIDO */
    #codigo_area, #detalle_area, #valor_area {
      width:100%; 
      min-height:180px;
      height: auto;
      border:none; 
      font-size:13px;
      box-sizing:border-box; 
      padding:6px;
      resize:vertical; 
      overflow-y: auto;
      font-family: Arial, sans-serif;
      line-height: 1.4;
    }
    
    /* Estilos para botones espec√≠ficos - M√ÅS COMPACTOS */
    .boton-imprimir {
      background: #28a745 !important;
      color: white !important;
      border-color: #28a745 !important;
    }
    
    .boton-pdf {
      background: #007bff !important;
      color: white !important;
      border-color: #007bff !important;
    }
    
    .boton-qr {
      background: #6f42c1 !important;
      color: white !important;
      border-color: #6f42c1 !important;
    }
    
    .boton-borrar {
      background: #dc3545 !important;
      color: white !important;
      border-color: #dc3545 !important;
    }
    
    .boton-buscar-aplicacion {
      background: #ff9900 !important;
      color: #000 !important;
      border-color: #ff9900 !important;
    }
    
    .boton-ots-anteriores {
      background: #1d3053 !important;
      color: white !important;
      border-color: #1d3053 !important;
    }
    
    /* Efecto hover para todos los botones */
    .fab button:hover {
      opacity: 0.9;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    }
    
    ::-webkit-scrollbar {
      width: 4px;
    }
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 2px;
    }
    ::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 2px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
  </style>
</head>

<body>
  <!-- Indicador de reinicio OT -->
  <div class="reinicio-indicator" id="reinicioIndicator">üîÑ Nueva OT en <span id="tiempoRestante">60</span>s</div>

  <!-- Modal auth -->
  <div id="auth-overlay" aria-hidden="true">
    <div id="auth-card">
      <h3>Acceso</h3>
      <p style="margin:0 0 6px; font-size:13px">Ingresa tus credenciales para continuar.</p>
      <div class="row"><input id="auth-user" name="username" type="text" inputmode="email" autocapitalize="none" autocorrect="off" placeholder="tu@correo.com" autocomplete="username" /></div>
      <div class="row"><input id="auth-pin" name="password" type="password" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" /></div>
      <div id="auth-error"></div>
      <button id="auth-btn">Entrar</button>
      <p style="font-size:11px;opacity:.7;margin-top:8px">Cerrar sesi√≥n: <b>Ctrl+L</b></p>
    </div>
  </div>

  <!-- MODAL DE COINCIDENCIAS OT - SIMPLIFICADO -->
  <div id="modal-coincidencias">
    <div class="modal-card">
      <h3>OTs Anteriores</h3>
      <p>Seleccione una OT para ver detalles.</p>
      
      <div class="nota-importante-modal">
        ‚ö†Ô∏è <strong>Nueva OT:</strong> Se mantienen patente y datos, <strong>sin motor</strong>
      </div>
      
      <div id="cargando-ots" class="cargando">
        <div class="cargando-spinner"></div>
        <p>Buscando OTs anteriores...</p>
      </div>
      
      <ul id="lista-coincidencias"></ul>
      
      <div class="botones-modal">
        <button onclick="cerrarModalCoincidencias()" style="background:#6c757d;color:white;border-color:#6c757d">Cerrar</button>
        <button class="boton-crear-nuevo" onclick="crearNuevaOTDesdeModal()" id="btnNuevaOT">‚ú® Nueva OT</button>
      </div>
    </div>
  </div>

  <!-- Mensaje de √©xito -->
  <div class="mensaje-exito" id="mensajeExito"></div>

  <!-- ===== CONTENIDO DEL INFORME ===== -->
  <div id="paper">
    <!-- TITULO PRINCIPAL (sin OT arriba) -->
    <div class="titulo">INFORME DE DIAGNOSTICO</div>

    <div class="contacto-wrap">
      <img src="img/logo-scanners.png" alt="logo scanners" loading="eager" crossorigin="anonymous" />
      <div class="contacto">
        WWW.ELSE√ëORDELOSESCANER.CL<br />
        DORSAL (ALTURA 6200) METRO NEPTUNO<br />
        CELULAR: +56976209564<br />
        (WALDO)<br /><br />
        SCANNER ORIGINAL TODAS LAS MARCAS<br />
        LIMPIEZA INYECTORES ‚Äì SISTEMAS DPF - GASES LLAVES CON CHIP ‚Äì PROGRAMACION
      </div>
      <img src="img/qr-whatsapp2.png" alt="QR whatsapp" loading="eager" crossorigin="anonymous" />
    </div>

    <table class="form-grid">
      <tr>
        <td><div class="inline"><label>MARCA:</label><input type="text" name="marca" id="marca" style="text-transform: uppercase;"></div></td>
        <td><div class="inline"><label>MODELO:</label><input type="text" name="modelo" id="modelo" style="text-transform: uppercase;"></div></td>
      </tr>
      <tr>
        <td><div class="inline"><label>PATENTE:</label><input type="text" name="patente" id="patente" style="text-transform: uppercase;"></div></td>
        <td><div class="inline"><label>A√ëO:</label><input type="text" name="ano" id="ano" style="text-transform: uppercase;"></div></td>
      </tr>
      <tr>
        <td><div class="inline"><label>KM:</label><input type="text" name="km" id="km" style="text-transform: uppercase;"></div></td>
        <td><div class="inline"><label>MOTOR:</label><input type="text" name="motor" id="motor" style="text-transform: uppercase;"></div></td>
      </tr>
    </table>

    <table class="tabla-codigos">
      <thead>
        <tr>
          <th style="width: 15%;">C√ìDIGOS</th>
          <th style="width: 70%;">DETALLE</th>
          <th style="width: 15%;">VALOR</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><textarea name="codigo_area" id="codigo_area" style="text-transform: uppercase;"></textarea></td>
          <td><textarea name="detalle_area" id="detalle_area"></textarea></td>
          <td><textarea name="valor_area" id="valor_area"></textarea></td>
        </tr>
      </tbody>
    </table>

    <div class="seccion-titulo">POSIBLES CAUSAS</div>
    <textarea name="causas" id="causas"></textarea>

    <div class="seccion-titulo">RECOMENDACIONES</div>
    <textarea name="recomendaciones" id="recomendaciones"></textarea>

    <!-- SECCI√ìN FINAL CON FECHA, OT Y PRECIO - SIN L√çNEA SEPARADORA -->
    <div class="valor-final">
      <div class="fecha-final" id="fecha"></div>
      
      <div class="ot-final" id="otFinalContainer">
        OT: <span id="otNumero"></span>
      </div>
      
      <div class="precio-final">
        <label>$</label>
        <input type="text" name="valor_final" id="valor_final">
      </div>
    </div>

    <div class="nota-footer">
      <strong>NOTA: COMPROBANTE VALIDO PARA SEGUNDO SCANNER (7 D√çAS)</strong>
    </div>
  </div>

  <!-- ====== AUTH ====== -->
  <script>
    (function(){
      // SHA-256("informes@")
      const PASS_HASH = "76c4d54885353802045d21b7b97d9b892f5b7c72fd0eff29f366d9d44dd0b0cd";
      const HOURS_VALID = 12;
      const storeKey = "auth_until_ts";
      const STORAGE = localStorage;

      const $ov = document.getElementById('auth-overlay');
      const $user = document.getElementById('auth-user');
      const $pin = document.getElementById('auth-pin');
      const $btn = document.getElementById('auth-btn');
      const $err = document.getElementById('auth-error');

      const now = () => Date.now();
      const isAuthed = () => {
        const until = parseInt(STORAGE.getItem(storeKey) || "0", 10);
        return until && until > now();
      };
      const setAuthed = (h) => STORAGE.setItem(storeKey, String(now() + (h||HOURS_VALID)*3600*1000));
      const logout = () => { STORAGE.removeItem(storeKey); sessionStorage.removeItem(storeKey); location.reload(); };

      async function sha256Hex(text){
        const enc = new TextEncoder().encode(text);
        const buf = await crypto.subtle.digest("SHA-256", enc);
        return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
      }

      async function tryLogin(){
        $err.textContent = "";
        const pin = ($pin.value || "").trim();
        if (!pin) { $err.textContent = "Ingresa la clave."; $pin.focus(); return; }
        const h = await sha256Hex(pin);
        if (h === PASS_HASH){
          setAuthed(HOURS_VALID);
          $ov.style.display = "none";
          $ov.setAttribute("aria-hidden","true");
          try{
            if ('PasswordCredential' in window && 'credentials' in navigator){
              const username = ($user.value || 'usuario').trim();
              const cred = new window.PasswordCredential({ id: username, name: username, password: pin });
              await navigator.credentials.store(cred);
            }
          }catch(e){}
        } else {
          $err.textContent = "Clave incorrecta.";
          const card = document.getElementById('auth-card');
          card.classList.remove('shake'); void card.offsetWidth; card.classList.add('shake');
          $pin.select();
        }
      }

      if (!isAuthed()){
        $ov.style.display = "flex";
        $ov.setAttribute("aria-hidden","false");
        setTimeout(()=> ($user.value ? $pin.focus() : $user.focus()), 0);
      }

      $btn.addEventListener('click', tryLogin);
      $pin.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') tryLogin(); });

      document.addEventListener('keydown', (e)=>{
        if (e.ctrlKey && (e.key === 'l' || e.key === 'L')) { e.preventDefault(); logout(); }
      });
    })();
  </script>

  <!-- ====== Script principal MODIFICADO ====== -->
  <script>
    // URL de la API de Google Apps Script
    const API_URL = "https://script.google.com/macros/s/AKfycbylWprbcHvUITXljajbJYO1pxGJ_nGtubA8NOjI-dKuoB6GRklwksrqUcS64fX-_N3a/exec";

    // Variables globales
    let registroSeleccionado = null;
    let modoNuevoRegistro = true;
    let ultimaOTCalculada = "";
    let ultimaPatenteBuscada = "";
    let modalAbierto = false;
    let coincidenciasEncontradas = [];
    let patenteEnModal = "";
    
    // Variables para prevenci√≥n de p√©rdida de datos
    let autoSaveTimeout = null;
    let lastSavedState = {};
    let isSaving = false;
    
    // ====== VARIABLES PARA REINICIO AUTOM√ÅTICO DE OT ======
    let reinicioTimer = null;
    let ultimoReinicio = Date.now();
    let reinicioContador = 60; // 60 segundos = 1 minuto
    let reinicioPausado = false;
    
    // Cach√© para b√∫squedas de patente (MEJORA DE VELOCIDAD)
    let patenteCache = new Map();
    let cacheTimestamp = 0;
    const CACHE_DURACION = 30000; // 30 segundos

    // Funci√≥n para normalizar patente
    function normalizarPatente(p){
      return (p||"").toUpperCase().replace(/\s+/g,"").replace(/[^A-Z0-9]/g,"");
    }

    // Inicializaci√≥n
    function setFechaHoy(){
      const hoy = new Date();
      const fechaFormateada = hoy.toLocaleDateString("es-CL");
      document.getElementById("fecha").textContent = fechaFormateada;
    }

    // Obtener la siguiente OT - MEJORADA
    async function cargarSiguienteOT(sinCerrarModal = false){
      try{
        const timestamp = new Date().getTime();
        const response = await fetch(`${API_URL}?action=obtenerSiguienteOT&t=${timestamp}`);
        
        if (response.ok) {
          const data = await response.json();
          if (data.success && data.nextOT) {
            const otFormateada = String(data.nextOT).padStart(6, "0");
            document.getElementById("otNumero").textContent = otFormateada;
            
            // Animaci√≥n para nueva OT
            const otContainer = document.getElementById("otFinalContainer");
            otContainer.classList.add("nueva-ot-creada");
            setTimeout(() => {
              otContainer.classList.remove("nueva-ot-creada");
            }, 500);
            
            ultimaOTCalculada = otFormateada;
            
            // Mostrar mensaje de nueva OT
            if (sinCerrarModal) {
              mostrarMensajeExito(`‚ú® Nueva OT: ${otFormateada}`, "success");
            }
            
            return otFormateada;
          }
        }
        
        // Si falla, usar un valor por defecto
        const otDefault = "000001";
        document.getElementById("otNumero").textContent = otDefault;
        ultimaOTCalculada = otDefault;
        return otDefault;
        
      }catch(e){
        console.error("Error cargando OT:", e);
        const otDefault = "000001";
        document.getElementById("otNumero").textContent = otDefault;
        ultimaOTCalculada = otDefault;
        return otDefault;
      }
    }

    // Guardar estado actual del formulario
    function saveCurrentState() {
      if (isSaving) return;
      
      const state = {
        marca: document.getElementById("marca").value,
        modelo: document.getElementById("modelo").value,
        patente: document.getElementById("patente").value,
        ano: document.getElementById("ano").value,
        km: document.getElementById("km").value,
        motor: document.getElementById("motor").value,
        codigo_area: document.getElementById("codigo_area").value,
        detalle_area: document.getElementById("detalle_area").value,
        valor_area: document.getElementById("valor_area").value,
        causas: document.getElementById("causas").value,
        recomendaciones: document.getElementById("recomendaciones").value,
        valor_final: document.getElementById("valor_final").value,
        otNumero: document.getElementById("otNumero").textContent,
        timestamp: Date.now()
      };
      
      lastSavedState = state;
      
      // Guardar en localStorage como backup
      localStorage.setItem('informe_backup', JSON.stringify(state));
      localStorage.setItem('informe_backup_timestamp', Date.now().toString());
      
      return state;
    }

    // Buscar patente autom√°ticamente - MEJORADA CON CACH√â
    async function buscarPorPatente(){
      const patenteInput = document.getElementById("patente");
      const pat = normalizarPatente(patenteInput.value);
      
      if(!pat || pat.length < 3) {
        modoNuevoRegistro = true;
        registroSeleccionado = null;
        return;
      }
      
      if (pat === ultimaPatenteBuscada && registroSeleccionado) {
        return;
      }
      
      if (modalAbierto) {
        return;
      }
      
      try{
        // Verificar cach√© primero (MEJORA DE VELOCIDAD)
        const ahora = Date.now();
        if (patenteCache.has(pat) && (ahora - cacheTimestamp < CACHE_DURACION)) {
          const data = patenteCache.get(pat);
          if(!data.success || !data.registros || data.registros.length === 0) {
            modoNuevoRegistro = true;
            registroSeleccionado = null;
            ultimaPatenteBuscada = pat;
            await cargarSiguienteOT();
            return;
          }
          
          ultimaPatenteBuscada = pat;
          patenteEnModal = pat;
          coincidenciasEncontradas = data.registros;
          mostrarModalCoincidencias(data.registros);
          return;
        }
        
        // Si no hay cach√© o est√° expirado, hacer petici√≥n
        const timestamp = new Date().getTime();
        const response = await fetch(`${API_URL}?action=buscarPorPatente&patente=${encodeURIComponent(pat)}&t=${timestamp}`);
        const data = await response.json();

        // Guardar en cach√© (MEJORA DE VELOCIDAD)
        patenteCache.set(pat, data);
        cacheTimestamp = ahora;

        if(!data.success || !data.registros || data.registros.length === 0) {
          modoNuevoRegistro = true;
          registroSeleccionado = null;
          ultimaPatenteBuscada = pat;
          await cargarSiguienteOT();
          return;
        }

        ultimaPatenteBuscada = pat;
        patenteEnModal = pat;
        
        // Siempre mostrar el modal cuando hay coincidencias
        coincidenciasEncontradas = data.registros;
        mostrarModalCoincidencias(data.registros);
        
      }catch(error){
        console.error("Error buscando patente:", error);
      }
    }

    // Funci√≥n para ordenar registros por fecha descendente
    function ordenarRegistrosPorFechaDesc(registros) {
      return registros.sort((a, b) => {
        const fechaA = obtenerFechaComparable(a.Fecha);
        const fechaB = obtenerFechaComparable(b.Fecha);
        return fechaB - fechaA;
      });
    }

    // Funci√≥n para convertir fecha a formato comparable
    function obtenerFechaComparable(fechaStr) {
      if (!fechaStr) return 0;
      
      try {
        const fecha = new Date(fechaStr);
        if (!isNaN(fecha.getTime())) {
          return fecha.getTime();
        }
        
        const partes = fechaStr.split(/[/ -]/);
        if (partes.length === 3) {
          const dia = parseInt(partes[0]);
          const mes = parseInt(partes[1]) - 1;
          const a√±o = parseInt(partes[2]);
          
          if (!isNaN(dia) && !isNaN(mes) && !isNaN(a√±o)) {
            const fechaAlternativa = new Date(a√±o, mes, dia);
            if (!isNaN(fechaAlternativa.getTime())) {
              return fechaAlternativa.getTime();
            }
          }
        }
        
        return 0;
      } catch (e) {
        return 0;
      }
    }

    // Funci√≥n para cargar datos desde un registro seleccionado
    function cargarDatosDesdeRegistro(registro, desdeModal = false){
      registroSeleccionado = registro;
      modoNuevoRegistro = false;
      
      console.log("Cargando registro:", registro);
      
      // Campos b√°sicos del veh√≠culo - SIEMPRE cargar marca, modelo y patente
      document.getElementById("marca").value = registro.Marca || "";
      document.getElementById("modelo").value = registro.Modelo || "";
      document.getElementById("patente").value = registro.Patente || registro.patente || "";
      document.getElementById("km").value = registro.Kilometraje || registro.KM || registro.km || "";
      
      // A√±o - cargar si existe
      if (registro.Ano || registro.year) {
        document.getElementById("ano").value = registro.Ano || registro.year || "";
      }
      
      // MOTOR: NO CARGAR AUTOM√ÅTICAMENTE - dejar campo vac√≠o
      document.getElementById("motor").value = "";
      
      // Obtener OT del registro
      let otRegistro = "";
      
      if(registro.Fuente === "DatosInforme"){
        otRegistro = registro.OT || "";
        
        // Para informes anteriores, cargar los detalles espec√≠ficos
        // PERO conservar cualquier entrada manual existente
        const currentCodigo = document.getElementById("codigo_area").value;
        const currentDetalle = document.getElementById("detalle_area").value;
        const currentValor = document.getElementById("valor_area").value;
        const currentCausas = document.getElementById("causas").value;
        const currentRecomendaciones = document.getElementById("recomendaciones").value;
        const currentValorFinal = document.getElementById("valor_final").value;
        
        // Solo cargar si los campos est√°n vac√≠os
        if (!currentCodigo.trim()) {
          document.getElementById("codigo_area").value = registro.Codigo || "";
        }
        
        if (!currentDetalle.trim()) {
          document.getElementById("detalle_area").value = registro.Detalle || "";
        }
        
        if (!currentValor.trim()) {
          document.getElementById("valor_area").value = registro.Valor_Area || "";
        }
        
        if (!currentCausas.trim()) {
          document.getElementById("causas").value = registro.Posibles_Causas || "";
        }
        
        if (!currentRecomendaciones.trim()) {
          document.getElementById("recomendaciones").value = registro.Recomendaciones || "";
        }
        
        if (!currentValorFinal.trim()) {
          document.getElementById("valor_final").value = registro.Valor_Final || "";
        }
        
        if (desdeModal) {
          mostrarMensajeExito("‚úÖ Datos cargados (motor vac√≠o)");
          
          // Cerrar modal despu√©s de cargar datos
          setTimeout(() => {
            cerrarModalCoincidencias();
          }, 500); // Reducido de 800 a 500 ms
        }
        
      }else if(registro.Fuente === "Hoja1"){
        otRegistro = registro.OT || registro.OrdenTrabajo || "";
        
        if (desdeModal) {
          mostrarMensajeExito("‚úÖ Datos b√°sicos cargados");
          
          // Cerrar modal despu√©s de cargar datos
          setTimeout(() => {
            cerrarModalCoincidencias();
          }, 500); // Reducido de 800 a 500 ms
        }
      }
      
      // Establecer la OT si la patente coincide
      const patenteActual = normalizarPatente(document.getElementById("patente").value);
      const patenteRegistro = normalizarPatente(registro.Patente || registro.patente || "");
      
      if(patenteActual === patenteRegistro && otRegistro){
        const otFormateada = String(otRegistro).padStart(6, "0");
        document.getElementById("otNumero").textContent = otFormateada;
        ultimaOTCalculada = otFormateada;
      }
      
      // Guardar estado actual
      saveCurrentState();
      
      // Reiniciar el contador de reinicio autom√°tico
      reiniciarContadorReinicio();
      
      // Ajustar altura de textareas
      setTimeout(() => {
        autoAdjustTextareas();
      }, 50); // Reducido de 100 a 50 ms
    }

    // Funci√≥n para mostrar OTs anteriores - MEJORADA
    async function mostrarOTsAnteriores() {
      const patenteInput = document.getElementById("patente");
      const pat = normalizarPatente(patenteInput.value);
      
      if(!pat || pat.length < 3) {
        alert("Ingrese patente para buscar OTs");
        patenteInput.focus();
        return;
      }
      
      const cargandoElement = document.getElementById("cargando-ots");
      const listaElement = document.getElementById("lista-coincidencias");
      
      document.getElementById("modal-coincidencias").style.display = "flex";
      modalAbierto = true;
      patenteEnModal = pat;
      cargandoElement.style.display = "block";
      listaElement.innerHTML = "";
      
      // Verificar cach√© primero (MEJORA DE VELOCIDAD)
      const ahora = Date.now();
      if (patenteCache.has(pat) && (ahora - cacheTimestamp < CACHE_DURACION)) {
        const data = patenteCache.get(pat);
        cargandoElement.style.display = "none";
        
        if(!data.success || !data.registros || data.registros.length === 0) {
          listaElement.innerHTML = `<li style="text-align: center; padding: 12px; color: #666; background: #f8f9fa; border-radius: 5px;">
            No hay OTs anteriores para ${pat}<br>
            <button onclick="crearNuevaOTDesdeModal()" style="margin-top: 8px; padding: 6px 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
              ‚ú® Crear Nueva OT
            </button>
          </li>`;
          return;
        }
        
        const registrosOrdenados = ordenarRegistrosPorFechaDesc(data.registros);
        coincidenciasEncontradas = registrosOrdenados;
        mostrarRegistrosEnModal(registrosOrdenados);
        return;
      }
      
      try {
        const timestamp = new Date().getTime();
        const response = await fetch(`${API_URL}?action=buscarPorPatente&patente=${encodeURIComponent(pat)}&t=${timestamp}`);
        const data = await response.json();
        
        // Guardar en cach√© (MEJORA DE VELOCIDAD)
        patenteCache.set(pat, data);
        cacheTimestamp = ahora;

        cargandoElement.style.display = "none";

        if(!data.success || !data.registros || data.registros.length === 0) {
          listaElement.innerHTML = `<li style="text-align: center; padding: 12px; color: #666; background: #f8f9fa; border-radius: 5px;">
            No hay OTs anteriores para ${pat}<br>
            <button onclick="crearNuevaOTDesdeModal()" style="margin-top: 8px; padding: 6px 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
              ‚ú® Crear Nueva OT
            </button>
          </li>`;
          return;
        }

        const registrosOrdenados = ordenarRegistrosPorFechaDesc(data.registros);
        coincidenciasEncontradas = registrosOrdenados;
        mostrarRegistrosEnModal(registrosOrdenados);
        
      } catch(error) {
        console.error("Error buscando OTs anteriores:", error);
        cargandoElement.style.display = "none";
        listaElement.innerHTML = `<li style="text-align: center; padding: 12px; color: #dc3545; background: #f8d7da; border-radius: 5px;">
          Error al buscar OTs.
        </li>`;
      }
    }

    // Funci√≥n para mostrar registros en el modal - SIMPLIFICADA
    function mostrarRegistrosEnModal(registros) {
      const lista = document.getElementById("lista-coincidencias");
      lista.innerHTML = "";
      
      // Limitar a 10 registros para mejor rendimiento
      const registrosLimitados = registros.slice(0, 10);
      
      registrosLimitados.forEach((registro, index) => {
        const li = document.createElement("li");
        
        const fecha = registro.Fecha ? 
          (typeof registro.Fecha === 'string' ? registro.Fecha.split(' ')[0] : registro.Fecha) : 
          'Sin fecha';
        
        const ot = registro.OT || registro.OrdenTrabajo || 'N/A';
        const otFormateada = ot !== 'N/A' ? String(ot).padStart(6, "0") : 'N/A';
        const fuente = registro.Fuente === "Hoja1" ? "Reparaci√≥n" : "Informe";
        const claseFuente = registro.Fuente === "Hoja1" ? "fuente-hoja1" : "fuente-informe";
        
        // Determinar si tiene diagn√≥stico previo
        const tieneDiagnostico = registro.Fuente === "DatosInforme" && 
                                (registro.Codigo || registro.Detalle || registro.Posibles_Causas);
        
        li.className = "coincidencia-item";
        
        // Construir contenido del detalle
        let detalleContenido = "";
        
        if (registro.Fuente === "DatosInforme") {
          // Para informes de diagn√≥stico
          if (registro.Codigo) {
            const codigosPreview = registro.Codigo.length > 25 ? 
              registro.Codigo.substring(0, 25) + '...' : registro.Codigo;
            detalleContenido += `<div style="margin-top: 4px; color: #155724; font-size: 11px;"><strong>C√≥digos:</strong> ${codigosPreview}</div>`;
          }
          
          if (registro.Detalle) {
            const detallePreview = registro.Detalle.length > 40 ? 
              registro.Detalle.substring(0, 40) + '...' : registro.Detalle;
            detalleContenido += `<div style="margin-top: 2px; color: #0c5460; font-size: 11px;"><strong>Detalle:</strong> ${detallePreview}</div>`;
          }
          
          if (registro.Valor_Final) {
            const valor = parseInt(registro.Valor_Final) || 0;
            detalleContenido += `<div style="margin-top: 2px; color: #721c24; font-size: 11px;"><strong>Valor:</strong> $${valor.toLocaleString('es-CL')}</div>`;
          }
        } else if (registro.Fuente === "Hoja1") {
          // Para reparaciones
          if (registro.Detalle_Estado) {
            const detallePreview = registro.Detalle_Estado.length > 40 ? 
              registro.Detalle_Estado.substring(0, 40) + '...' : registro.Detalle_Estado;
            detalleContenido += `<div style="margin-top: 4px; color: #666; font-size: 11px;"><strong>Trabajo:</strong> ${detallePreview}</div>`;
          }
        }
        
        li.innerHTML = `
          <div style="display: flex; align-items: center; justify-content: space-between;">
            <div>
              <strong style="font-size: 13px; color: #1d3053;">OT: ${otFormateada}</strong>
              <div style="font-size: 11px; color: #666; margin-top: 2px;">
                ${fecha} | ${registro.Marca || ''} ${registro.Modelo || ''}
              </div>
            </div>
            <span class="fuente ${claseFuente}">${fuente}</span>
          </div>
          
          <div style="font-size: 11px; margin-top: 4px; color: #444;">
            <strong>Patente:</strong> ${registro.Patente || registro.patente || ''}
          </div>
          
          ${detalleContenido}
          
          <div style="margin-top: 6px; padding: 3px; background: ${tieneDiagnostico ? '#e8f4f8' : '#f8f9fa'}; 
               border-radius: 3px; font-size: 10px; color: ${tieneDiagnostico ? '#0c5460' : '#6c757d'};">
            <strong>${tieneDiagnostico ? 'üìã Con diagn√≥stico' : 'üõ†Ô∏è Reparaci√≥n'}</strong> - Haga clic para cargar
          </div>
        `;
        
        li.onclick = () => cargarDatosDesdeRegistro(registro, true);
        lista.appendChild(li);
      });
      
      // Actualizar texto del bot√≥n
      const botonCrearNuevo = document.getElementById("btnNuevaOT");
      if (botonCrearNuevo) {
        botonCrearNuevo.textContent = `‚ú® Nueva OT (${registros.length})`;
      }
    }

    // Funci√≥n para mostrar modal con coincidencias
    function mostrarModalCoincidencias(registros){
      const registrosOrdenados = ordenarRegistrosPorFechaDesc(registros);
      const lista = document.getElementById("lista-coincidencias");
      lista.innerHTML = "";
      
      document.getElementById("cargando-ots").style.display = "none";
      mostrarRegistrosEnModal(registrosOrdenados);
      
      document.getElementById("modal-coincidencias").style.display = "flex";
      modalAbierto = true;
    }

    // Cerrar modal
    function cerrarModalCoincidencias(){
      document.getElementById("modal-coincidencias").style.display = "none";
      modalAbierto = false;
      coincidenciasEncontradas = [];
      patenteEnModal = "";
    }

    // Crear nueva OT desde el modal - MODIFICADA PARA CERRAR MODAL
    async function crearNuevaOTDesdeModal(){
      if (coincidenciasEncontradas && coincidenciasEncontradas.length > 0) {
        // Tomar datos del primer registro (m√°s reciente) pero NO el motor
        const primerRegistro = coincidenciasEncontradas[0];
        
        // Actualizar patente si no est√° vac√≠a
        if (primerRegistro.Patente || primerRegistro.patente) {
          document.getElementById("patente").value = primerRegistro.Patente || primerRegistro.patente || "";
        }
        
        // Cargar marca y modelo
        document.getElementById("marca").value = primerRegistro.Marca || "";
        document.getElementById("modelo").value = primerRegistro.Modelo || "";
        
        // NO cargar el motor - dejar vac√≠o
        document.getElementById("motor").value = "";
        
        // Solo cargar a√±o y KM si est√°n vac√≠os
        if (!document.getElementById("ano").value.trim()) {
          document.getElementById("ano").value = primerRegistro.Ano || primerRegistro.year || "";
        }
        
        if (!document.getElementById("km").value.trim()) {
          document.getElementById("km").value = primerRegistro.Kilometraje || primerRegistro.KM || primerRegistro.km || "";
        }
      }
      
      // Limpiar campos de diagn√≥stico para nueva OT
      document.getElementById("codigo_area").value = "";
      document.getElementById("detalle_area").value = "";
      document.getElementById("valor_area").value = "";
      document.getElementById("causas").value = "";
      document.getElementById("recomendaciones").value = "";
      document.getElementById("valor_final").value = "";
      
      modoNuevoRegistro = true;
      registroSeleccionado = null;
      
      // CERRAR MODAL INMEDIATAMENTE
      cerrarModalCoincidencias();
      
      // Generar nueva OT despu√©s de cerrar modal
      await cargarSiguienteOT();
      
      // Guardar estado
      saveCurrentState();
      
      // Reiniciar el contador de reinicio autom√°tico
      reiniciarContadorReinicio();
      
      // Mostrar mensaje de √©xito
      mostrarMensajeExito("‚úÖ Nueva OT creada (motor vac√≠o)");
      
      // Enfocar campo de motor autom√°ticamente
      setTimeout(() => {
        document.getElementById("motor").focus();
      }, 300);
    }

    // Funci√≥n para mostrar mensaje de √©xito general
    function mostrarMensajeExito(mensaje, tipo = "success") {
      const mensajeElement = document.getElementById("mensajeExito");
      mensajeElement.textContent = mensaje;
      
      if (tipo === "warning") {
        mensajeElement.style.background = "#ffc107";
        mensajeElement.style.color = "#212529";
      } else {
        mensajeElement.style.background = "#28a745";
        mensajeElement.style.color = "white";
      }
      
      mensajeElement.style.display = "block";
      
      setTimeout(() => {
        mensajeElement.style.display = "none";
      }, 3000);
    }

    // Recolectar datos para guardar
    function recogerDatosInforme(){
      const otActual = document.getElementById("otNumero").textContent.trim();
      const patente = normalizarPatente(document.getElementById("patente").value);
      
      return {
        funcion: "guardar_informe",
        OT: otActual,
        patente: patente,
        codigo: document.getElementById("codigo_area").value.trim(),
        detalle: document.getElementById("detalle_area").value.trim(),
        marca: document.getElementById("marca").value.trim().toUpperCase(),
        modelo: document.getElementById("modelo").value.trim().toUpperCase(),
        ano: document.getElementById("ano").value.trim(),
        km: document.getElementById("km").value.trim(),
        motor: document.getElementById("motor").value.trim(),
        valor_area: document.getElementById("valor_area").value.trim(),
        posibles_causas: document.getElementById("causas").value.trim(),
        recomendaciones: document.getElementById("recomendaciones").value.trim(),
        valor_final: document.getElementById("valor_final").value.trim()
      };
    }

    // Funci√≥n para guardar en Google Sheets
    async function guardarEnGoogleSheetsYImprimir() {
      const datos = recogerDatosInforme();
      
      if(!datos.patente || datos.patente.length < 3){
        alert("Ingrese patente v√°lida");
        return;
      }
      
      // Verificar si hay datos para guardar
      const tieneDatosDiagnostico = datos.codigo.trim() || datos.detalle.trim() || 
                                   datos.posibles_causas.trim() || datos.recomendaciones.trim();
      
      if(!tieneDatosDiagnostico && !datos.valor_final.trim()){
        if(!confirm("No hay datos de diagn√≥stico. ¬øContinuar?")){
          return;
        }
      }
      
      // Marcar que estamos guardando
      isSaving = true;
      const botonGuardar = document.querySelector('.boton-imprimir');
      const textoOriginal = botonGuardar.textContent;
      botonGuardar.textContent = "‚è≥ Guardando...";
      botonGuardar.disabled = true;
      
      try{
        const formData = new URLSearchParams();
        for (const key in datos) {
          formData.append(key, datos[key]);
        }
        
        // Guardar en Google Sheets
        await fetch(API_URL, {
          method: "POST",
          mode: 'no-cors',
          headers: { 
            "Content-Type": "application/x-www-form-urlencoded"
          },
          body: formData.toString()
        });
        
        // Mostrar confirmaci√≥n
        const confirmado = confirm(
          `‚úÖ Informe guardado\n\n` +
          `OT: ${datos.OT}\n` +
          `Patente: ${datos.patente}\n` +
          `¬øImprimir ahora?`
        );
        
        if (confirmado) {
          setTimeout(() => {
            window.print();
          }, 500);
        }
        
        // Solo despu√©s de guardar e imprimir (o cancelar), preparar para nueva OT
        setTimeout(async () => {
          // Generar nueva OT
          await cargarSiguienteOT();
          
          // Limpiar SOLO campos de diagn√≥stico, mantener datos del veh√≠culo
          const camposParaLimpiar = [
            "codigo_area", "detalle_area", "valor_area",
            "causas", "recomendaciones", "valor_final"
          ];
          
          camposParaLimpiar.forEach(id => {
            const element = document.getElementById(id);
            if(element) element.value = "";
          });
          
          // Preparar para nuevo registro
          modoNuevoRegistro = true;
          registroSeleccionado = null;
          
          // Reiniciar el contador de reinicio autom√°tico
          reiniciarContadorReinicio();
          
          mostrarMensajeExito("‚úÖ Nueva OT lista");
          
        }, confirmado ? 1500 : 500);
        
      }catch(error){
        console.error("Error guardando:", error);
        
        const opcion = confirm(
          "‚ö†Ô∏è Error al guardar.\n\n" +
          "¬øImprimir de todos modos?\n\n" +
          "Cancelar: Mantiene datos para intentar nuevamente."
        );
        
        if(opcion){
          setTimeout(() => {
            window.print();
          }, 500);
        }
        
      }finally{
        // Restaurar bot√≥n
        botonGuardar.textContent = textoOriginal;
        botonGuardar.disabled = false;
        isSaving = false;
      }
    }

    // Borrar todo el formulario
    function borrarTodo(){
      if(!confirm("¬øBorrar TODOS los datos?")) return;
      
      const campos = [
        "marca", "modelo", "patente", "ano", 
        "km", "motor", "codigo_area", "detalle_area", 
        "valor_area", "causas", "recomendaciones", "valor_final"
      ];
      
      campos.forEach(id => {
        const element = document.getElementById(id);
        if(element) element.value = "";
      });
      
      modoNuevoRegistro = true;
      registroSeleccionado = null;
      ultimaPatenteBuscada = "";
      
      cargarSiguienteOT();
      setFechaHoy();
      saveCurrentState();
      
      // Reiniciar el contador de reinicio autom√°tico
      reiniciarContadorReinicio();
      
      // Resetear altura de textareas
      setTimeout(() => {
        autoAdjustTextareas();
      }, 50); // Reducido de 100 a 50 ms
    }

    // Ajuste autom√°tico de textareas
    function autoAdjustTextareas() {
      ['codigo_area', 'detalle_area', 'valor_area', 'causas', 'recomendaciones'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.style.height = 'auto';
          el.style.height = (el.scrollHeight + 2) + 'px';
        }
      });
    }

    // Configurar ajuste autom√°tico de textareas
    function setupAutoAdjustTextareas() {
      const textareas = ['codigo_area', 'detalle_area', 'valor_area', 'causas', 'recomendaciones'];
      
      textareas.forEach(id => {
        const textarea = document.getElementById(id);
        if (textarea) {
          textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight + 2) + 'px';
            saveCurrentState();
          });
          
          // Ajustar inicialmente
          setTimeout(() => {
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight + 2) + 'px';
          }, 50); // Reducido de 100 a 50 ms
        }
      });
    }

    // Event listeners para b√∫squeda autom√°tica - MEJORADA
    let timeoutBusqueda = null;

    document.getElementById("patente").addEventListener("input", function(){
      if (timeoutBusqueda) {
        clearTimeout(timeoutBusqueda);
      }
      
      // Reducir tiempo de debounce de 800 a 600 ms
      timeoutBusqueda = setTimeout(() => {
        if(this.value.trim().length >= 3){
          modoNuevoRegistro = true;
          registroSeleccionado = null;
          buscarPorPatente();
        }
      }, 600);
    });

    // ====== FUNCIONES PARA REINICIO AUTOM√ÅTICO DE OT CADA 1 MINUTO ======
    
    // Funci√≥n para verificar si hay datos que preservar
    function hayDatosParaPreservar() {
        const camposDiagnostico = [
            "codigo_area", "detalle_area", "valor_area",
            "causas", "recomendaciones", "valor_final"
        ];
        
        // Verificar si hay datos en campos de diagn√≥stico
        for (const id of camposDiagnostico) {
            const campo = document.getElementById(id);
            if (campo && campo.value.trim() !== "") {
                return true;
            }
        }
        
        // Verificar si hay datos b√°sicos importantes (m√°s all√° de patente)
        const camposBasicos = ["marca", "modelo", "motor", "km"];
        for (const id of camposBasicos) {
            const campo = document.getElementById(id);
            if (campo && campo.value.trim() !== "") {
                return true;
            }
        }
        
        return false;
    }

    // Funci√≥n para reiniciar la OT autom√°ticamente
    async function reiniciarOTAutomaticamente() {
        const ahora = Date.now();
        const tiempoTranscurrido = ahora - ultimoReinicio;
        
        // Solo reiniciar si han pasado m√°s de 60 segundos (1 minuto)
        if (tiempoTranscurrido < 60000) {
            return;
        }
        
        // Verificar si hay datos que preservar
        if (hayDatosParaPreservar()) {
            console.log("Hay datos importantes, no se reinicia OT autom√°ticamente");
            ultimoReinicio = ahora;
            reinicioContador = 60;
            actualizarIndicadorReinicio();
            return;
        }
        
        console.log("Reiniciando OT autom√°ticamente (1 minuto de inactividad)");
        
        // Limpiar campos de diagn√≥stico
        const camposParaLimpiar = [
            "codigo_area", "detalle_area", "valor_area",
            "causas", "recomendaciones", "valor_final"
        ];
        
        camposParaLimpiar.forEach(id => {
            const element = document.getElementById(id);
            if(element) element.value = "";
        });
        
        // Preparar para nuevo registro
        modoNuevoRegistro = true;
        registroSeleccionado = null;
        
        // Generar nueva OT
        await cargarSiguienteOT();
        
        // Actualizar fecha
        setFechaHoy();
        
        // Guardar estado
        saveCurrentState();
        
        // Mostrar mensaje de reinicio
        mostrarMensajeExito("üîÑ Nueva OT generada (reinicio autom√°tico)", "warning");
        
        // Reiniciar contador
        ultimoReinicio = ahora;
        reinicioContador = 60;
        actualizarIndicadorReinicio();
    }

    // Funci√≥n para actualizar el indicador visual de reinicio
    function actualizarIndicadorReinicio() {
        const indicador = document.getElementById("reinicioIndicator");
        const tiempoRestante = document.getElementById("tiempoRestante");
        
        if (!indicador || !tiempoRestante) return;
        
        // Mostrar/ocultar indicador seg√∫n si hay datos
        if (hayDatosParaPreservar()) {
            indicador.style.display = "none";
        } else {
            indicador.style.display = "block";
            tiempoRestante.textContent = reinicioContador;
            
            // Cambiar color cuando queda poco tiempo
            if (reinicioContador <= 10) {
                indicador.style.background = "#dc3545";
                indicador.style.color = "white";
            } else if (reinicioContador <= 30) {
                indicador.style.background = "#ffc107";
                indicador.style.color = "#212529";
            } else {
                indicador.style.background = "#17a2b8";
                indicador.style.color = "white";
            }
        }
    }

    // Funci√≥n para reiniciar el contador de reinicio
    function reiniciarContadorReinicio() {
        ultimoReinicio = Date.now();
        reinicioContador = 60;
        actualizarIndicadorReinicio();
    }

    // Funci√≥n principal del temporizador de reinicio
    function iniciarTemporizadorReinicio() {
        if (reinicioTimer) {
            clearInterval(reinicioTimer);
        }
        
        reinicioTimer = setInterval(() => {
            if (reinicioContador > 0) {
                reinicioContador--;
                actualizarIndicadorReinicio();
                
                // Verificar si es tiempo de reiniciar
                if (reinicioContador <= 0) {
                    reiniciarOTAutomaticamente();
                }
            }
        }, 1000);
    }

    // Inicializar al cargar
    window.addEventListener('load', () => {
      setFechaHoy();
      cargarSiguienteOT();
      setupAutoAdjustTextareas();
      
      // Auto-guardar peri√≥dicamente
      setInterval(saveCurrentState, 30000);
      
      // Auto-guardar al perder foco
      document.addEventListener('focusout', (e) => {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
          saveCurrentState();
        }
      });
      
      // Iniciar el temporizador de reinicio autom√°tico
      iniciarTemporizadorReinicio();
      
      // Reiniciar contador al interactuar con el formulario
      document.addEventListener('input', reiniciarContadorReinicio);
      document.addEventListener('change', reiniciarContadorReinicio);
      document.addEventListener('click', reiniciarContadorReinicio);
      document.addEventListener('keydown', reiniciarContadorReinicio);
    });
    
    // Prevenir p√©rdida de datos al cerrar
    window.addEventListener('beforeunload', (e) => {
      const hasData = document.getElementById("codigo_area").value.trim() !== '' ||
                     document.getElementById("detalle_area").value.trim() !== '' ||
                     document.getElementById("valor_final").value.trim() !== '';
      
      if (hasData && !isSaving) {
        saveCurrentState();
      }
    });
  </script>

  <!-- ====== Funci√≥n para buscar aplicaci√≥n ====== -->
  <script>
    function buscarAplicacion() {
      guardarInformeLocal();
      sessionStorage.setItem('viene_de_busqueda', 'true');

      const url = "https://taller-todo.vercel.app/buscar_aplicacion.html";
      window.open(url, "_blank", "noopener");
    }

    function guardarInformeLocal() {
      const datos = recogerDatosInforme();
      localStorage.setItem('informe_autoguardado', JSON.stringify(datos));
      localStorage.setItem('informe_autoguardado_timestamp', Date.now().toString());
    }
  </script>

  <!-- ====== Autorrelleno de DETALLE por c√≥digos ====== -->
  <script>
    const CODIGOS_BASE = {
      "P252F": "Nivel de aceite muy alto",
      "P0420": "Eficiencia del sistema de catalizador por debajo del umbral (Banco 1)",
      "P0171": "Sistema demasiado pobre (Banco 1)",
      "P0300": "Falla de encendido aleatoria o m√∫ltiple",
      "P0113": "Sensor de temperatura del aire de admisi√≥n - entrada alta",
      "P0340": "Circuito del sensor de posici√≥n del √°rbol de levas - mal funcionamiento",
      "P0335": "Sensor de posici√≥n del cig√ºe√±al - circuito defectuoso",
      "P0128": "Termostato del refrigerante - temperatura de funcionamiento por debajo del regulado",
      "P0172": "Sistema demasiado rico (Banco 1)",
      "P0011": "Posici√≥n del √°rbol de levas A - tiempo adelantado o rendimiento del sistema (Banco 1)",
      "P0016": "Sensor de posici√≥n del cig√ºe√±al - correlaci√≥n con el √°rbol de levas (Banco 1)",
      "P0102": "Sensor MAF - entrada baja",
      "P0135": "Sensor de ox√≠geno (Banco 1 Sensor 1) - calentador - mal funcionamiento del circuito",
      "P0299": "Presi√≥n del turbo/sobrealimentador por debajo del l√≠mte",
      "P0301": "Fallo de encendido del cilindro 1",
      "P0401": "Flujo insuficiente en el sistema EGR",
      "P0430": "Eficiencia del sistema de catalizador por debajo del umbral (Banco 2)",
      "P0087": "Presi√≥n de combustible/ra√≠l - demasiado baja",
      "P0101": "Sensor MAF - rango/rendimiento",
      "P0141": "Sensor de ox√≠geno (Banco 1 Sensor 2) - calentador - mal funcionamiento del circuito",
      "P0100": "Mal funcionamiento del circuito de sensor MAF o volumen de air.",
      "P0101": "Rango o rendimiento del sensor MAF fuera de especificaci√≥n.",
      "P0102": "Sensor MAF ‚Äì se√±al baja de entrada.",
      "P0106": "Sensor MAP/ABS ‚Äì rango o rendimiento fuera de especificaci√≥n.",
      "P0107": "Sensor MAP/ABS ‚Äì se√±al baja.",
      "P0108": "Sensor MAP/ABS ‚Äì se√±al alta.",
      "P0110": "Mal funcionamiento del circuito del sensor de temperatura del aire de admisi√≥n.",
      "P0113": "Sensor de temperatura del aire de admisi√≥n ‚Äì se√±al alta de entrada.",
      "P0118": "Sensor de temperatura del refrigerante del motor ‚Äì se√±al alta de entrada.",
      "P0120": "Sensor de posici√≥n del acelerador A ‚Äì mal funcionamiento de circuito.",
      "P0121": "Sensor de posici√≥n del acelerador A ‚Äì rango/rendimiento fuera de especificaci√≥n.",
      "P0122": "Sensor de posici√≥n del acelerador A ‚Äì se√±al baja.",
      "P0123": "Sensor de posici√≥n del acelerador A ‚Äì se√±al alta.",
      "P0128": "La temperatura del refrigerante est√° por debajo del rango regulado por el termostato.",
      "P0130": "Mal funcionamiento del circuito del sensor de O‚ÇÇ (Banco 1, sensor 1).",
      "P0131": "Sensor de O‚ÇÇ Banco 1, sensor 1 ‚Äì bajo voltage.",
      "P0132": "Sensor de O‚ÇÇ Banco 1, sensor 1 ‚Äì alto voltage.",
      "P0134": "Sensor de O‚ÇÇ Banco 1, sensor 1 ‚Äì sin actividad.",
      "P0135": "Mal funcionamiento del calentador del sensor de O‚ÇÇ (Banco 1, sensor 1).",
      "P0136": "Mal funcionamiento del circuito del sensor de O‚ÇÇ (Banco 1, sensor 2).",
      "P0137": "Sensor de O‚ÇÇ Banco 1, sensor 2 ‚Äì bajo voltage.",
      "P0138": "Sensor de O‚ÇÇ Banco 1, sensor 2 ‚Äì alto voltage.",
      "P0141": "Mal funcionamiento del calentador del sensor de O‚ÇÇ (Banco 1, sensor 2).",
      "P0171": "Sistema demasiado pobre (Banco 1).",
      "P0172": "Sistema demasiado rico (Banco 1).",
      "P0174": "Sistema demasiado pobre (Banco 2).",
      "P0200": "Mal funcionamiento del circuito del inyector de combustible (rango 0200-0299).",
      "P0234": "Turbo/sobrealimentador ‚Äì presi√≥n excesiva detectada.",
      "P0299": "Turbo/sobrealimentador ‚Äì rendimiento/nivel bajo.",
      "P0300": "Fallo de encendido aleatorio/m√∫ltiple cilindros detectado.",
      "P0301": "Fallo de encendido en el cilindro 1.",
      "P0302": "Fallo de encendido en el cilindro 2.",
      "P0303": "Fallo de encendido en el cilindro 3.",
      "P0304": "Fallo de encendido en el cilindro 4.",
      "P0305": "Fallo de encendido en el cilindro 5.",
      "P0306": "Fallo de encendido en el cilindro 6.",
      "P0307": "Fallo de encendido en el cilindro 7.",
      "P0308": "Fallo de encendido en el cilindro 8.",
      "P0321": "Sensor knock ‚Äì rango/rendimiento fuera de especificaci√≥n.",
      "P0325": "Sensor knock ‚Äì mal funcionamiento del circuito (Banco 1).",
      "P0328": "Sensor knock ‚Äì se√±al alta (Banco 1 o sensor √∫nico).",
      "P0335": "Mal funcionamiento del circuito del sensor de posici√≥n del cig√ºe√±al (CKP).",
      "P0340": "Mal funcionamiento del circuito del sensor de posici√≥n del √°rbol de levas (CMP).",
      "P0341": "Anomal√≠a en comparaci√≥n CKP/CMP detectada.",
      "P0400": "Mal funcionamiento del sistema de recirculaci√≥n de gases de escape (EGR) ‚Äì flujo insuficiente.",
      "P0401": "Flujo EGR insuficiente detectado.",
      "P0402": "Flujo EGR excesivo detectado.",
      "P0403": "Mal funcionamiento del circuito del sensor EGR.",
      "P0440": "Mal funcionamiento del sistema de control de emisiones evaporativas (EVAP).",
      "P0441": "Fuga del sistema EVAP detectada (fuga peque√±a o intermedia).",
      "P0442": "Fuga peque√±a del sistema EVAP detectada.",
      "P0443": "Circuito de control EVAP-VSV mal funcionando.",
      "P0444": "Circuito del sensor EVAP mal funcionamiento.",
      "P0446": "Mal funcionamiento del control del sistema EVAP.",
      "P0449": "Circuito VSV EVAP intermitente o rango/rendimiento fuera especificaci√≥n.",
      "P0480": "Mal funcionamiento del circuito del controlador de ventilador de refrigeraci√≥n.",
      "P0496": "Eficiencia del sistema de ventilador de refrigeraci√≥n por debajo del umbral.",
      "P0500": "Sensor de velocidad del veh√≠culo ‚Äì mal funcionamiento del circuito.",
      "P0501": "Rango/rendimiento del sensor de velocidad del veh√≠culo fuera de especificaci√≥n.",
      "P0504": "Mal funcionamiento del circuito del sensor de corte del rantal√≠.",
      "P0505": "Relaci√≥n rantal√≠ ‚Äì fuera de rango.",
      "P0507": "Vac√≠o excesivo en el rantal√≠ detectado.",
      "P0521": "Mal funcionamiento del circuito del sensor de presi√≥n de aceite.",
      "P0562": "Voltaje del sistema insuficiente (ECU principal).",
      "P0606": "Mal funcionamiento del microprocesador de ECM.",
      "P0700": "Mal funcionamiento gen√©rico del control de la transmisi√≥n (TCM).",
      "P0705": "Interruptor de neutro/seguridad ‚Äì mal funcionamiento del circuito.",
      "P0715": "Sensor de velocidad de entrada (transmisi√≥n) ‚Äì circuito intermitente o mal funcionamiento.",
      "P0718": "Sensor de velocidad/turbina ‚Äì circuito intermitente.",
      "P0720": "Sensor de velocidad de salida ‚Äì mal funcionamiento del circuito.",
      "P0722": "Sensor de velocidad de salida ‚Äì se√±al baja o rango fuera especificaci√≥n.",
      "P0741": "Control de presi√≥n del convertidor (presi√≥n de torque) ‚Äì rendimiento fuera de rango.",
      "P0753": "Interruptor/conjunto del cambio de la transmisi√≥n ‚Äì posici√≥n intermitente o rango fuera especificaci√≥n.",
      "P0046": "Mal funcionamiento del sistema de sobrealimentaci√≥n / presi√≥n residual del turbo.",
      "P0093": "Fuga grande del sistema de combustible detectada.",
      "P0087": "Presi√≥n de rail de combustible se√±al baja.",
      "P0088": "Presi√≥n de rail de combustible se√±al alta.",
      "P0090": "Sensor de presi√≥n de combustible mal funcionamiento del circuito.",
      "P0098": "Sensor de temperatura de aire de admisi√≥n 2 se√±al alta.",
      "P0110": "Mal funcionamiento del circuito del sensor de temperatura de aire de admisi√≥n.",
      "P0115": "Mal funcionamiento del circuito del sensor de temperatura del refrigerante del motor.",
      "P0117": "Sensor de temperatura del refrigerante se√±al baja.",
      "P0191": "Sensor de presi√≥n de combusti√≥n rango/performance fuera especificaci√≥n.",
      "P0201-P0204": "Circuito del inyector de combustible mal funcionamiento en cilindros 1 y4.",
      "P0222": "Sensor de posici√≥n del acelerador B se√±al baja.",
      "P0223": "Sensor de posici√≥n del acelerador B ‚Äì se√±al alta.",
      "P0238": "Sensor de presi√≥n turbo ‚Äì rango/performance fuera especificaci√≥n.",
      "P0315": "Valores del sistema de posici√≥n del cig√ºe√±al no almacenados.",
      "P0320": "Mal funcionamiento en la se√±al de velocidad del distribuidor/encendido.",
      "P0336": "Sensor knock ‚Äì bajo voltage (Banco 2).",
      "P0342": "Sensor CMP ‚Äì se√±al baja o rango fuera especificaci√≥n.",
      "P0351-P0354": "Bobina de encendido ‚Äì mal funcionamiento del circuito (cilindros 1-4).",
      "P0380": "Circuito del calentador del sensor de posici√≥n del cig√ºe√±al (CKP).",
      "P0410": "Sistema de aire secundario ‚Äì mal funcionamiento.",
      "P0463": "Sensor de temperatura de combustible ‚Äì se√±al fuera de rango.",
      "P0481": "Circuito de controlador del ventilador de refrigeraci√≥n ‚Äì intermitente.",
      "P0506": "Control de rantal√≠ ‚Äì rango fuera especificaci√≥n.",
      "P0522": "Sensor de presi√≥n de aceite ‚Äì rango/performance fuera especificaci√≥n.",
      "P0603": "Mal funcionamiento en el circuito de memoria ECM.",
      "P0607": "Mal funcionamiento del circuito de ECT (temperatura de refrigerante).",
      "P0641": "Voltaje del sensor/calibraci√≥n ‚Äì l√≠nea baja.",
      "P0670": "Circuito del sensor de buj√≠a incandescente ‚Äì mal funcionamiento.",
      "P0683": "Circuito del rel√© de encendido (ECM/PCM) ‚Äì mal funcionamiento.",
      "P0717": "Sensor de velocidad de entrada ‚Äì rango/performance fuera especificaci√≥n.",
      "P0722": "Sensor de velocidad de salida ‚Äì se√±al baja/performance fuera especificaci√≥n.",
      "P0730": "Relaci√≥n de engranaje incorrecta.",
      "P0740": "Solenoide de control de torque ‚Äì mal funcionamiento del circuito.",
      "P0753": "Switch cambio/transmisi√≥n mal intermitente.",
      "P0990": "Circuito del sistema de infoentretenimiento/diagn√≥stico extendido (vehicle-specific)."
    };

    const txtCodigos = document.getElementById("codigo_area");
    const txtDetalle = document.getElementById("detalle_area");
    const RE_CODIGO = /^[PBCU]\d{4}$/;
    const normalizar = s => s.toUpperCase().trim().replace(/[^A-Z0-9]/g, "");
    const codigosDe = (input) => Array.from(new Set(
      input.toUpperCase().split(/[\s,;]+/).map(normalizar).filter(c => RE_CODIGO.test(c))
    ));
    const construirLineasAutoSoloDescripcion = (codigos) => codigos.filter(c => CODIGOS_BASE[c]).map(c => `‚Ä¢ ${CODIGOS_BASE[c]}`);

    function mezclarDetalleSoloDescripcion() {
      const cods = codigosDe(txtCodigos.value);
      const nuevasAuto = construirLineasAutoSoloDescripcion(cods);
      
      if (nuevasAuto.length > 0) {
        // Si hay nuevos c√≥digos, agregarlos al inicio
        const lineasActuales = txtDetalle.value.split(/\r?\n/);
        const lineasSinAuto = lineasActuales.filter(l => !l.trim().startsWith('‚Ä¢'));
        const autoActuales = lineasActuales.filter(l => l.trim().startsWith('‚Ä¢'));
        
        // Combinar autom√°ticos nuevos y existentes (sin duplicados)
        const todasAuto = [...new Set([...autoActuales, ...nuevasAuto])];
        
        // Construir resultado: autom√°ticos primero, luego manuales
        const resultado = [...todasAuto];
        if (lineasSinAuto.length > 0) {
          if (todasAuto.length > 0) {
            resultado.push(""); // Separador
          }
          resultado.push(...lineasSinAuto);
        }
        
        txtDetalle.value = resultado.join("\n");
        
        // Ajustar altura
        txtDetalle.style.height = 'auto';
        txtDetalle.style.height = (txtDetalle.scrollHeight + 2) + 'px';
      }
    }
    
    // Configurar el auto-relleno
    txtCodigos.addEventListener("input", () => {
      clearTimeout(window.__debAutoTimer);
      
      // Solo activar auto-relleno si hay nuevos c√≥digos
      const currentCodes = codigosDe(txtCodigos.value);
      if (currentCodes.length > 0) {
        // Reducir tiempo de debounce de 500 a 300 ms
        window.__debAutoTimer = setTimeout(mezclarDetalleSoloDescripcion, 300);
      }
      
      // Auto-guardar
      saveCurrentState();
    });
  </script>

  <!-- ====== Librer√≠as: QR / compresi√≥n / PDF local ====== -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" referrerpolicy="no-referrer"></script>

  <!-- ====== Modal QR ====== -->
  <div id="qr-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); align-items:center; justify-content:center; z-index:99998;">
    <div style="background:#fff; width:min(92vw,380px); border:1px solid #000; border-radius:6px; padding:12px; box-shadow:0 3px 8px rgba(0,0,0,0.2); text-align:center;">
      <h3 style="margin:0 0 6px; font-size:15px">Escanea para descargar</h3>
      <div id="qr-box" style="display:flex; justify-content:center; margin:6px 0;"></div>
      <div style="word-break:break-all; font-size:10px; margin:5px 0;"><a id="qr-link" href="#" target="_blank" rel="noopener"></a></div>
      <div style="display:flex; gap:5px; justify-content:center; margin-top:5px;">
        <button onclick="navigator.clipboard.writeText(document.getElementById('qr-link').href)" style="padding:5px 8px; font-size:11px">Copiar</button>
        <button onclick="document.getElementById('qr-modal').style.display='none'" style="padding:5px 8px; font-size:11px">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- ====== Botonera flotante SUPER COMPACTA ====== -->
  <div class="fab">
    <button onclick="mostrarOTsAnteriores()" class="boton-ots-anteriores">üìã OTs Ant.</button>
    <button onclick="guardarEnGoogleSheetsYImprimir()" class="boton-imprimir">üñ®Ô∏è Imprimir</button>
    <button onclick="descargarPDFLocal()" class="boton-pdf">üìÑ PDF</button>
    <button onclick="generarQRDeDescargaPDF()" class="boton-qr">üì≤ QR</button>
    <button onclick="buscarAplicacion()" class="boton-buscar-aplicacion">üîç Buscar</button>
    <button onclick="borrarTodo()" class="boton-borrar">üßπ Borrar</button>
  </div>

  <!-- ====== L√≥gica QR + Descarga PDF local ====== -->
  <script>
    function construirLinkDescarga(datos){
      const packed = LZString.compressToEncodedURIComponent(JSON.stringify(datos));
      const base = location.href.substring(0, location.href.lastIndexOf('/') + 1);
      return base + 'informe_dl.html#' + packed;
    }

    function mostrarQr(url){
      const link = document.getElementById('qr-link');
      const box = document.getElementById('qr-box');
      link.textContent = url; link.href = url; box.innerHTML = "";
      new QRCode(box, { text: url, width: 160, height: 160 });
      document.getElementById('qr-modal').style.display = 'flex';
    }

    function generarQRDeDescargaPDF(){
      mostrarQr(construirLinkDescarga(recogerDatosInforme()));
    }

    function waitImagesLoaded(container){
      const imgs = Array.from(container.querySelectorAll('img'));
      if (!imgs.length) return Promise.resolve();
      return Promise.all(imgs.map(img => img.complete ? Promise.resolve() :
        new Promise(res => { img.onload = res; img.onerror = res; })));
    }

    async function descargarPDFLocal(){
      const paper = document.getElementById('paper');
      const fab = document.querySelector('.fab');
      const prev = fab.style.display; fab.style.display = 'none';
      await waitImagesLoaded(paper);

      const patente = (document.getElementById('patente').value || 'SIN_PATENTE')
                      .toUpperCase().replace(/\s+/g,'');
      const opt = {
        filename: `Informe_${patente}_${new Date().toISOString().slice(0,10)}.pdf`,
        margin: 0,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'mm', format: 'letter', orientation: 'portrait' }
      };
      try{
        await html2pdf().set(opt).from(paper).save();
      } finally {
        fab.style.display = prev || '';
      }
    }
  </script>
</body>
</html>
