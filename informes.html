<!DOCTYPE html>
<html lang="es">
<head>
  <link rel="manifest" href="manifest.json">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Taller">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <meta name="theme-color" content="#000000">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Informe de Diagn√≥stico</title>

  <style>
    #auth-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:99999;backdrop-filter:blur(2px)}
    #auth-card{background:#fff;width:min(92vw,380px);border:1px solid #000;border-radius:10px;padding:18px;box-shadow:0 4px 0 #000;font-family:Arial,sans-serif}
    #auth-card h3{margin:0 0 10px;font-size:18px}
    #auth-card .row{margin:8px 0}
    #auth-card input[type=text],#auth-card input[type=password]{width:100%;padding:10px;font-size:16px;border:1px solid #000;border-radius:6px}
    #auth-card button{margin-top:10px;width:100%;padding:10px;font-size:14px;cursor:pointer;border:1px solid #000;border-radius:6px;background:#fff;box-shadow:0 2px 0 #000}
    #auth-error{color:#b30000;font-size:12px;height:16px;margin-top:6px;font-weight:bold}
    .shake{animation:shake .2s linear 2}
    @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-6px)}75%{transform:translateX(6px)}}

    /* Modal de coincidencias OT */
    #modal-coincidencias{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.8);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:99998;
    }
    #modal-coincidencias .modal-card{
      background:#fff;
      padding:24px;
      border-radius:10px;
      width:550px;
      max-width:90vw;
      border:2px solid #000;
      max-height:85vh;
      overflow-y:auto;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    #modal-coincidencias h3{
      margin-top:0;
      color:#1d3053;
      font-size:22px;
      margin-bottom: 12px;
    }
    #modal-coincidencias p {
      font-size:16px;
      margin-bottom: 20px;
      color: #444;
    }
    .coincidencia-item{
      border:2px solid #ccc;
      padding:16px;
      margin-bottom:12px;
      border-radius:8px;
      cursor:pointer;
      transition:all 0.2s;
    }
    .coincidencia-item:hover{
      background-color:#f0f7ff;
      border-color:#1d3053;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(29, 48, 83, 0.1);
    }
    .coincidencia-item .fuente{
      display:inline-block;
      padding:3px 8px;
      border-radius:4px;
      font-size:14px;
      margin-left:8px;
      background:#e4e4e4;
      font-weight: bold;
    }
    .coincidencia-item .fuente-hoja1{ background:#d4edda; color:#155724; }
    .coincidencia-item .fuente-informe{ background:#d1ecf1; color:#0c5460; }
    .botones-modal{
      display:flex;
      gap:12px;
      margin-top:20px;
    }
    .botones-modal button{
      flex:1;
      padding:12px;
      border:2px solid #000;
      border-radius:6px;
      cursor:pointer;
      font-size:16px;
      font-weight: bold;
      transition: all 0.2s;
    }
    .botones-modal button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .boton-crear-nuevo{
      background:#28a745;
      color:white;
      border-color:#28a745 !important;
    }
    .boton-crear-nuevo:hover {
      background:#218838;
      border-color:#1e7e34 !important;
    }
    
    #lista-coincidencias {
      list-style:none; 
      padding:0;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .cargando {
      display: none;
      text-align: center;
      padding: 20px;
      color: #1d3053;
      font-weight: bold;
    }
    
    .cargando-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #1d3053;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .mensaje-exito {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #28a745;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      display: none;
      font-weight: bold;
    }
    
    .detalle-copiado {
      background-color: #d4edda !important;
      border-color: #155724 !important;
      border-left: 6px solid #155724 !important;
    }
  </style>

  <style>
    @media print {
      @page { size: letter; margin: 6mm 20mm; }
      body { margin: 0; padding: 0; box-shadow: none; border: none; }
      .fab { display: none !important; }
      #modal-coincidencias { display: none !important; }
      #auth-overlay { display: none !important; }
    }

    body { 
      font-family: Arial, sans-serif; 
      margin: 0; 
      background: #f2f2f2; 
      padding-bottom: 100px;
    }

    /* Contenedor exportable (la "hoja") */
    #paper {
      width: 21cm; 
      min-height: 29.7cm;
      margin: 20px auto; 
      padding: 30px 35px; /* Reducido de 35px 40px */
      background: #fff;
      border: 1px solid #000; 
      box-sizing: border-box; 
      font-size: 13px;
      position: relative;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .titulo {
      width: 100%; 
      background: #b30000; 
      color: #fff; 
      font-weight: bold;
      font-size: 24px; 
      padding: 12px 0; 
      text-align: center; 
      box-sizing: border-box; 
      margin: 0 0 18px 0; /* Reducido de 20px */
      border-radius: 4px;
    }

    .contacto-wrap { 
      display:flex; 
      justify-content:space-between; 
      align-items:center; 
      margin-bottom:18px; /* Reducido de 20px */
      gap:10px; /* Reducido de 12px */
    }
    .contacto { 
      text-align:center; 
      font-size:14px; 
      line-height:1.4; 
      flex:1; 
      font-weight:bold; 
    }
    .contacto-wrap img { 
      max-height:160px; /* Reducido de 170px */
      object-fit:contain; 
      max-width: 140px; /* Reducido de 150px */
    }

    .form-grid { 
      width:100%; 
      border-collapse:collapse; 
      margin-bottom:18px; /* Reducido de 20px */
    }
    .form-grid td { 
      padding:5px; /* Reducido de 6px */
      border:1px solid #000; 
      vertical-align:middle; 
    }
    .form-grid label { 
      font-weight:bold; 
      margin-right:5px; /* Reducido de 6px */
      min-width:55px; /* Reducido de 60px */
      font-size:14px; 
    }
    .inline { 
      display:flex; 
      align-items:center; 
      gap:5px; /* Reducido de 6px */
    }
    .form-grid input[type="text"] { 
      width:100%; 
      padding:5px 7px; /* Reducido de 6px 8px */
      box-sizing:border-box; 
      border:1px solid #ccc; 
      font-size:14px; /* Reducido de 15px */
      border-radius: 3px;
      transition: border 0.2s;
    }
    
    .form-grid input[type="text"]:focus { 
      border:1px solid #b30000; 
      outline: none;
    }

    .seccion-titulo { 
      font-weight:bold; 
      margin-top:18px; /* Reducido de 20px */
      margin-bottom:4px; /* Reducido de 5px */
      text-transform:uppercase; 
      background:#f0f0f0; 
      padding:6px; /* Reducido de 8px */
      border:1px solid #000; 
      border-radius: 3px;
    }

    .tabla-codigos { 
      width:100%; 
      border-collapse:collapse; 
      margin-bottom:18px; /* Reducido de 20px */
      table-layout:fixed; 
    }
    .tabla-codigos th, .tabla-codigos td { 
      border:1px solid #000; 
      padding:7px; /* Reducido de 8px */
      vertical-align:top; 
    }
    .tabla-codigos th { 
      background:#d9d9d9; 
      font-weight:bold; 
      text-align:left; 
    }
    .tabla-codigos textarea { 
      width:100%; 
      height:200px; /* Reducido de 220px */
      border:none; 
      resize:vertical; 
      font-size:14px; /* Reducido de 15px */
      box-sizing:border-box; 
      padding:7px; /* Reducido de 8px */
      font-family: Arial, sans-serif;
      line-height: 1.4;
    }

    textarea { 
      width:100%; 
      min-height:90px; /* Reducido de 100px */
      margin-top:4px; /* Reducido de 5px */
      padding:7px; /* Reducido de 8px */
      border:1px solid #000; 
      box-sizing:border-box; 
      font-size:14px; /* Reducido de 15px */
      font-family: Arial, sans-serif;
      line-height: 1.4;
      resize: vertical;
    }

    /* VALOR FINAL CORREGIDO - OT EN EL MEDIO - SIN L√çNEA SUPERIOR */
    .valor-final { 
      margin-top:20px; /* Reducido de 25px */
      font-weight:bold; 
      font-size:16px; 
      display:flex; 
      justify-content:space-between; 
      align-items:center; 
      gap:8px; /* Reducido de 10px */
      flex-wrap:wrap; 
      /* border-top: 2px solid #000; ELIMINADA LA L√çNEA */
      padding-top: 12px; /* Reducido de 15px */
    }
    
    .fecha-final { 
      border:1px solid #000; 
      padding:7px 12px; /* Reducido de 8px 15px */
      font-size:13px; /* Reducido de 14px */
      color:#000; 
      background: #f9f9f9;
      border-radius: 4px;
      min-width: 110px; /* Reducido de 120px */
      text-align: center;
    }
    
    .ot-final {
      font-weight: bold;
      font-size: 16px;
      padding: 7px 12px; /* Reducido de 8px 15px */
      background: #f0f0f0;
      border: 1px solid #000;
      border-radius: 4px;
      min-width: 110px; /* Reducido de 120px */
      text-align: center;
    }
    
    .ot-final span {
      color: #b30000;
      font-weight: bold;
    }
    
    .precio-final {
      display: flex;
      align-items: center;
      gap: 8px; /* Reducido de 10px */
    }
    
    .precio-final label {
      font-weight: bold;
      font-size: 16px;
    }
    
    .valor-final input { 
      padding:8px 14px; /* Reducido de 10px 16px */
      border:2px solid #000; 
      font-size:17px; /* Reducido de 18px */
      font-weight:bold; 
      width:170px; /* Reducido de 180px */
      text-align:right; 
      border-radius: 4px;
    }

    .nota-footer { 
      font-size:10px; 
      text-align:center; 
      margin-top:12px; /* Reducido de 15px */
      font-weight:bold; 
      padding: 5px;
      background: #f0f0f0;
      border-radius: 3px;
    }

    /* Botonera: SIEMPRE visible (m√≥vil) */
    .fab {
      position: fixed; 
      bottom: 16px; 
      right: 16px;
      display:flex; 
      flex-direction:column; 
      gap:10px;
      z-index: 2147483647;
      background: rgba(255,255,255,0.95);
      padding: 10px;
      border-radius: 12px;
      border: 1px solid #ccc;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }
    .fab button {
      padding: 12px 18px; 
      font-size: 15px;
      border:1px solid #000; 
      background:#fff; 
      cursor:pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,.15); 
      border-radius:8px;
      -webkit-tap-highlight-color: transparent;
      font-weight: bold;
      transition: all 0.2s;
      text-align: left;
      min-width: 180px;
    }
    .fab button:active { transform: translateY(1px); }
    @supports (-webkit-touch-callout: none) { .fab { bottom: 12px; right: 12px; } }

    /* Auto-grow SOLO c√≥digos/detalle - CORREGIDO */
    #codigo_area, #detalle_area, #valor_area {
      width:100%; 
      min-height:200px; /* Reducido de 220px */
      height: auto;
      border:none; 
      font-size:14px; /* Reducido de 15px */
      box-sizing:border-box; 
      padding:7px; /* Reducido de 8px */
      resize:vertical; 
      overflow-y: auto;
      font-family: Arial, sans-serif;
      line-height: 1.4;
    }
    
    /* Estilos para botones espec√≠ficos */
    .boton-imprimir {
      background: #28a745 !important;
      color: white !important;
      border-color: #28a745 !important;
    }
    
    .boton-pdf {
      background: #007bff !important;
      color: white !important;
      border-color: #007bff !important;
    }
    
    .boton-qr {
      background: #6f42c1 !important;
      color: white !important;
      border-color: #6f42c1 !important;
    }
    
    .boton-borrar {
      background: #dc3545 !important;
      color: white !important;
      border-color: #dc3545 !important;
    }
    
    .boton-buscar-aplicacion {
      background: #ff9900 !important;
      color: #000 !important;
      border-color: #ff9900 !important;
    }
    
    .boton-ots-anteriores {
      background: #1d3053 !important;
      color: white !important;
      border-color: #1d3053 !important;
    }
    
    /* Efecto hover para todos los botones */
    .fab button:hover {
      opacity: 0.9;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.25);
    }
    
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
    
    /* Para prevenir p√©rdida de datos */
    .data-protected {
      border-color: #28a745 !important;
      background-color: #f8fff9 !important;
    }
    
    /* Protecci√≥n de campos manuales */
    .manual-entry {
      background-color: #fff8e1 !important;
    }
    
    .auto-entry {
      background-color: #e8f5e9 !important;
    }
  </style>
</head>

<body>
  <!-- Modal auth -->
  <div id="auth-overlay" aria-hidden="true">
    <div id="auth-card">
      <h3>Acceso</h3>
      <p style="margin:0 0 6px; font-size:13px">Ingresa tus credenciales para continuar.</p>
      <div class="row"><input id="auth-user" name="username" type="text" inputmode="email" autocapitalize="none" autocorrect="off" placeholder="tu@correo.com" autocomplete="username" /></div>
      <div class="row"><input id="auth-pin" name="password" type="password" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" /></div>
      <div id="auth-error"></div>
      <button id="auth-btn">Entrar</button>
      <p style="font-size:11px;opacity:.7;margin-top:8px">Cerrar sesi√≥n: <b>Ctrl+L</b></p>
    </div>
  </div>

  <!-- MODAL DE COINCIDENCIAS OT -->
  <div id="modal-coincidencias">
    <div class="modal-card">
      <h3>OTs anteriores de esta patente</h3>
      <p>Seleccione una OT para cargar sus datos.</p>
      
      <div id="cargando-ots" class="cargando">
        <div class="cargando-spinner"></div>
        <p>Buscando OTs anteriores...</p>
      </div>
      
      <ul id="lista-coincidencias"></ul>
      
      <div class="botones-modal">
        <button onclick="cerrarModalCoincidencias()">Cancelar</button>
        <button class="boton-crear-nuevo" onclick="crearNuevaOTDesdeModal()">Crear Nueva OT</button>
      </div>
    </div>
  </div>

  <!-- Mensaje de √©xito -->
  <div class="mensaje-exito" id="mensajeExito"></div>

  <!-- ===== CONTENIDO DEL INFORME ===== -->
  <div id="paper">
    <!-- TITULO PRINCIPAL (sin OT arriba) -->
    <div class="titulo">INFORME DE DIAGNOSTICO</div>

    <div class="contacto-wrap">
      <img src="img/logo-scanners.png" alt="logo scanners" loading="eager" crossorigin="anonymous" />
      <div class="contacto">
        WWW.ELSE√ëORDELOSESCANER.CL<br />
        DORSAL (ALTURA 6200) METRO NEPTUNO<br />
        CELULAR: +56976209564<br />
        (WALDO)<br /><br />
        SCANNER ORIGINAL TODAS LAS MARCAS<br />
        LIMPIEZA INYECTORES ‚Äì SISTEMAS DPF - GASES LLAVES CON CHIP ‚Äì PROGRAMACION
      </div>
      <img src="img/qr-whatsapp2.png" alt="QR whatsapp" loading="eager" crossorigin="anonymous" />
    </div>

    <table class="form-grid">
      <tr>
        <td><div class="inline"><label>MARCA:</label><input type="text" name="marca" id="marca" style="text-transform: uppercase;"></div></td>
        <td><div class="inline"><label>MODELO:</label><input type="text" name="modelo" id="modelo" style="text-transform: uppercase;"></div></td>
      </tr>
      <tr>
        <td><div class="inline"><label>PATENTE:</label><input type="text" name="patente" id="patente" style="text-transform: uppercase;"></div></td>
        <td><div class="inline"><label>A√ëO:</label><input type="text" name="ano" id="ano" style="text-transform: uppercase;"></div></td>
      </tr>
      <tr>
        <td><div class="inline"><label>KM:</label><input type="text" name="km" id="km" style="text-transform: uppercase;"></div></td>
        <td><div class="inline"><label>MOTOR:</label><input type="text" name="motor" id="motor" style="text-transform: uppercase;"></div></td>
      </tr>
    </table>

    <table class="tabla-codigos">
      <thead>
        <tr>
          <th style="width: 15%;">C√ìDIGOS</th>
          <th style="width: 70%;">DETALLE</th>
          <th style="width: 15%;">VALOR</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><textarea name="codigo_area" id="codigo_area" style="text-transform: uppercase;"></textarea></td>
          <td><textarea name="detalle_area" id="detalle_area"></textarea></td>
          <td><textarea name="valor_area" id="valor_area"></textarea></td>
        </tr>
      </tbody>
    </table>

    <div class="seccion-titulo">POSIBLES CAUSAS</div>
    <textarea name="causas" id="causas"></textarea>

    <div class="seccion-titulo">RECOMENDACIONES</div>
    <textarea name="recomendaciones" id="recomendaciones"></textarea>

    <!-- SECCI√ìN FINAL CON FECHA, OT Y PRECIO - SIN L√çNEA SEPARADORA -->
    <div class="valor-final">
      <div class="fecha-final" id="fecha"></div>
      
      <div class="ot-final" id="otFinalContainer">
        OT: <span id="otNumero"></span>
      </div>
      
      <div class="precio-final">
        <label>$</label>
        <input type="text" name="valor_final" id="valor_final">
      </div>
    </div>

    <div class="nota-footer">
      <strong>NOTA: COMPROBANTE VALIDO PARA SEGUNDO SCANNER (7 D√çAS)</strong>
    </div>
  </div>

  <!-- ====== AUTH ====== -->
  <script>
    (function(){
      // SHA-256("informes@")
      const PASS_HASH = "76c4d54885353802045d21b7b97d9b892f5b7c72fd0eff29f366d9d44dd0b0cd";
      const HOURS_VALID = 12;
      const storeKey = "auth_until_ts";
      const STORAGE = localStorage;

      const $ov = document.getElementById('auth-overlay');
      const $user = document.getElementById('auth-user');
      const $pin = document.getElementById('auth-pin');
      const $btn = document.getElementById('auth-btn');
      const $err = document.getElementById('auth-error');

      const now = () => Date.now();
      const isAuthed = () => {
        const until = parseInt(STORAGE.getItem(storeKey) || "0", 10);
        return until && until > now();
      };
      const setAuthed = (h) => STORAGE.setItem(storeKey, String(now() + (h||HOURS_VALID)*3600*1000));
      const logout = () => { STORAGE.removeItem(storeKey); sessionStorage.removeItem(storeKey); location.reload(); };

      async function sha256Hex(text){
        const enc = new TextEncoder().encode(text);
        const buf = await crypto.subtle.digest("SHA-256", enc);
        return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
      }

      async function tryLogin(){
        $err.textContent = "";
        const pin = ($pin.value || "").trim();
        if (!pin) { $err.textContent = "Ingresa la clave."; $pin.focus(); return; }
        const h = await sha256Hex(pin);
        if (h === PASS_HASH){
          setAuthed(HOURS_VALID);
          $ov.style.display = "none";
          $ov.setAttribute("aria-hidden","true");
          try{
            if ('PasswordCredential' in window && 'credentials' in navigator){
              const username = ($user.value || 'usuario').trim();
              const cred = new window.PasswordCredential({ id: username, name: username, password: pin });
              await navigator.credentials.store(cred);
            }
          }catch(e){}
        } else {
          $err.textContent = "Clave incorrecta.";
          const card = document.getElementById('auth-card');
          card.classList.remove('shake'); void card.offsetWidth; card.classList.add('shake');
          $pin.select();
        }
      }

      if (!isAuthed()){
        $ov.style.display = "flex";
        $ov.setAttribute("aria-hidden","false");
        setTimeout(()=> ($user.value ? $pin.focus() : $user.focus()), 0);
      }

      $btn.addEventListener('click', tryLogin);
      $pin.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') tryLogin(); });

      document.addEventListener('keydown', (e)=>{
        if (e.ctrlKey && (e.key === 'l' || e.key === 'L')) { e.preventDefault(); logout(); }
      });
    })();
  </script>

  <!-- ====== Script principal CORREGIDO ====== -->
  <script>
    // URL de la API de Google Apps Script
    const API_URL = "https://script.google.com/macros/s/AKfycbylWprbcHvUITXljajbJYO1pxGJ_nGtubA8NOjI-dKuoB6GRklwksrqUcS64fX-_N3a/exec";

    // Variables globales
    let registroSeleccionado = null;
    let modoNuevoRegistro = true;
    let ultimaOTCalculada = "";
    let ultimaPatenteBuscada = "";
    let modalAbierto = false;
    let coincidenciasEncontradas = [];
    let datosFormularioActual = {};
    
    // Variables para prevenci√≥n de p√©rdida de datos
    let autoSaveTimeout = null;
    let lastSavedState = {};
    let isRestoringData = false;
    
    // Variables para controlar contenido manual/autom√°tico
    let manualEntries = {
      codigo_area: [],
      detalle_area: [],
      valor_area: [],
      causas: [],
      recomendaciones: []
    };
    
    let autoEntries = {
      codigo_area: [],
      detalle_area: [],
      valor_area: [],
      causas: [],
      recomendaciones: []
    };

    // Funci√≥n para normalizar patente
    function normalizarPatente(p){
      return (p||"").toUpperCase().replace(/\s+/g,"").replace(/[^A-Z0-9]/g,"");
    }

    // Inicializaci√≥n
    function setFechaHoy(){
      const hoy = new Date();
      const fechaFormateada = hoy.toLocaleDateString("es-CL");
      document.getElementById("fecha").textContent = fechaFormateada;
      
      // Guardar estado inicial
      saveCurrentState();
    }

    // Obtener la siguiente OT
    async function cargarSiguienteOT(){
      try{
        const timestamp = new Date().getTime();
        const response = await fetch(`${API_URL}?action=obtenerSiguienteOT&t=${timestamp}`);
        
        if (response.ok) {
          const data = await response.json();
          if (data.success && data.nextOT) {
            const otFormateada = String(data.nextOT).padStart(6, "0");
            document.getElementById("otNumero").textContent = otFormateada;
            ultimaOTCalculada = otFormateada;
            return otFormateada;
          }
        }
        
        // Si falla, usar un valor por defecto
        const otDefault = "000001";
        document.getElementById("otNumero").textContent = otDefault;
        ultimaOTCalculada = otDefault;
        return otDefault;
        
      }catch(e){
        console.error("Error cargando OT:", e);
        const otDefault = "000001";
        document.getElementById("otNumero").textContent = otDefault;
        ultimaOTCalculada = otDefault;
        return otDefault;
      }
    }

    // Guardar estado actual del formulario
    function saveCurrentState() {
      lastSavedState = {
        marca: document.getElementById("marca").value,
        modelo: document.getElementById("modelo").value,
        patente: document.getElementById("patente").value,
        ano: document.getElementById("ano").value,
        km: document.getElementById("km").value,
        motor: document.getElementById("motor").value,
        codigo_area: document.getElementById("codigo_area").value,
        detalle_area: document.getElementById("detalle_area").value,
        valor_area: document.getElementById("valor_area").value,
        causas: document.getElementById("causas").value,
        recomendaciones: document.getElementById("recomendaciones").value,
        valor_final: document.getElementById("valor_final").value,
        otNumero: document.getElementById("otNumero").textContent
      };
      
      // Guardar en localStorage como backup
      localStorage.setItem('informe_backup', JSON.stringify(lastSavedState));
      localStorage.setItem('informe_backup_timestamp', Date.now().toString());
      
      // Separar contenido manual
      separateManualContent();
    }

    // Separar contenido manual del autom√°tico
    function separateManualContent() {
      const textareas = ['codigo_area', 'detalle_area', 'valor_area', 'causas', 'recomendaciones'];
      
      textareas.forEach(id => {
        const textarea = document.getElementById(id);
        if (textarea) {
          const lines = textarea.value.split('\n');
          const manualLines = [];
          const autoLines = [];
          
          lines.forEach(line => {
            const trimmedLine = line.trim();
            if (trimmedLine) {
              // Detectar si es l√≠nea autom√°tica (comienza con ‚Ä¢ o es de la base de datos)
              if (trimmedLine.startsWith('‚Ä¢ ') || 
                  trimmedLine.includes('(Banco') ||
                  trimmedLine.includes('Sensor') ||
                  trimmedLine.includes('Circuito') ||
                  trimmedLine.includes('Falla') ||
                  trimmedLine.includes('Mal funcionamiento')) {
                autoLines.push(line);
              } else {
                manualLines.push(line);
              }
            }
          });
          
          manualEntries[id] = manualLines;
          autoEntries[id] = autoLines;
        }
      });
    }

    // Restaurar datos perdidos
    function restoreLostData() {
      if (isRestoringData) return;
      
      const backup = localStorage.getItem('informe_backup');
      if (!backup) return;
      
      try {
        const data = JSON.parse(backup);
        const timestamp = parseInt(localStorage.getItem('informe_backup_timestamp') || '0');
        const minutesAgo = (Date.now() - timestamp) / (1000 * 60);
        
        // Solo restaurar si el backup es reciente (√∫ltimos 5 minutos)
        if (minutesAgo < 5) {
          isRestoringData = true;
          
          // Verificar si los campos est√°n vac√≠os o casi vac√≠os
          const textareas = ['codigo_area', 'detalle_area', 'valor_area', 'causas', 'recomendaciones'];
          
          textareas.forEach(id => {
            const element = document.getElementById(id);
            const currentValue = element.value.trim();
            const backupValue = data[id] || '';
            
            // Si el campo actual est√° vac√≠o o tiene muy poco contenido, restaurar del backup
            if (currentValue.length < 10 && backupValue.length > 10) {
              element.value = backupValue;
              
              // Re-aplicar estilos
              if (id === 'detalle_area') {
                applyAutoFillStyles(element);
              }
            }
            // Si el campo actual tiene contenido pero es diferente al backup
            // (posible p√©rdida de datos), preguntar al usuario
            else if (currentValue.length > 0 && backupValue.length > 0 && 
                     currentValue !== backupValue && 
                     backupValue.length > currentValue.length) {
              // Marcar que podr√≠a haber p√©rdida de datos
              element.classList.add('manual-entry');
              
              // Mostrar notificaci√≥n discreta
              setTimeout(() => {
                showDataLossWarning(id);
              }, 2000);
            }
          });
          
          setTimeout(() => {
            isRestoringData = false;
          }, 1000);
        }
      } catch (e) {
        console.error("Error restoring backup:", e);
      }
    }

    // Mostrar advertencia de posible p√©rdida de datos
    function showDataLossWarning(fieldId) {
      const fieldNames = {
        'codigo_area': 'C√≥digos',
        'detalle_area': 'Detalle',
        'valor_area': 'Valor',
        'causas': 'Causas',
        'recomendaciones': 'Recomendaciones'
      };
      
      const notification = document.createElement('div');
      notification.className = 'data-loss-notification';
      notification.innerHTML = `
        <div style="position: fixed; top: 50px; right: 20px; background: #ffc107; color: #000; padding: 10px 15px; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 10000;">
          <strong>‚ö†Ô∏è Posible p√©rdida de datos</strong><br>
          Se detect√≥ que ${fieldNames[fieldId]} podr√≠a haberse perdido.<br>
          <small>Se restaur√≥ del √∫ltimo guardado autom√°tico.</small>
        </div>
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 5000);
    }

    // Auto-guardar cada 30 segundos
    function setupAutoSave() {
      // Guardar estado inicial
      saveCurrentState();
      
      // Configurar auto-guardado peri√≥dico
      setInterval(saveCurrentState, 30000);
      
      // Configurar auto-guardado en eventos
      const elementos = [
        'codigo_area', 'detalle_area', 'valor_area',
        'causas', 'recomendaciones', 'valor_final',
        'marca', 'modelo', 'patente', 'ano', 'km', 'motor'
      ];
      
      elementos.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener('input', () => {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(saveCurrentState, 1000);
            
            // Marcar como entrada manual
            if (id === 'detalle_area') {
              markManualEntry(element);
            }
          });
          
          element.addEventListener('blur', saveCurrentState);
        }
      });
      
      // Verificar p√©rdida de datos al cargar la p√°gina
      window.addEventListener('load', () => {
        setTimeout(restoreLostData, 1000);
      });
      
      // Prevenir p√©rdida de datos al navegar/cerrar
      window.addEventListener('beforeunload', (e) => {
        const hasData = document.getElementById("codigo_area").value.trim() !== '' ||
                       document.getElementById("detalle_area").value.trim() !== '';
        
        if (hasData) {
          saveCurrentState();
        }
      });
    }

    // Marcar entrada manual
    function markManualEntry(textarea) {
      const lines = textarea.value.split('\n');
      const lastLine = lines[lines.length - 1] || '';
      
      // Si la √∫ltima l√≠nea no es autom√°tica, marcar como manual
      if (lastLine.trim() && !lastLine.trim().startsWith('‚Ä¢ ') && 
          !lastLine.includes('(Banco') && !lastLine.includes('Sensor')) {
        textarea.classList.add('manual-entry');
        textarea.classList.remove('auto-entry');
      }
    }

    // Aplicar estilos de auto-relleno
    function applyAutoFillStyles(textarea) {
      const lines = textarea.value.split('\n');
      let hasAutoContent = false;
      
      lines.forEach(line => {
        if (line.trim().startsWith('‚Ä¢ ') || line.includes('(Banco')) {
          hasAutoContent = true;
        }
      });
      
      if (hasAutoContent) {
        textarea.classList.add('auto-entry');
      }
    }

    // Ajuste autom√°tico de textareas
    function autoAdjustTextareas() {
      ['codigo_area', 'detalle_area', 'valor_area', 'causas', 'recomendaciones'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.style.height = 'auto';
          el.style.height = (el.scrollHeight + 2) + 'px';
        }
      });
    }

    // Configurar ajuste autom√°tico de textareas
    function setupAutoAdjustTextareas() {
      const textareas = ['codigo_area', 'detalle_area', 'valor_area', 'causas', 'recomendaciones'];
      
      textareas.forEach(id => {
        const textarea = document.getElementById(id);
        if (textarea) {
          textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight + 2) + 'px';
          });
          
          // Ajustar inicialmente
          setTimeout(() => {
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight + 2) + 'px';
          }, 100);
        }
      });
    }

    // Buscar patente autom√°ticamente
    async function buscarPorPatente(){
      const patenteInput = document.getElementById("patente");
      const pat = normalizarPatente(patenteInput.value);
      
      if(!pat || pat.length < 3) {
        modoNuevoRegistro = true;
        registroSeleccionado = null;
        return;
      }
      
      if (pat === ultimaPatenteBuscada && registroSeleccionado) {
        return;
      }
      
      if (modalAbierto) {
        return;
      }
      
      try{
        const timestamp = new Date().getTime();
        const response = await fetch(`${API_URL}?action=buscarPorPatente&patente=${encodeURIComponent(pat)}&t=${timestamp}`);
        const data = await response.json();

        if(!data.success || !data.registros || data.registros.length === 0) {
          modoNuevoRegistro = true;
          registroSeleccionado = null;
          ultimaPatenteBuscada = pat;
          await cargarSiguienteOT();
          return;
        }

        ultimaPatenteBuscada = pat;
        
        if(data.registros.length === 1){
          cargarDatosDesdeRegistro(data.registros[0], false);
          return;
        }
        
        coincidenciasEncontradas = data.registros;
        guardarDatosFormularioActual();
        mostrarModalCoincidencias(data.registros);
        
      }catch(error){
        console.error("Error buscando patente:", error);
      }
    }

    // Guardar datos actuales del formulario
    function guardarDatosFormularioActual(){
      datosFormularioActual = {
        marca: document.getElementById("marca").value,
        modelo: document.getElementById("modelo").value,
        patente: document.getElementById("patente").value,
        ano: document.getElementById("ano").value,
        km: document.getElementById("km").value,
        motor: document.getElementById("motor").value
      };
    }

    // Funci√≥n para ordenar registros por fecha descendente
    function ordenarRegistrosPorFechaDesc(registros) {
      return registros.sort((a, b) => {
        const fechaA = obtenerFechaComparable(a.Fecha);
        const fechaB = obtenerFechaComparable(b.Fecha);
        return fechaB - fechaA;
      });
    }

    // Funci√≥n para convertir fecha a formato comparable
    function obtenerFechaComparable(fechaStr) {
      if (!fechaStr) return 0;
      
      try {
        const fecha = new Date(fechaStr);
        if (!isNaN(fecha.getTime())) {
          return fecha.getTime();
        }
        
        const partes = fechaStr.split(/[/ -]/);
        if (partes.length === 3) {
          const dia = parseInt(partes[0]);
          const mes = parseInt(partes[1]) - 1;
          const a√±o = parseInt(partes[2]);
          
          if (!isNaN(dia) && !isNaN(mes) && !isNaN(a√±o)) {
            const fechaAlternativa = new Date(a√±o, mes, dia);
            if (!isNaN(fechaAlternativa.getTime())) {
              return fechaAlternativa.getTime();
            }
          }
        }
        
        return 0;
      } catch (e) {
        return 0;
      }
    }

    // Funci√≥n para cargar datos desde un registro seleccionado
    function cargarDatosDesdeRegistro(registro, desdeModal = false){
      registroSeleccionado = registro;
      modoNuevoRegistro = false;
      
      console.log("Cargando registro para informe:", registro);
      
      // Campos b√°sicos del veh√≠culo
      document.getElementById("marca").value = registro.Marca || "";
      document.getElementById("modelo").value = registro.Modelo || "";
      document.getElementById("patente").value = registro.Patente || registro.patente || "";
      document.getElementById("km").value = registro.Kilometraje || registro.KM || registro.km || "";
      
      // A√±o y motor solo si est√°n en el registro
      if (registro.Ano || registro.year) {
        document.getElementById("ano").value = registro.Ano || registro.year || "";
      }
      
      if (registro.Motor) {
        document.getElementById("motor").value = registro.Motor || "";
      }
      
      // Obtener OT del registro
      let otRegistro = "";
      
      if(registro.Fuente === "DatosInforme"){
        otRegistro = registro.OT || "";
        
        // Para informes anteriores, cargar los detalles espec√≠ficos
        // PERO conservar cualquier entrada manual existente
        const currentCodigo = document.getElementById("codigo_area").value;
        const currentDetalle = document.getElementById("detalle_area").value;
        const currentValor = document.getElementById("valor_area").value;
        
        // Solo reemplazar si los campos est√°n vac√≠os o casi vac√≠os
        if (!currentCodigo.trim() || currentCodigo.trim().length < 5) {
          document.getElementById("codigo_area").value = registro.Codigo || "";
        }
        
        if (!currentDetalle.trim() || currentDetalle.trim().length < 5) {
          document.getElementById("detalle_area").value = registro.Detalle || "";
        }
        
        if (!currentValor.trim()) {
          document.getElementById("valor_area").value = registro.Valor_Area || "";
        }
        
        document.getElementById("causas").value = registro.Posibles_Causas || "";
        document.getElementById("recomendaciones").value = registro.Recomendaciones || "";
        document.getElementById("valor_final").value = registro.Valor_Final || "";
        
        // Mostrar mensaje si se cargaron datos
        if (desdeModal) {
          mostrarMensajeExito("‚úÖ Datos del informe anterior cargados");
        }
        
      }else if(registro.Fuente === "Hoja1"){
        otRegistro = registro.OT || registro.OrdenTrabajo || "";
        
        // Para Hoja1 (reparaciones), solo cargar datos b√°sicos
        // NO sobreescribir contenido existente en c√≥digos/detalle/valor
        const currentDetalle = document.getElementById("detalle_area").value;
        if (!currentDetalle.trim() || currentDetalle.trim().length < 5) {
          document.getElementById("detalle_area").value = registro.Detalle_Estado || "";
        }
        
        if (desdeModal) {
          mostrarMensajeExito("‚úÖ Datos del veh√≠culo cargados. Complete el diagn√≥stico.");
        }
      }
      
      // Establecer la OT si la patente coincide
      const patenteActual = normalizarPatente(document.getElementById("patente").value);
      const patenteRegistro = normalizarPatente(registro.Patente || registro.patente || "");
      
      if(patenteActual === patenteRegistro && otRegistro){
        const otFormateada = String(otRegistro).padStart(6, "0");
        document.getElementById("otNumero").textContent = otFormateada;
        ultimaOTCalculada = otFormateada;
        console.log("OT establecida desde registro:", otFormateada);
      }
      
      cerrarModalCoincidencias();
      
      // Guardar estado actual
      saveCurrentState();
      
      // Aplicar estilos de auto-relleno
      applyAutoFillStyles(document.getElementById("detalle_area"));
      
      // Ajustar altura de textareas
      setTimeout(() => {
        autoAdjustTextareas();
      }, 100);
    }

    // Funci√≥n para mostrar OTs anteriores
    async function mostrarOTsAnteriores() {
      const patenteInput = document.getElementById("patente");
      const pat = normalizarPatente(patenteInput.value);
      
      if(!pat || pat.length < 3) {
        alert("Por favor ingrese una patente para buscar OTs anteriores");
        patenteInput.focus();
        return;
      }
      
      const cargandoElement = document.getElementById("cargando-ots");
      const listaElement = document.getElementById("lista-coincidencias");
      
      document.getElementById("modal-coincidencias").style.display = "flex";
      modalAbierto = true;
      cargandoElement.style.display = "block";
      listaElement.innerHTML = "";
      
      try {
        setTimeout(async () => {
          try {
            const timestamp = new Date().getTime();
            const response = await fetch(`${API_URL}?action=buscarPorPatente&patente=${encodeURIComponent(pat)}&t=${timestamp}`);
            const data = await response.json();

            cargandoElement.style.display = "none";

            if(!data.success || !data.registros || data.registros.length === 0) {
              listaElement.innerHTML = `<li style="text-align: center; padding: 20px; color: #666;">No se encontraron OTs anteriores para la patente ${pat}</li>`;
              return;
            }

            const registrosOrdenados = ordenarRegistrosPorFechaDesc(data.registros);
            coincidenciasEncontradas = registrosOrdenados;
            mostrarRegistrosEnModal(registrosOrdenados);
            
          } catch(error) {
            console.error("Error buscando OTs anteriores:", error);
            cargandoElement.style.display = "none";
            listaElement.innerHTML = `<li style="text-align: center; padding: 20px; color: #dc3545;">Error al buscar OTs anteriores. Intente nuevamente.</li>`;
          }
        }, 0);
        
      } catch(error) {
        console.error("Error inicial:", error);
        cargandoElement.style.display = "none";
        listaElement.innerHTML = `<li style="text-align: center; padding: 20px; color: #dc3545;">Error al buscar OTs anteriores. Intente nuevamente.</li>`;
      }
    }

    // Funci√≥n para mostrar registros en el modal
    function mostrarRegistrosEnModal(registros) {
      const lista = document.getElementById("lista-coincidencias");
      lista.innerHTML = "";
      
      registros.forEach((registro, index) => {
        const li = document.createElement("li");
        
        const fecha = registro.Fecha ? 
          (typeof registro.Fecha === 'string' ? registro.Fecha.split(' ')[0] : registro.Fecha) : 
          'Sin fecha';
        
        const ot = registro.OT || registro.OrdenTrabajo || 'N/A';
        const otFormateada = ot !== 'N/A' ? String(ot).padStart(6, "0") : 'N/A';
        const fuente = registro.Fuente === "Hoja1" ? "Hoja 1 (Reparaci√≥n)" : "Informe";
        const claseFuente = registro.Fuente === "Hoja1" ? "fuente-hoja1" : "fuente-informe";
        
        li.className = "coincidencia-item";
        
        li.innerHTML = `
          <div style="display: flex; align-items: center; justify-content: space-between;">
            <strong style="font-size: 16px;">OT: ${otFormateada}</strong> 
            <span class="fuente ${claseFuente}">${fuente}</span>
          </div>
          <div style="font-size: 14px; margin-top: 4px; color: #444;">
            <strong>Fecha:</strong> ${fecha}
          </div>
          <div style="font-size: 15px; margin-top: 6px; font-weight: bold;">
            ${registro.Marca || ''} ${registro.Modelo || ''}
          </div>
          <div style="font-size: 14px; margin-top: 4px; color: #444;">
            <strong>Patente:</strong> ${registro.Patente || registro.patente || ''}
          </div>
          ${registro.Fuente === "DatosInforme" ? `
          <div style="font-size: 13px; color: #555; margin-top: 8px; padding: 8px; background: #f0f8f0; border-radius: 4px; border-left: 4px solid #28a745;">
            <strong style="display: block; margin-bottom: 3px; color: #155724;">Informe de diagn√≥stico anterior</strong>
            ${registro.Codigo ? `<div><strong>C√≥digos:</strong> ${registro.Codigo.substring(0, 50)}${registro.Codigo.length > 50 ? '...' : ''}</div>` : ''}
          </div>
          ` : `
          <div style="font-size: 13px; color: #999; margin-top: 8px; padding: 8px; background: #f9f9f9; border-radius: 4px; border-left: 4px solid #ccc;">
            <strong style="display: block; margin-bottom: 3px; color: #666;">Reparaci√≥n anterior</strong>
            ${registro.Detalle_Estado ? `<div>${registro.Detalle_Estado.substring(0, 50)}${registro.Detalle_Estado.length > 50 ? '...' : ''}</div>` : 'Sin detalles'}
          </div>
          `}
          <div style="margin-top: 8px; padding: 6px; background: #e8f4f8; border-radius: 4px; font-size: 12px; color: #0c5460;">
            <strong>üìã Al hacer clic:</strong> Se cargar√°n los datos disponibles SIN borrar lo que ya escribi√≥
          </div>
        `;
        
        li.onclick = () => cargarDatosDesdeRegistro(registro, true);
        lista.appendChild(li);
      });
      
      const botonCrearNuevo = document.querySelector('.boton-crear-nuevo');
      if (botonCrearNuevo) {
        botonCrearNuevo.textContent = `Crear Nueva OT (${registros.length} existentes)`;
      }
    }

    // Funci√≥n para mostrar modal con coincidencias
    function mostrarModalCoincidencias(registros){
      const registrosOrdenados = ordenarRegistrosPorFechaDesc(registros);
      const lista = document.getElementById("lista-coincidencias");
      lista.innerHTML = "";
      
      document.getElementById("cargando-ots").style.display = "none";
      mostrarRegistrosEnModal(registrosOrdenados);
      
      document.getElementById("modal-coincidencias").style.display = "flex";
      modalAbierto = true;
    }

    // Cerrar modal
    function cerrarModalCoincidencias(){
      document.getElementById("modal-coincidencias").style.display = "none";
      modalAbierto = false;
      coincidenciasEncontradas = [];
    }

    // Crear nueva OT desde el modal
    function crearNuevaOTDesdeModal(){
      const datosVehiculo = obtenerDatosVehiculoDesdeCoincidencias();
      const patenteActual = document.getElementById("patente").value.trim();
      
      document.getElementById("marca").value = datosVehiculo.marca || "";
      document.getElementById("modelo").value = datosVehiculo.modelo || "";
      
      if (datosVehiculo.patente && !patenteActual) {
        document.getElementById("patente").value = datosVehiculo.patente;
      }
      
      // NO limpiar otros campos - el usuario ya pudo haber escrito algo
      // Solo limpiar si est√°n vac√≠os
      if (!document.getElementById("ano").value.trim()) {
        document.getElementById("ano").value = "";
      }
      
      if (!document.getElementById("km").value.trim()) {
        document.getElementById("km").value = "";
      }
      
      if (!document.getElementById("motor").value.trim()) {
        document.getElementById("motor").value = "";
      }
      
      modoNuevoRegistro = true;
      registroSeleccionado = null;
      
      cargarSiguienteOT();
      saveCurrentState();
      
      mostrarMensajeExito("‚úÖ Nueva OT creada. Complete el diagn√≥stico.");
      
      cerrarModalCoincidencias();
      
      setTimeout(() => {
        if (!document.getElementById("ano").value.trim()) {
          document.getElementById("ano").focus();
        }
      }, 300);
    }

    // Obtener datos del veh√≠culo desde coincidencias
    function obtenerDatosVehiculoDesdeCoincidencias() {
      if (!coincidenciasEncontradas || coincidenciasEncontradas.length === 0) {
        return { marca: "", modelo: "", patente: "" };
      }
      
      const primerRegistro = coincidenciasEncontradas[0];
      
      return {
        marca: primerRegistro.Marca || "",
        modelo: primerRegistro.Modelo || "",
        patente: primerRegistro.Patente || primerRegistro.patente || ""
      };
    }

    // Funci√≥n para mostrar mensaje de √©xito
    function mostrarMensajeExito(mensaje, tipo = "success") {
      const mensajeElement = document.getElementById("mensajeExito");
      mensajeElement.textContent = mensaje;
      
      if (tipo === "warning") {
        mensajeElement.style.background = "#ffc107";
        mensajeElement.style.color = "#212529";
      } else {
        mensajeElement.style.background = "#28a745";
        mensajeElement.style.color = "white";
      }
      
      mensajeElement.style.display = "block";
      
      setTimeout(() => {
        mensajeElement.style.display = "none";
      }, 3000);
    }

    // Recolectar datos para guardar en la nueva estructura
    function recogerDatosInforme(){
      const otActual = document.getElementById("otNumero").textContent.trim();
      const patente = normalizarPatente(document.getElementById("patente").value);
      
      return {
        funcion: "guardar_informe",
        OT: otActual,
        patente: patente,
        codigo: document.getElementById("codigo_area").value.trim(),
        detalle: document.getElementById("detalle_area").value.trim(),
        marca: document.getElementById("marca").value.trim().toUpperCase(),
        modelo: document.getElementById("modelo").value.trim().toUpperCase(),
        ano: document.getElementById("ano").value.trim(),
        km: document.getElementById("km").value.trim(),
        motor: document.getElementById("motor").value.trim(),
        valor_area: document.getElementById("valor_area").value.trim(),
        posibles_causas: document.getElementById("causas").value.trim(),
        recomendaciones: document.getElementById("recomendaciones").value.trim(),
        valor_final: document.getElementById("valor_final").value.trim()
      };
    }

    // Funci√≥n para guardar en Google Sheets con la nueva estructura
    async function guardarEnGoogleSheetsYImprimir() {
      const datos = recogerDatosInforme();
      
      if(!datos.patente || datos.patente.length < 3){
        alert("Por favor ingrese una patente v√°lida");
        return;
      }
      
      if(!datos.codigo.trim() && !datos.detalle.trim()){
        if(!confirm("No ha ingresado c√≥digos ni detalles del diagn√≥stico. ¬øDesea continuar de todos modos?")){
          return;
        }
      }
      
      try{
        const formData = new URLSearchParams();
        for (const key in datos) {
          formData.append(key, datos[key]);
        }
        
        const response = await fetch(API_URL, {
          method: "POST",
          mode: 'no-cors',
          headers: { 
            "Content-Type": "application/x-www-form-urlencoded"
          },
          body: formData.toString()
        });
        
        alert(`‚úÖ Informe de diagn√≥stico guardado\n\nOT: ${datos.OT}\nPatente: ${datos.patente}\nMarca: ${datos.marca}\nModelo: ${datos.modelo}\n\nEl informe se ha guardado en DatosInforme.`);
        
        // Generar nueva OT para el siguiente informe
        setTimeout(async () => {
          await cargarSiguienteOT();
          saveCurrentState();
        }, 1000);
        
        // Imprimir el formulario
        setTimeout(() => {
          window.print();
        }, 500);
        
        modoNuevoRegistro = true;
        registroSeleccionado = null;
        ultimaPatenteBuscada = "";
        
      }catch(error){
        console.error("Error guardando:", error);
        alert("‚ö†Ô∏è Se produjo un error al guardar, pero puede imprimir el informe.");
        window.print();
      }
    }

    // Borrar todo el formulario
    function borrarTodo(){
      if(!confirm("¬øEst√° seguro de borrar todos los datos del formulario?")) return;
      
      const campos = [
        "marca", "modelo", "patente", "ano", 
        "km", "motor", "codigo_area", "detalle_area", 
        "valor_area", "causas", "recomendaciones", "valor_final"
      ];
      
      campos.forEach(id => {
        const element = document.getElementById(id);
        if(element) element.value = "";
      });
      
      modoNuevoRegistro = true;
      registroSeleccionado = null;
      ultimaPatenteBuscada = "";
      
      cargarSiguienteOT();
      setFechaHoy();
      saveCurrentState();
      
      console.log("Formulario borrado, modo nuevo registro activado");
      
      // Resetear altura de textareas
      setTimeout(() => {
        ['codigo_area', 'detalle_area', 'valor_area'].forEach(id => {
          const el = document.getElementById(id);
          if (el) {
            el.style.height = '200px';
          }
        });
      }, 100);
    }

    // Verificar y actualizar OT autom√°ticamente
    function verificarYActualizarOT(){
      const patente = document.getElementById("patente").value.trim();
      if(modoNuevoRegistro && (!patente || patente.length < 3)){
        cargarSiguienteOT();
      }
    }

    // Event listeners para b√∫squeda autom√°tica
    let timeoutBusqueda = null;

    document.getElementById("patente").addEventListener("input", function(){
      if (timeoutBusqueda) {
        clearTimeout(timeoutBusqueda);
      }
      
      timeoutBusqueda = setTimeout(() => {
        if(this.value.trim().length >= 3){
          modoNuevoRegistro = true;
          registroSeleccionado = null;
          buscarPorPatente();
        }
      }, 500);
    });

    document.getElementById("patente").addEventListener("blur", function(){
      if(this.value.trim().length >= 3){
        buscarPorPatente();
      }
    });

    // Evento para actualizar fecha cada minuto
    setInterval(() => {
      setFechaHoy();
    }, 60000);

    // Verificar OT peri√≥dicamente
    setInterval(() => {
      if(modoNuevoRegistro){
        verificarYActualizarOT();
      }
    }, 30000);

    // Inicializar al cargar
    window.addEventListener('load', () => {
      setFechaHoy();
      cargarSiguienteOT();
      setupAutoSave();
      setupAutoAdjustTextareas();
      
      console.log("P√°gina de diagn√≥stico cargada, modo nuevo registro activado");
      
      setTimeout(() => {
        verificarYActualizarOT();
        autoAdjustTextareas();
      }, 1000);
    });
  </script>

  <!-- ====== Funci√≥n para buscar aplicaci√≥n ====== -->
  <script>
    function buscarAplicacion() {
      guardarInformeLocal();
      sessionStorage.setItem('viene_de_busqueda', 'true');

      const url = "https://taller-todo.vercel.app/buscar_aplicacion.html";
      window.open(url, "_blank", "noopener");
    }

    function guardarInformeLocal() {
      const datos = recogerDatosInforme();
      localStorage.setItem('informe_autoguardado', JSON.stringify(datos));
      localStorage.setItem('informe_autoguardado_timestamp', Date.now().toString());
    }
    
    function cargarInformeLocal() {
      const guardado = localStorage.getItem('informe_autoguardado');
      if (guardado) {
        try {
          const datos = JSON.parse(guardado);
          const timestamp = parseInt(localStorage.getItem('informe_autoguardado_timestamp') || '0');
          const horasTranscurridas = (Date.now() - timestamp) / (1000 * 60 * 60);
          
          if (horasTranscurridas < 2) {
            document.getElementById("marca").value = datos.marca || '';
            document.getElementById("modelo").value = datos.modelo || '';
            document.getElementById("patente").value = datos.patente || '';
            document.getElementById("ano").value = datos.ano || '';
            document.getElementById("km").value = datos.km || '';
            document.getElementById("motor").value = datos.motor || '';
            document.getElementById("codigo_area").value = datos.codigo || '';
            document.getElementById("detalle_area").value = datos.detalle || '';
            document.getElementById("valor_area").value = datos.valor_area || '';
            document.getElementById("causas").value = datos.posibles_causas || '';
            document.getElementById("recomendaciones").value = datos.recomendaciones || '';
            document.getElementById("valor_final").value = datos.valor_final || '';
            
            if (datos.OT) {
              document.getElementById("otNumero").textContent = datos.OT;
              ultimaOTCalculada = datos.OT;
            }
          }
        } catch (e) {
          console.error("Error al cargar informe guardado:", e);
        }
      }
    }
    
    function agregarProductoSeleccionado() {
      const productoGuardado = localStorage.getItem('producto_seleccionado');
      if (productoGuardado) {
        try {
          const producto = JSON.parse(productoGuardado);
          
          const valorArea = document.getElementById("valor_area");
          const precio = producto.precio_unit ? parseFloat(producto.precio_unit) : 0;
          const nuevoValor = `${producto.nombre || 'Producto'} - $${precio.toLocaleString('es-CL')}`;
          
          if (valorArea.value.trim()) {
            valorArea.value = valorArea.value + '\n' + nuevoValor;
          } else {
            valorArea.value = nuevoValor;
          }
          
          localStorage.removeItem('producto_seleccionado');
          
          valorArea.style.height = 'auto';
          valorArea.style.height = (valorArea.scrollHeight + 2) + 'px';
          
        } catch (e) {
          console.error("Error al procesar producto seleccionado:", e);
          localStorage.removeItem('producto_seleccionado');
        }
      }
    }
    
    window.addEventListener('load', function() {
      const vieneDeBusqueda = sessionStorage.getItem('viene_de_busqueda') === 'true';
      
      if (vieneDeBusqueda) {
        sessionStorage.removeItem('viene_de_busqueda');
        cargarInformeLocal();
        setTimeout(agregarProductoSeleccionado, 300);
      }
    });
  </script>

  <!-- ====== Autorrelleno de DETALLE por c√≥digos ====== -->
  <script>
    const CODIGOS_BASE = {
      "P252F": "Nivel de aceite muy alto",
      "P0420": "Eficiencia del sistema de catalizador por debajo del umbral (Banco 1)",
      "P0171": "Sistema demasiado pobre (Banco 1)",
      "P0300": "Falla de encendido aleatoria o m√∫ltiple",
      "P0113": "Sensor de temperatura del aire de admisi√≥n - entrada alta",
      "P0340": "Circuito del sensor de posici√≥n del √°rbol de levas - mal funcionamiento",
      "P0335": "Sensor de posici√≥n del cig√ºe√±al - circuito defectuoso",
      "P0128": "Termostato del refrigerante - temperatura de funcionamiento por debajo del regulado",
      "P0172": "Sistema demasiado rico (Banco 1)",
      "P0011": "Posici√≥n del √°rbol de levas A - tiempo adelantado o rendimiento del sistema (Banco 1)",
      "P0016": "Sensor de posici√≥n del cig√ºe√±al - correlaci√≥n con el √°rbol de levas (Banco 1)",
      "P0102": "Sensor MAF - entrada baja",
      "P0135": "Sensor de ox√≠geno (Banco 1 Sensor 1) - calentador - mal funcionamiento del circuito",
      "P0299": "Presi√≥n del turbo/sobrealimentador por debajo del l√≠mite",
      "P0301": "Fallo de encendido del cilindro 1",
      "P0401": "Flujo insuficiente en el sistema EGR",
      "P0430": "Eficiencia del sistema de catalizador por debajo del umbral (Banco 2)",
      "P0087": "Presi√≥n de combustible/ra√≠l - demasiado baja",
      "P0101": "Sensor MAF - rango/rendimiento",
      "P0141": "Sensor de ox√≠geno (Banco 1 Sensor 2) - calentador - mal funcionamiento del circuito",
      "P0100": "Mal funcionamiento del circuito de sensor MAF o volumen de air.",
      "P0101": "Rango o rendimiento del sensor MAF fuera de especificaci√≥n.",
      "P0102": "Sensor MAF ‚Äì se√±al baja de entrada.",
      "P0106": "Sensor MAP/ABS ‚Äì rango o rendimiento fuera de especificaci√≥n.",
      "P0107": "Sensor MAP/ABS ‚Äì se√±al baja.",
      "P0108": "Sensor MAP/ABS ‚Äì se√±al alta.",
      "P0110": "Mal funcionamiento del circuito del sensor de temperatura del aire de admisi√≥n.",
      "P0113": "Sensor de temperatura del aire de admisi√≥n ‚Äì se√±al alta de entrada.",
      "P0118": "Sensor de temperatura del refrigerante del motor ‚Äì se√±al alta de entrada.",
      "P0120": "Sensor de posici√≥n del acelerador A ‚Äì mal funcionamiento de circuito.",
      "P0121": "Sensor de posici√≥n del acelerador A ‚Äì rango/rendimiento fuera de especificaci√≥n.",
      "P0122": "Sensor de posici√≥n del acelerador A ‚Äì se√±al baja.",
      "P0123": "Sensor de posici√≥n del acelerador A ‚Äì se√±al alta.",
      "P0128": "La temperatura del refrigerante est√° por debajo del rango regulado por el termostato.",
      "P0130": "Mal funcionamiento del circuito del sensor de O‚ÇÇ (Banco 1, sensor 1).",
      "P0131": "Sensor de O‚ÇÇ Banco 1, sensor 1 ‚Äì bajo voltage.",
      "P0132": "Sensor de O‚ÇÇ Banco 1, sensor 1 ‚Äì alto voltage.",
      "P0134": "Sensor de O‚ÇÇ Banco 1, sensor 1 ‚Äì sin actividad.",
      "P0135": "Mal funcionamiento del calentador del sensor de O‚ÇÇ (Banco 1, sensor 1).",
      "P0136": "Mal funcionamiento del circuito del sensor de O‚ÇÇ (Banco 1, sensor 2).",
      "P0137": "Sensor de O‚ÇÇ Banco 1, sensor 2 ‚Äì bajo voltage.",
      "P0138": "Sensor de O‚ÇÇ Banco 1, sensor 2 ‚Äì alto voltage.",
      "P0141": "Mal funcionamiento del calentador del sensor de O‚ÇÇ (Banco 1, sensor 2).",
      "P0171": "Sistema demasiado pobre (Banco 1).",
      "P0172": "Sistema demasiado rico (Banco 1).",
      "P0174": "Sistema demasiado pobre (Banco 2).",
      "P0200": "Mal funcionamiento del circuito del inyector de combustible (rango 0200-0299).",
      "P0234": "Turbo/sobrealimentador ‚Äì presi√≥n excesiva detectada.",
      "P0299": "Turbo/sobrealimentador ‚Äì rendimiento/nivel bajo.",
      "P0300": "Fallo de encendido aleatorio/m√∫ltiple cilindros detectado.",
      "P0301": "Fallo de encendido en el cilindro 1.",
      "P0302": "Fallo de encendido en el cilindro 2.",
      "P0303": "Fallo de encendido en el cilindro 3.",
      "P0304": "Fallo de encendido en el cilindro 4.",
      "P0305": "Fallo de encendido en el cilindro 5.",
      "P0306": "Fallo de encendido en el cilindro 6.",
      "P0307": "Fallo de encendido en el cilindro 7.",
      "P0308": "Fallo de encendido en el cilindro 8.",
      "P0321": "Sensor knock ‚Äì rango/rendimiento fuera de especificaci√≥n.",
      "P0325": "Sensor knock ‚Äì mal funcionamiento del circuito (Banco 1).",
      "P0328": "Sensor knock ‚Äì se√±al alta (Banco 1 o sensor √∫nico).",
      "P0335": "Mal funcionamiento del circuito del sensor de posici√≥n del cig√ºe√±al (CKP).",
      "P0340": "Mal funcionamiento del circuito del sensor de posici√≥n del √°rbol de levas (CMP).",
      "P0341": "Anomal√≠a en comparaci√≥n CKP/CMP detectada.",
      "P0400": "Mal funcionamiento del sistema de recirculaci√≥n de gases de escape (EGR) ‚Äì flujo insuficiente.",
      "P0401": "Flujo EGR insuficiente detectado.",
      "P0402": "Flujo EGR excesivo detectado.",
      "P0403": "Mal funcionamiento del circuito del sensor EGR.",
      "P0440": "Mal funcionamiento del sistema de control de emisiones evaporativas (EVAP).",
      "P0441": "Fuga del sistema EVAP detectada (fuga peque√±a o intermedia).",
      "P0442": "Fuga peque√±a del sistema EVAP detectada.",
      "P0443": "Circuito de control EVAP-VSV mal funcionando.",
      "P0444": "Circuito del sensor EVAP mal funcionamiento.",
      "P0446": "Mal funcionamiento del control del sistema EVAP.",
      "P0449": "Circuito VSV EVAP intermitente o rango/rendimiento fuera especificaci√≥n.",
      "P0480": "Mal funcionamiento del circuito del controlador de ventilador de refrigeraci√≥n.",
      "P0496": "Eficiencia del sistema de ventilador de refrigeraci√≥n por debajo del umbral.",
      "P0500": "Sensor de velocidad del veh√≠culo ‚Äì mal funcionamiento del circuito.",
      "P0501": "Rango/rendimiento del sensor de velocidad del veh√≠culo fuera de especificaci√≥n.",
      "P0504": "Mal funcionamiento del circuito del sensor de corte del rantal√≠.",
      "P0505": "Relaci√≥n rantal√≠ ‚Äì fuera de rango.",
      "P0507": "Vac√≠o excesivo en el rantal√≠ detectado.",
      "P0521": "Mal funcionamiento del circuito del sensor de presi√≥n de aceite.",
      "P0562": "Voltaje del sistema insuficiente (ECU principal).",
      "P0606": "Mal funcionamiento del microprocesador de ECM.",
      "P0700": "Mal funcionamiento gen√©rico del control de la transmisi√≥n (TCM).",
      "P0705": "Interruptor de neutro/seguridad ‚Äì mal funcionamiento del circuito.",
      "P0715": "Sensor de velocidad de entrada (transmisi√≥n) ‚Äì circuito intermitente o mal funcionamiento.",
      "P0718": "Sensor de velocidad/turbina ‚Äì circuito intermitente.",
      "P0720": "Sensor de velocidad de salida ‚Äì mal funcionamiento del circuito.",
      "P0722": "Sensor de velocidad de salida ‚Äì se√±al baja o rango fuera especificaci√≥n.",
      "P0741": "Control de presi√≥n del convertidor (presi√≥n de torque) ‚Äì rendimiento fuera de rango.",
      "P0753": "Interruptor/conjunto del cambio de la transmisi√≥n ‚Äì posici√≥n intermitente o rango fuera especificaci√≥n.",
      "P0046": "Mal funcionamiento del sistema de sobrealimentaci√≥n / presi√≥n residual del turbo.",
      "P0093": "Fuga grande del sistema de combustible detectada.",
      "P0087": "Presi√≥n de rail de combustible se√±al baja.",
      "P0088": "Presi√≥n de rail de combustible se√±al alta.",
      "P0090": "Sensor de presi√≥n de combustible mal funcionamiento del circuito.",
      "P0098": "Sensor de temperatura de aire de admisi√≥n 2 se√±al alta.",
      "P0110": "Mal funcionamiento del circuito del sensor de temperatura de aire de admisi√≥n.",
      "P0115": "Mal funcionamiento del circuito del sensor de temperatura del refrigerante del motor.",
      "P0117": "Sensor de temperatura del refrigerante se√±al baja.",
      "P0191": "Sensor de presi√≥n de combusti√≥n rango/performance fuera especificaci√≥n.",
      "P0201-P0204": "Circuito del inyector de combustible mal funcionamiento en cilindros 1 y4.",
      "P0222": "Sensor de posici√≥n del acelerador B se√±al baja.",
      "P0223": "Sensor de posici√≥n del acelerador B ‚Äì se√±al alta.",
      "P0238": "Sensor de presi√≥n turbo ‚Äì rango/performance fuera especificaci√≥n.",
      "P0315": "Valores del sistema de posici√≥n del cig√ºe√±al no almacenados.",
      "P0320": "Mal funcionamiento en la se√±al de velocidad del distribuidor/encendido.",
      "P0336": "Sensor knock ‚Äì bajo voltage (Banco 2).",
      "P0342": "Sensor CMP ‚Äì se√±al baja o rango fuera especificaci√≥n.",
      "P0351-P0354": "Bobina de encendido ‚Äì mal funcionamiento del circuito (cilindros 1-4).",
      "P0380": "Circuito del calentador del sensor de posici√≥n del cig√ºe√±al (CKP).",
      "P0410": "Sistema de aire secundario ‚Äì mal funcionamiento.",
      "P0463": "Sensor de temperatura de combustible ‚Äì se√±al fuera de rango.",
      "P0481": "Circuito de controlador del ventilador de refrigeraci√≥n ‚Äì intermitente.",
      "P0506": "Control de rantal√≠ ‚Äì rango fuera especificaci√≥n.",
      "P0522": "Sensor de presi√≥n de aceite ‚Äì rango/performance fuera especificaci√≥n.",
      "P0603": "Mal funcionamiento en el circuito de memoria ECM.",
      "P0607": "Mal funcionamiento del circuito de ECT (temperatura de refrigerante).",
      "P0641": "Voltaje del sensor/calibraci√≥n ‚Äì l√≠nea baja.",
      "P0670": "Circuito del sensor de buj√≠a incandescente ‚Äì mal funcionamiento.",
      "P0683": "Circuito del rel√© de encendido (ECM/PCM) ‚Äì mal funcionamiento.",
      "P0717": "Sensor de velocidad de entrada ‚Äì rango/performance fuera especificaci√≥n.",
      "P0722": "Sensor de velocidad de salida ‚Äì se√±al baja/performance fuera especificaci√≥n.",
      "P0730": "Relaci√≥n de engranaje incorrecta.",
      "P0740": "Solenoide de control de torque ‚Äì mal funcionamiento del circuito.",
      "P0753": "Switch cambio/transmisi√≥n mal intermitente.",
      "P0990": "Circuito del sistema de infoentretenimiento/diagn√≥stico extendido (vehicle-specific)."
    };

    const txtCodigos = document.getElementById("codigo_area");
    const txtDetalle = document.getElementById("detalle_area");
    const RE_CODIGO = /^[PBCU]\d{4}$/;
    const normalizar = s => s.toUpperCase().trim().replace(/[^A-Z0-9]/g, "");
    const codigosDe = (input) => Array.from(new Set(
      input.toUpperCase().split(/[\s,;]+/).map(normalizar).filter(c => RE_CODIGO.test(c))
    ));
    const esLineaAuto = (l) => /^‚Ä¢\s+.+/.test(l.trim()) && !/^[PBCU]\d{4}/.test(l.trim());
    const construirLineasAutoSoloDescripcion = (codigos) => codigos.filter(c => CODIGOS_BASE[c]).map(c => `‚Ä¢ ${CODIGOS_BASE[c]}`);

    function mezclarDetalleSoloDescripcion() {
      const cods = codigosDe(txtCodigos.value);
      const nuevasAuto = construirLineasAutoSoloDescripcion(cods);
      const lineas = txtDetalle.value.split(/\r?\n/);
      
      // Separar l√≠neas manuales de autom√°ticas
      const manual = lineas.filter(l => !esLineaAuto(l) && l.trim() !== "");
      const auto = lineas.filter(l => esLineaAuto(l) && l.trim() !== "");
      
      // Combinar nuevas autom√°ticas con las existentes (sin duplicados)
      const todasAuto = [...new Set([...auto, ...nuevasAuto])];
      
      // Mantener las l√≠neas manuales siempre
      const resultado = [...todasAuto];
      if (manual.length > 0) {
        // Agregar separador solo si hay contenido autom√°tico
        if (todasAuto.length > 0) {
          resultado.push("");
        }
        resultado.push(...manual);
      }
      
      txtDetalle.value = resultado.join("\n");
      
      // Ajustar altura
      txtDetalle.style.height = 'auto';
      txtDetalle.style.height = (txtDetalle.scrollHeight + 2) + 'px';
      
      // Marcar como contenido autom√°tico
      if (nuevasAuto.length > 0) {
        txtDetalle.classList.add('auto-entry');
      }
    }
    
    // Configurar el auto-relleno con protecci√≥n de contenido manual
    txtCodigos.addEventListener("input", () => {
      clearTimeout(window.__debAutoTimer);
      
      // Solo activar auto-relleno si hay nuevos c√≥digos
      const currentCodes = codigosDe(txtCodigos.value);
      if (currentCodes.length > 0) {
        window.__debAutoTimer = setTimeout(mezclarDetalleSoloDescripcion, 300);
      }
    });
    
    // Marcar contenido manual cuando el usuario escribe en detalle
    txtDetalle.addEventListener("input", function() {
      this.classList.add('manual-entry');
      this.classList.remove('auto-entry');
    });
  </script>

  <!-- ====== Librer√≠as: QR / compresi√≥n / PDF local ====== -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" referrerpolicy="no-referrer"></script>

  <!-- ====== Modal QR ====== -->
  <div id="qr-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); align-items:center; justify-content:center; z-index:99998;">
    <div style="background:#fff; width:min(92vw,420px); border:1px solid #000; border-radius:10px; padding:18px; box-shadow:0 4px 0 #000; text-align:center;">
      <h3 style="margin:0 0 10px">Escanea para descargar el PDF</h3>
      <div id="qr-box" style="display:flex; justify-content:center; margin:10px 0;"></div>
      <div style="word-break:break-all; font-size:12px; margin:8px 0;"><a id="qr-link" href="#" target="_blank" rel="noopener"></a></div>
      <div style="display:flex; gap:8px; justify-content:center; margin-top:8px;">
        <button onclick="navigator.clipboard.writeText(document.getElementById('qr-link').href)">Copiar link</button>
        <button onclick="document.getElementById('qr-modal').style.display='none'">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- ====== Botonera flotante ====== -->
  <div class="fab">
    <button onclick="mostrarOTsAnteriores()" class="boton-ots-anteriores">üìã OTs anteriores</button>
    <button onclick="guardarEnGoogleSheetsYImprimir()" class="boton-imprimir">üñ®Ô∏è Imprimir y Guardar</button>
    <button onclick="descargarPDFLocal()" class="boton-pdf">üìÑ Descargar PDF</button>
    <button onclick="generarQRDeDescargaPDF()" class="boton-qr">üì≤ Mostrar QR</button>
    <button onclick="buscarAplicacion()" class="boton-buscar-aplicacion">üîç Buscar aplicaci√≥n</button>
    <button onclick="borrarTodo()" class="boton-borrar">üßπ Borrar todo</button>
  </div>

  <!-- ====== L√≥gica QR + Descarga PDF local ====== -->
  <script>
    function construirLinkDescarga(datos){
      const packed = LZString.compressToEncodedURIComponent(JSON.stringify(datos));
      const base = location.href.substring(0, location.href.lastIndexOf('/') + 1);
      return base + 'informe_dl.html#' + packed;
    }

    function mostrarQr(url){
      const link = document.getElementById('qr-link');
      const box = document.getElementById('qr-box');
      link.textContent = url; link.href = url; box.innerHTML = "";
      new QRCode(box, { text: url, width: 220, height: 220 });
      document.getElementById('qr-modal').style.display = 'flex';
    }

    function generarQRDeDescargaPDF(){
      mostrarQr(construirLinkDescarga(recogerDatosInforme()));
    }

    function waitImagesLoaded(container){
      const imgs = Array.from(container.querySelectorAll('img'));
      if (!imgs.length) return Promise.resolve();
      return Promise.all(imgs.map(img => img.complete ? Promise.resolve() :
        new Promise(res => { img.onload = res; img.onerror = res; })));
    }

    async function descargarPDFLocal(){
      const paper = document.getElementById('paper');
      const fab = document.querySelector('.fab');
      const prev = fab.style.display; fab.style.display = 'none';
      await waitImagesLoaded(paper);

      const patente = (document.getElementById('patente').value || 'SIN_PATENTE')
                      .toUpperCase().replace(/\s+/g,'');
      const opt = {
        filename: `Informe_Diagnostico_${patente}_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.pdf`,
        margin: 0,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'mm', format: 'letter', orientation: 'portrait' }
      };
      try{
        await html2pdf().set(opt).from(paper).save();
      } finally {
        fab.style.display = prev || '';
      }
    }
  </script>
</body>
</html>
