<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Paso 3 ¬∑ Drenaje</title>

  <style>
    :root{
      --brand:#900000;
      --ink:#e9ecef;
      --muted:#b9c0c7;
      --bg:#0b0b0c;
      --panel:#0f0f11;
      --card:#16181b;
      --card-border:#272a2f;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;
      background:var(--bg);
      color:var(--ink);
    }
    .topbar{
      background:#000;color:#fff;text-align:center;
      padding:14px;border-bottom:4px solid var(--brand);
      font-weight:700;
    }
    .wrapper{max-width:900px;margin:24px auto;padding:0 12px;}
    .frame{border:3px solid var(--brand);border-radius:var(--radius);padding:20px;background:var(--panel);}
    .header{background:var(--brand);padding:18px;border-radius:14px;text-align:center;}
    .header h1{margin:0}
    .card{background:var(--card);border:1px solid var(--card-border);border-radius:14px;padding:16px;margin-top:20px;}

    .check{
      display:flex;align-items:center;gap:12px;
      background:#0c0c0e;padding:12px;border-radius:10px;margin-bottom:12px;
    }
    .check input{transform:scale(1.3)}
    .check label{flex:1}

    select,textarea{
      width:100%;margin-top:10px;padding:12px;border-radius:10px;
      background:#0c0c0e;color:#fff;border:1px solid #333;font-size:16px;
    }

    .error{display:none;margin-top:12px;color:#ffb3b3}

    .btn{
      margin-top:20px;width:100%;min-height:48px;
      border-radius:12px;border:2px solid var(--brand);
      background:#0c0c0e;color:#fff;font-weight:800;cursor:pointer;
    }
    .btn:hover{background:var(--brand);}
  </style>
</head>

<body>

<div class="topbar">WWW.ELSE√ëORDELOSESCANER.CL</div>

<div class="wrapper">
  <div class="frame">

    <div class="header">
      <h1>üõ¢Ô∏è Paso 3 ¬∑ Drenaje del aceite</h1>
    </div>

    <div class="card">

      <div class="check">
        <input type="checkbox" id="temp">
        <label for="temp">Motor a temperatura de trabajo</label>
      </div>

      <div class="check">
        <input type="checkbox" id="tapon">
        <label for="tapon">Tap√≥n del c√°rter retirado</label>
      </div>

      <div class="check">
        <input type="checkbox" id="drenado">
        <label for="drenado">Aceite drenado completamente</label>
      </div>

      <label>Estado del tap√≥n / arandela</label>
      <select id="estado_tapon">
        <option value="">Seleccionar‚Ä¶</option>
        <option>Bueno</option>
        <option>Gastado</option>
        <option>Reemplazado</option>
        <option>Da√±ado</option>
      </select>

      <textarea id="obs" placeholder="Observaciones (opcional)"></textarea>

      <div id="error" class="error">
        ‚ùå Debes completar los pasos y seleccionar el estado del tap√≥n.
      </div>

      <button class="btn" onclick="guardarPaso()">Guardar y continuar</button>

    </div>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxEYzoxATV0Cqn6zpug6PPTBRyO62XToCtEhk2F_Hgrq9v99f8zZr473PB6j_5v8e1qwA/exec";
const id = sessionStorage.getItem("aceite_id");

async function apiGet(p){
  const r = await fetch(API_URL + "?" + new URLSearchParams(p));
  return r.json();
}

async function guardarPaso(){
  try{
    if(!id){
      alert("Sesi√≥n perdida.");
      location.href="aceite_nuevo.html";
      return;
    }

    const ok = temp.checked && tapon.checked && drenado.checked;
    const estado = estado_tapon.value;
    const obs = document.getElementById("obs").value.trim();

    if(!ok || !estado){
      error.style.display="block";
      return;
    }

    await apiGet({
      action: "actualizar_servicio",
      id_servicio: id,
      p3_motor_temperatura_ok: temp.checked ? "SI" : "NO",
      p3_tapon_retirado: tapon.checked ? "SI" : "NO",
      p3_drenado_completo: drenado.checked ? "SI" : "NO",
      p3_estado_tapon: estado,
      p3_observaciones: obs
    });

    location.href="aceite_paso4.html";

  }catch(e){
    console.error(e);
    alert("Error de conexi√≥n con la API");
  }
}
</script>

</body>
</html>
