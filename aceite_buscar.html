<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Buscar cambios de aceite</title>

<style>
:root{
  --brand:#900000;--ink:#e9ecef;--muted:#b9c0c7;
  --bg:#0b0b0c;--panel:#0f0f11;--card:#16181b;
  --card-border:#272a2f;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui;background:var(--bg);color:var(--ink)}
.topbar{background:#000;color:#fff;text-align:center;padding:14px;border-bottom:4px solid var(--brand);font-weight:700}
.wrapper{max-width:1000px;margin:24px auto;padding:0 12px}
.frame{border:3px solid var(--brand);border-radius:16px;padding:20px;background:var(--panel)}
.header{background:var(--brand);padding:18px;border-radius:14px;text-align:center}
.card{background:var(--card);border:1px solid var(--card-border);border-radius:14px;padding:16px;margin-top:16px}

input{
  width:100%;padding:14px;border-radius:10px;
  background:#0c0c0e;color:#fff;border:1px solid #333;
  font-size:16px;text-transform:uppercase
}
.btn{
  margin-top:12px;width:100%;min-height:48px;
  border-radius:12px;border:2px solid var(--brand);
  background:#0c0c0e;color:#fff;font-weight:800;cursor:pointer
}
.btn:hover{background:var(--brand)}
.btn-sec{
  margin-top:10px;background:#111;border:1px solid #444
}

.resultado{
  display:flex;justify-content:space-between;align-items:center;
  padding:14px;border-radius:12px;border:1px solid #333;
  margin-bottom:12px;background:#111;
}
.resultado.destacado{
  border:2px solid var(--brand);
  background:#1a0000;
}
.info{display:flex;flex-direction:column}
.fecha{font-weight:800}
.km{color:var(--muted);font-size:14px}
.badge{
  background:var(--brand);color:#fff;font-size:12px;
  padding:2px 8px;border-radius:20px;margin-top:6px;width:max-content
}
.link{color:#9fd0ff;cursor:pointer;font-weight:700;text-decoration:underline}
.muted{color:var(--muted)}
</style>
</head>

<body>

<div class="topbar">WWW.ELSE√ëORDELOSESCANER.CL</div>

<div class="wrapper">
<div class="frame">

<div class="header">
  <h1>üîç Buscar cambios de aceite</h1>
</div>

<div class="card">
  <input id="patente" placeholder="ABCD12">
  <button class="btn" onclick="buscar()">Buscar</button>
  <button class="btn btn-sec" onclick="volver()">‚¨Ö Volver al men√∫</button>
</div>

<div id="resultados" class="card" style="display:none"></div>

</div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyJvXWcFMSY3EFXeip7vdesod6ExMTV_Ubb1auUN2VIDJ5_jMK8nkvwpppdgiBmtl8b/exec";

/* =========================
   UTILIDADES
========================= */
function fechaValida(v){
  if(!v) return "‚Äî";
  const d = new Date(v);
  if(isNaN(d.getTime())) return "‚Äî";
  return d.toLocaleDateString("es-CL");
}

function calcularProximoKm(kmActual, proximoGuardado){
  kmActual = Number(kmActual);
  proximoGuardado = Number(proximoGuardado);

  if(isNaN(kmActual)) return "‚Äî";

  // üëâ si NO viene guardado desde la API
  if(isNaN(proximoGuardado) || proximoGuardado === 0){
    return kmActual + 10000;
  }

  // üëâ si el n√∫mero guardado es menor al km actual
  if(proximoGuardado <= kmActual){
    return kmActual + proximoGuardado;
  }

  // üëâ si ya es un km absoluto correcto
  return proximoGuardado;
}

async function apiGet(p){
  const r = await fetch(API_URL + "?" + new URLSearchParams(p));
  return r.json();
}

/* =========================
   BUSCAR
========================= */
async function buscar(){
  const input = document.getElementById("patente");
  const patente = input.value.trim().toUpperCase();
  input.value = patente;

  if(!patente){
    alert("Ingresa una patente");
    return;
  }

  const r = await apiGet({ action:"buscar_por_patente", patente });
  const box = document.getElementById("resultados");
  box.style.display = "block";

  if(!r || !r.length){
    box.innerHTML = "<div class='muted'>Sin resultados</div>";
    return;
  }

  box.innerHTML = r.map((s,i)=>{
    const proximoKm = calcularProximoKm(
      s.km,
      s.proximo_servicio_km
    );

    return `
      <div class="resultado ${i===0?"destacado":""}">
        <div class="info">
          <div class="fecha">${fechaValida(s.fecha)}</div>
          <div class="km">${s.km || "‚Äî"} km</div>

          ${i===0 ? `
            <div class="badge">√öltimo servicio</div>
            <div class="km">üîÅ Pr√≥ximo servicio: ${proximoKm} km</div>
          ` : ""}
        </div>

        <div class="link" onclick="ver('${s.id_servicio}')">
          Ver registro
        </div>
      </div>
    `;
  }).join("");
}

/* =========================
   NAVEGACI√ìN
========================= */
function ver(id){
  window.open(
    `aceite_publico.html?id=${encodeURIComponent(id)}`,
    "_blank"
  );
}

function volver(){
  window.location.href = "checklist.html";
}
</script>

</body>
</html>

